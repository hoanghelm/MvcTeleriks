@using System.Security.Policy
@model IncidentCreateViewModel
@{
    ViewData["Title"] = "Create Incident Report";
}

@section Styles {
    <link rel="stylesheet" href="~/css/telerik-controls-standardized.css" />
    <link rel="stylesheet" href="~/css/incident/incident-create.css" />
    <link rel="stylesheet" href="~/css/components/employee-search.css" />
}

<div class="p-6 max-w-7xl mx-auto">
    <div class="mb-6">
        <h1 class="text-xl font-bold text-gray-900 mb-2">Create Incident Report</h1>
        <p class="text-gray-600 text-sm">Fields marked with <span class="text-red-500 font-semibold">*</span> are required</p>
        <div class="text-blue-600 text-sm mt-2">This form is for <strong>Part A - Initial Report</strong> only</div>
    </div>

    @if (!string.IsNullOrEmpty(Model.ValidationMessage))
    {
        <div class="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 text-sm rounded">
            @Model.ValidationMessage
        </div>
    }

    <form id="createIncidentForm" method="post" action="@Url.Action("Create", "Incident")" class="space-y-6">
        <!-- Incident Details Card -->
        <div class="card overflow-hidden">
            <div class="card-header">
                <h2 class="card-title">Incident Details</h2>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Incident Date -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Incident Date <span class="text-red-500">*</span>
                        </label>
                        @(Html.Kendo().DatePicker()
                                                .Name("IncidentDate")
                                                .Value(DateTime.Today)
                                                .HtmlAttributes(new
                                                {
                                                    id = "dpIncidentDate",
                                                    required = "required"
                                                })
                                                )
                    </div>

                    <!-- Incident Time -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Incident Time <span class="text-red-500">*</span>
                        </label>
                        @(Html.Kendo().TimePicker()
                                                .Name("IncidentTime")
                                                .Value(DateTime.Now)
                                                .HtmlAttributes(new
                                                {
                                                    id = "tpIncidentTime",
                                                    required = "required"
                                                })
                                                )
                    </div>

                    <!-- SBA -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            SBA <span class="text-red-500">*</span>
                        </label>
                        @(Html.Kendo().DropDownList()
                                                .Name("SbaCode")
                                                .OptionLabel("Select SBA")
                                                .DataTextField("Value")
                                                .DataValueField("Code")
                                                .HtmlAttributes(new
                                                {
                                                    id = "ddlSbaCode",
                                                    required = "required"
                                                })
                                                .AutoBind(false)
                                                )
                    </div>

                    <!-- SBU -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            SBU <span class="text-red-500">*</span>
                        </label>
                        @(Html.Kendo().DropDownList()
                                                .Name("SbuCode")
                                                .OptionLabel("Select SBU")
                                                .DataTextField("Value")
                                                .DataValueField("Code")
                                                .HtmlAttributes(new
                                                {
                                                    id = "ddlSbuCode",
                                                    required = "required"
                                                })
                                                .AutoBind(false)
                                                )
                    </div>

                    <!-- Division -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Division
                        </label>
                        @(Html.Kendo().DropDownList()
                                                .Name("Division")
                                                .OptionLabel("Select Division")
                                                .DataTextField("Value")
                                                .DataValueField("Code")
                                                .HtmlAttributes(new { id = "ddlDivision" })
                                                .AutoBind(false)
                                                )
                    </div>

                    <!-- Department -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Department <span class="text-red-500">*</span>
                        </label>
                        @(Html.Kendo().DropDownList()
                                                .Name("Department")
                                                .OptionLabel("Select Department")
                                                .DataTextField("Value")
                                                .DataValueField("Code")
                                                .HtmlAttributes(new {
                                                    id = "ddlDepartment",
                                                    required = "required"
                                                })
                                                .AutoBind(false)
                                                )
                    </div>

                    <!-- Location -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Location <span class="text-red-500">*</span>
                        </label>
                        @(Html.Kendo().DropDownList()
                                                .Name("Location")
                                                .OptionLabel("Select Location")
                                                .DataTextField("Value")
                                                .DataValueField("Code")
                                                .HtmlAttributes(new
                                                {
                                                    id = "ddlLocation",
                                                    required = "required"
                                                })
                                                .AutoBind(false)
                                                )
                    </div>

                    <!-- Exact Location -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Exact Location <span class="text-red-500">*</span>
                        </label>
                        @(Html.Kendo().TextBox()
                                                .Name("ExactLocation")
                                                .Placeholder("Specific location details")
                                                .HtmlAttributes(new
                                                {
                                                    id = "txtExactLocation",
                                                    required = "required",
                                                    maxlength = "200"
                                                })
                                                )
                    </div>
                </div>

                <!-- Description -->
                <div class="mt-6 space-y-2">
                    <label class="block text-sm font-medium text-gray-700">
                        Description <span class="text-red-500">*</span>
                    </label>
                    @(Html.Kendo().TextArea()
                                        .Name("Description")
                                        .Placeholder("Describe what happened")
                                        .Rows(4)
                                        .HtmlAttributes(new
                                        {
                                            id = "txtDescription",
                                            required = "required",
                                            maxlength = "2000"
                                        })
                                        )
                </div>

                <!-- Incident Type -->
                <div class="mt-6 space-y-2">
                    <label class="block text-sm font-medium text-gray-700">
                        Incident Type <span class="text-red-500">*</span>
                    </label>
                    @(Html.Kendo().DropDownList()
                                        .Name("IncidentType")
                                        .OptionLabel("Select incident type...")
                                        .DataTextField("Value")
                                        .DataValueField("Code")
                                        .BindTo(Model.IncidentTypes)
                                        .HtmlAttributes(new
                                        {
                                            id = "ddlIncidentType",
                                            required = "required"
                                        })
                                        )
                </div>
            </div>
        </div>

        <!-- Superior Information Card -->
        <div class="card overflow-hidden">
            <div class="card-header">
                <h2 class="card-title">Superior Information</h2>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Superior Name -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Superior Name <span class="text-red-500">*</span>
                        </label>
                        <div class="flex gap-2">
                            @(Html.Kendo().TextBox()
                                                        .Name("SuperiorName")
                                                        .Placeholder("Enter superior name")
                                                        .HtmlAttributes(new
                                                        {
                                                            id = "txtSuperiorName",
                                                            required = "required",
                                                            @readonly = "readonly",
                                                            @class = "flex-1"
                                                        })
                                                        )
                            @(Html.Kendo().Button()
                                                        .Name("btnSearchSuperior")
                                                        .Content("Search")
                                                        .HtmlAttributes(new { @class = "btn-secondary" })
                                                        .Events(e => e.Click("function() { openEmployeeSearch('superior'); }"))
                                                        )
                        </div>
                        <input type="hidden" id="hdnSuperiorEmployeeId" name="SuperiorEmployeeId" />
                    </div>

                    <!-- Superior Department -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Department
                        </label>
                        @(Html.Kendo().TextBox()
                                                .Name("SuperiorDepartment")
                                                .Placeholder("Department will be auto-filled")
                                                .HtmlAttributes(new
                                                {
                                                    id = "txtSuperiorDepartment",
                                                    @readonly = "readonly"
                                                })
                                                )
                    </div>
                </div>
            </div>
        </div>

        <!-- Injured Person Information Card -->
        <div class="card overflow-hidden">
            <div class="card-header">
                <h2 class="card-title">Injured Person Information</h2>
            </div>
            <div class="card-body">
                <div id="injuredPersonsContainer">
                    <!-- Initial injured person form -->
                    <div class="injured-person-section" data-index="0">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-4">
                            <!-- Injured Person Name -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">
                                    Name <span class="text-red-500">*</span>
                                </label>
                                <div class="flex gap-2">
                                    @(Html.Kendo().TextBox()
                                                                        .Name("InjuredPersons[0].Name")
                                                                        .Placeholder("Enter injured person name")
                                                                        .HtmlAttributes(new
                                                                        {
                                                                            id = "txtInjuredName_0",
                                                                            required = "required",
                                                                            @readonly = "readonly",
                                                                            @class = "flex-1"
                                                                        })
                                                                        )
                                    @(Html.Kendo().Button()
                                                                        .Name("btnSearchInjured_0")
                                                                        .Content("Search")
                                                                        .HtmlAttributes(new { @class = "btn-secondary" })
                                                                        .Events(e => e.Click("function() { openEmployeeSearch('injured', 0); }"))
                                                                        )
                                </div>
                                <input type="hidden" name="InjuredPersons[0].EmployeeId" id="hdnInjuredEmployeeId_0" />
                            </div>

                            <!-- Injured Person Department -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">
                                    Department
                                </label>
                                @(Html.Kendo().TextBox()
                                                                .Name("InjuredPersons[0].Department")
                                                                .Placeholder("Department will be auto-filled")
                                                                .HtmlAttributes(new
                                                                {
                                                                    id = "txtInjuredDepartment_0",
                                                                    @readonly = "readonly"
                                                                })
                                                                )
                            </div>
                        </div>

                        <!-- Case Type -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-4">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">
                                    Case Type <span class="text-red-500">*</span>
                                </label>
                                @(Html.Kendo().DropDownList()
                                                                .Name("InjuredPersons[0].CaseType")
                                                                .OptionLabel("Select case type...")
                                                                .DataTextField("Value")
                                                                .DataValueField("Code")
                                                                .BindTo(new List<LookupItem>())
                                                                .HtmlAttributes(new
                                                                {
                                                                    id = "ddlInjuredCaseType_0",
                                                                    required = "required"
                                                                })
                                                                )
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Injured Person Button -->
                <div class="mt-4">
                    @(Html.Kendo().Button()
                                        .Name("btnAddInjuredPerson")
                                        .Content("<i class='k-icon k-i-plus'></i> Add Another Injured Person")
                                        .HtmlAttributes(new { @class = "btn-secondary" })
                                        .Events(e => e.Click("addInjuredPerson"))
                                        )
                </div>
            </div>
        </div>

        <!-- Additional Information Card -->
        <div class="card overflow-hidden">
            <div class="card-header">
                <h2 class="card-title">Additional Information</h2>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Overtime -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Overtime Status
                        </label>
                        @(Html.Kendo().DropDownList()
                                                .Name("OvertimeStatus")
                                                .OptionLabel("Select overtime status...")
                                                .DataTextField("Value")
                                                .DataValueField("Code")
                                                .BindTo(Model.OvertimeOptions ?? new List<LookupItem>())
                                                .HtmlAttributes(new { id = "ddlOvertimeStatus" })
                                                )
                    </div>

                    <!-- Job Related -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Job Related
                        </label>
                        @(Html.Kendo().DropDownList()
                                                .Name("JobRelated")
                                                .OptionLabel("Select...")
                                                .DataTextField("Value")
                                                .DataValueField("Code")
                                                .BindTo(Model.JobRelatedOptions ?? new List<LookupItem>())
                                                .HtmlAttributes(new { id = "ddlJobRelated" })
                                                )
                    </div>
                </div>

                <!-- Damage Description -->
                <div class="mt-6 space-y-2">
                    <label class="block text-sm font-medium text-gray-700">
                        Damage Description
                    </label>
                    @(Html.Kendo().TextArea()
                                        .Name("DamageDescription")
                                        .Placeholder("Describe any damages")
                                        .Rows(3)
                                        .HtmlAttributes(new
                                        {
                                            id = "txtDamageDescription",
                                            maxlength = "1000"
                                        })
                                        )
                </div>

                <!-- Hospital/Clinic Name -->
                <div class="mt-6 space-y-2">
                    <label class="block text-sm font-medium text-gray-700">
                        Examined at Hospital/Clinic
                    </label>
                    @(Html.Kendo().TextBox()
                                        .Name("ExaminedHospitalClinicName")
                                        .Placeholder("Hospital or clinic name")
                                        .HtmlAttributes(new
                                        {
                                            id = "txtExaminedHospitalClinicName",
                                            maxlength = "200"
                                        })
                                        )
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-end space-x-4">
            @(Html.Kendo().Button()
                        .Name("btnCancel")
                        .Content("Cancel")
                        .HtmlAttributes(new { @class = "btn-secondary" })
                        .Events(e => e.Click("cancelForm"))
                        )
            @(Html.Kendo().Button()
                        .Name("btnSaveDraft")
                        .Content("Save Draft")
                        .HtmlAttributes(new { @class = "btn-primary" })
                        .Events(e => e.Click("saveDraft"))
                        )
            @(Html.Kendo().Button()
                        .Name("btnSubmit")
                        .Content("Submit Report")
                        .HtmlAttributes(new { @class = "btn-success", type = "submit" })
                        )
        </div>
    </form>
</div>

@section Scripts {
    @* Include the new framework scripts *@
    @Html.Partial("_FrameworkScripts")

    @* Original scripts - can be gradually replaced *@
    <script src="~/js/incident/incident-create-viewmodel.js"></script>
    <script src="~/js/components/employee-search.js"></script>
    <script src="~/js/telerik-notifications.js"></script>

    @* Framework initialization for this page *@
    <script>
    $(document).ready(function() {
        $(document).on('framework:ready', function() {
            // Initialize incident form dropdowns using the new framework
            const factory = window.DropdownFactory;

            // Create the standard incident dropdowns
            const incidentDropdowns = factory.createStandardIncidentDropdowns(
                '#ddlSbaCode',
                '#ddlSbuCode',
                '#ddlDivision',
                '#ddlDepartment',
                '#ddlLocation',
                null // No ViewModel binding for now, keeping compatibility with existing code
            );

            // Store dropdown references globally for compatibility with existing code
            window.incidentDropdowns = incidentDropdowns;

            // Create Yes/No dropdowns that might exist on the page
            try {
                // These might not exist on all variants of the form
                if ($('#ddlAnyEyewitness').length) {
                    window.anyEyewitnessDropdown = factory.createYesNoDropdown('#ddlAnyEyewitness');
                }
                if ($('#ddlIsWorkingOvertime').length) {
                    window.isWorkingOvertimeDropdown = factory.createYesNoDropdown('#ddlIsWorkingOvertime');
                }
                if ($('#ddlIsJobrelated').length) {
                    window.isJobrelatedDropdown = factory.createYesNoDropdown('#ddlIsJobrelated');
                }
            } catch (error) {
                console.warn('Some dropdowns not found, skipping:', error);
            }

            console.log('Incident form dropdowns initialized with new framework');
        });
    });
    </script>
}
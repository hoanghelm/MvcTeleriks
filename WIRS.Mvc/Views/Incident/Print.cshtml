@{
    ViewData["Title"] = "Print Incident Report - " + (ViewBag.IncidentId ?? "");
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #525659;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 20px;
        }

        #pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
        }

        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: #323639;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .toolbar button {
            padding: 8px 16px;
            background: #0a84ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin: 0 5px;
        }

        .toolbar button:hover {
            background: #0070e0;
        }

        #content-frame {
            position: absolute;
            top: 40px;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: calc(100% - 40px);
            border: none;
            background: white;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        window.onload = function() {
            @if (!string.IsNullOrEmpty(ViewBag.HtmlContent))
            {
                @:loadContent();
            }
        };

        function loadContent() {
            var iframe = document.getElementById('content-frame');
            iframe.src = '/Incident/PrintContent?id=@ViewBag.IncidentId';
        }

        function generatePDF() {
            var iframe = document.getElementById('content-frame');
            var iframeWindow = iframe.contentWindow;
            var iframeDocument = iframe.contentDocument || iframeWindow.document;

            html2canvas(iframeDocument.body, {
                scale: 2,
                useCORS: true,
                logging: false
            }).then(function(canvas) {
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                const pdfBlob = pdf.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);

                document.getElementById('content-frame').style.display = 'none';

                var embed = document.createElement('embed');
                embed.id = 'pdf-viewer';
                embed.src = pdfUrl;
                embed.type = 'application/pdf';
                embed.width = '100%';
                embed.height = '100%';
                document.body.appendChild(embed);

                document.querySelector('.toolbar').innerHTML = '<span style="color: white; font-size: 14px;">PDF Preview - Incident Report @ViewBag.IncidentId</span>';
            });
        }

        function printDoc() {
            var iframe = document.getElementById('content-frame');
            if (iframe.style.display !== 'none') {
                iframe.contentWindow.print();
            } else {
                window.print();
            }
        }
    </script>
</head>
<body>
    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
    {
        <div class="error-message">
            @ViewBag.ErrorMessage
        </div>
    }
    else
    {
        <div class="toolbar">
            <button onclick="generatePDF()">Generate PDF Preview</button>
            <button onclick="printDoc()">Print</button>
        </div>
        <iframe id="content-frame"></iframe>
    }
</body>
</html>

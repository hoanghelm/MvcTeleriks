using System;
using System.Collections;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using WIRS.BusinessComponents;
using WIRS.CommonUtilities;
using WIRS.Entities;

namespace WIRS.Website
{
    public partial class Create_Incident_Report : System.Web.UI.Page
    {
        private readonly BasePage baseHelper = new BasePage();
        private readonly CommonFun appHelper = new CommonFun();
        private readonly string format = "dd-MMM-yyyy";
        private readonly ArrayList head_neck_torso = new ArrayList();
        private readonly ArrayList upper_limbs = new ArrayList();
        private readonly ArrayList lower_limbs = new ArrayList();
        private readonly ArrayList nature_injuried = new ArrayList();
        private readonly ArrayList incident_arr = new ArrayList();
        private UserBE userLogin = null;
        private short currenttab;
        private readonly CheckBoxList chkIncidentType = new CheckBoxList();

        protected void Page_Load(object sender, EventArgs e)
        {
            try
            {
                btnPartA.Attributes.Add("onclick", " this.disabled = true; " + ClientScript.GetPostBackEventReference(btnPartA, null) + ";");

                if (!Page.IsPostBack)
                {
                    ddlIncidentType_SelectedIndexChanged(null, null);
                    if (Request.QueryString["incident_id"] != null)
                    {
                        string incidentid = Request.QueryString["incident_id"].ToString();
                        init_incident_stage(incidentid);
                    }
                    else
                    {
                        WorkflowIncidentBE ibe = new WorkflowIncidentBE();
                        InitPartA(0, ibe, null);
                    }

                }

                HiddenIncidentControls(ddlIncidentType.SelectedValue);
            }
            catch (Exception ex)
            {
                baseHelper.PopUpClosingWindow(Page, "Error", ex.Message);
            }
        }

        protected void Page_PreRender(object sender, EventArgs e)
        {
            currenttab = Convert.ToInt16(hdncurrenttab.Value);
            baseHelper.SetActiveTab(Page, currenttab); 
        }

        protected void Page_Init(object sender, EventArgs e)
        {
            userLogin = (UserBE)AppSession.GetSession("SESSION_OBJ_USERLOGIN");
            try
            {

                pnl_PartA.Visible = false;
                pnl_PartA_1.Visible = false;
                pnl_PartA_2.Visible = false;
                pnl_PartB.Visible = false;
                pnl_PartC.Visible = false;
                pnl_PartC_1.Visible = false;
                pnl_PartC_2.Visible = false;
                pnl_PartC_3.Visible = false;
                pnl_PartC_4.Visible = false;
                pnl_PartC_5.Visible = false;
                pnl_PartC_6.Visible = false;
                pnl_PartC_7.Visible = false;
                pnl_PartD.Visible = false;
                pnl_PartE.Visible = false;
                pnl_PartF.Visible = false;
                pnl_PartG.Visible = false;
                pnl_PartH.Visible = false;

                pnl_V_PartA.Visible = false;
                pnl_V_PartB.Visible = false;
                pnl_V_PartC.Visible = false;
                pnl_V_PartD.Visible = false;
                pnl_V_PartE.Visible = false;
                pnl_V_PartF.Visible = false;
                pnl_V_PartG.Visible = false;
                pnl_V_PartH.Visible = false;
            }
            catch (Exception ex)
            {
                baseHelper.PopUpClosingWindow(Page, "Error", ex.Message);
            }
        }

        private void init_incident_stage(string incidentid)
        {
            try
            {

                btnPartA.Visible = false;
                btnPartASave.Visible = false;

                btnPartB.Visible = false;
                btnPartBClose.Visible = false;

                btnPartC.Visible = false;
                btnPartCSave.Visible = false;
                btnPartCClose.Visible = false;
                btnPartD.Visible = false;
                btnPartDReverttoPartC.Visible = false;
                btnPartE.Visible = false;
                btnPartEReverttoPartC.Visible = false;
                btnPartF.Visible = false;
                btnPartG.Visible = false;
                btnPartGReverttoPartF.Visible = false;
                btnPartH.Visible = false;
                btnPartHReverttoPartG.Visible = false;

                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                WorkflowIncidentBE incidentBE = new WorkflowIncidentBE();
                DataSet ds = new DataSet();
                incidentBE.incident_id = incidentid;
                ds = ibc.get_incident_by_id(incidentBE);
                AppSession.SetSession("SESSION_OBJ_INCIDENT", incidentBE);

                if (hdncurrenttab.Value.Equals(string.Empty) || Convert.ToInt16(hdncurrenttab.Value) <= 0)
                {
                    hdncurrenttab.Value = incidentBE.status;
                }

                DataSet vds = ibc.validate_workflowuser(incidentBE.incident_id, userLogin.UserId);
                int istatus = Convert.ToInt16(incidentBE.status);
                DataSet whshods = ibc.validate_user_to_edit_inc(incidentBE.incident_id, userLogin.UserId, string.Empty);

                if (vds.Tables[0].Rows.Count > 0)
                {
                    if (istatus < 2)
                    {

                        btnPartB.Visible = true;
                        btnPartBClose.Visible = true;

                        InitPartB(incidentid);
                        BindPartA(incidentBE, ds);
                    }
                    else if (istatus < 3)
                    {

                        btnPartC.Visible = true;

                        btnPartCSave.Visible = true;

                        InitPartC(incidentid);
                        BindPartA(incidentBE, ds);
                        BindPartB(incidentBE, ds);
                    }
                    else if (istatus < 4)
                    {

                        btnPartD.Visible = true;
                        btnPartDReverttoPartC.Visible = true;

                        BindPartC(incidentid);
                        InitPartD(incidentid);

                        BindPartA(incidentBE, ds);
                        BindPartB(incidentBE, ds);

                    }
                    else if (istatus < 5)
                    {

                        btnPartE.Visible = true;
                        btnPartEReverttoPartC.Visible = true;

                        InitPartE(incidentid);

                        BindPartA(incidentBE, ds);
                        BindPartB(incidentBE, ds);
                        BindPartC(incidentid);

                        BindPartD(incidentBE);
                    }
                    else if (istatus < 6)
                    {

                        btnPartF.Visible = true;

                        InitPartF(incidentid);

                        BindPartA(incidentBE, ds);
                        BindPartB(incidentBE, ds);
                        BindPartC(incidentid);

                        BindPartD(incidentBE);
                        BindPartE(incidentBE);
                    }
                    else if (istatus < 7)
                    {

                        btnPartG.Visible = true;
                        btnPartGReverttoPartF.Visible = true;

                        InitPartG(incidentid);

                        BindPartA(incidentBE, ds);
                        BindPartB(incidentBE, ds);
                        BindPartC(incidentid);

                        BindPartD(incidentBE);
                        BindPartE(incidentBE);
                        BindPartF(incidentBE);
                    }
                    else if (istatus < 8)
                    {

                        btnPartH.Visible = true;
                        btnPartHReverttoPartG.Visible = true;

                        InitPartH(incidentid);

                        BindPartA(incidentBE, ds);
                        BindPartB(incidentBE, ds);
                        BindPartC(incidentid);

                        BindPartD(incidentBE);
                        BindPartE(incidentBE);
                        BindPartF(incidentBE);
                        BindPartG(incidentBE);
                    }
                    else if (istatus == 8)
                    {

                        InitPartH(incidentid);

                        BindPartA(incidentBE, ds);
                        BindPartB(incidentBE, ds);
                        BindPartC(incidentid);

                        BindPartD(incidentBE);
                        BindPartE(incidentBE);
                        BindPartF(incidentBE);
                        BindPartG(incidentBE);
                    }
                    else
                    {
                        pnl_PartA.Visible = false;
                        pnl_PartA_1.Visible = false;
                        pnl_PartA_2.Visible = false;
                        pnl_PartB.Visible = false;
                        pnl_PartC.Visible = false;
                        pnl_PartC_1.Visible = false;
                        pnl_PartC_2.Visible = false;
                        pnl_PartC_3.Visible = false;
                        pnl_PartC_4.Visible = false;
                        pnl_PartC_5.Visible = false;
                        pnl_PartC_6.Visible = false;
                        pnl_PartC_7.Visible = false;
                        pnl_PartD.Visible = false;
                        pnl_PartE.Visible = false;
                        pnl_PartF.Visible = false;
                        pnl_PartG.Visible = false;
                        pnl_PartH.Visible = false;

                        pnl_V_PartA.Visible = true;
                        pnl_V_PartB.Visible = true;
                        pnl_V_PartC.Visible = true;
                        pnl_V_PartD.Visible = true;
                        pnl_V_PartE.Visible = true;
                        pnl_V_PartF.Visible = true;
                        pnl_V_PartG.Visible = true;
                        pnl_V_PartH.Visible = true;
                    }
                }
                else if (istatus >= 1 && istatus <= 8 && whshods.Tables[0].Rows.Count >= 1)
                {
                    btnPartASave.Visible = true;
                    btnPartA.Visible = false;
                    InitPartA(istatus, incidentBE, ds);
                    BindPartB(incidentBE, ds);
                    btnPartCSave.Visible = true;
                    InitPartC(incidentid);
                    BindPartD(incidentBE);
                    BindPartE(incidentBE);
                    BindPartF(incidentBE);
                    if (istatus < 7)
                    {
                        btnPartG.Visible = true;
                        btnPartGReverttoPartF.Visible = true;
                        InitPartG(incidentid);
                    }
                    else
                    {
                        BindPartG(incidentBE);
                    }
                }

                else
                {
                    BindPartA(incidentBE, ds);
                    BindPartB(incidentBE, ds);
                    BindPartC(incidentid);

                    BindPartD(incidentBE);
                    BindPartE(incidentBE);
                    BindPartF(incidentBE);
                    BindPartG(incidentBE);
                    BindPartH(incidentBE);
                }

                DataSet wfds = ibc.get_wirs_incidents_workflows_by_id(incidentBE.incident_id, string.Empty);
                if (wfds.Tables[0].Rows.Count > 0)
                {
                    gv_overall_workflow.Visible = true;
                    gv_overall_workflow.DataSource = wfds.Tables[0];
                    gv_overall_workflow.DataBind();
                }
                else
                {
                    gv_overall_workflow.Visible = false;
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(Page, "Error", ex.Message);
            }
        }

        protected void ddlsba_SelectedIndexChanged(object sender, EventArgs e)
        {
            string sba_code = ddlsba.SelectedValue;
            appHelper.Setup_all_sbus(ddlSbu, sba_code);
            ddlSbu_SelectedIndexChanged(null, null);
        }

        protected void ddlSbu_SelectedIndexChanged(object sender, EventArgs e)
        {
            string sba_code = ddlsba.SelectedValue;
            DataSet ds_department;
            string sbu_code = ddlSbu.SelectedValue;
            ds_department = appHelper.get_active_departments(string.Empty, sba_code, sbu_code);

            DataRow row = ds_department.Tables[0].NewRow();
            row[0] = "";
            row[1] = "--Select--";
            ds_department.Tables[0].Rows.InsertAt(row, 0);

            ddlDepartment.DataSource = ds_department;
            ddlDepartment.DataTextField = "department_name";
            ddlDepartment.DataValueField = "department_code";
            ddlDepartment.DataBind();

            ddlDepartment_SelectedIndexChanged(null, null);

        }

        protected void ddlDepartment_SelectedIndexChanged(object sender, EventArgs e)
        {
            string sba_code = ddlsba.SelectedValue;
            DataSet ds_location;
            string sbu_code = ddlSbu.SelectedValue;
            string department_code = ddlDepartment.SelectedValue;
            ds_location = appHelper.get_active_locations(sba_code, sbu_code, department_code);
            DataRow row = ds_location.Tables[0].NewRow();
            row[0] = "";
            row[1] = "--Select--";
            ds_location.Tables[0].Rows.InsertAt(row, 0);

            ddlLocation.Items.Clear();
            ddlLocation.DataSource = ds_location;
            ddlLocation.DataTextField = "location_name";
            ddlLocation.DataValueField = "location_code";
            ddlLocation.DataBind();

            string location_code = string.Empty;

            UserBC userBC = new UserBC();
            DataSet wshods = userBC.get_wsho_by_sbu(sba_code, sbu_code, department_code, location_code);
            DataSet hodds = userBC.get_hod_by_sbu(sba_code, sbu_code, department_code, location_code);
            DataSet ahodds = userBC.get_ahod_by_sbu(sba_code, sbu_code, department_code, location_code);
            DataSet parta_copytods = userBC.get_partA_cclist_by_sbu(sba_code, sbu_code, department_code, location_code);

            appHelper.BindCodeToListControl(ddlPartA_HODID, hodds, "empname", "empid", string.Empty);
            appHelper.BindCodeToListControl(ddlPartA_AHOD, ahodds, "empname", "empid", string.Empty);
            appHelper.BindCodeToListControl(ddlPartA_WSHOID, wshods, "empname", "empid", string.Empty);

            appHelper.BindCheckBoxList(chkPartACopyTo, parta_copytods, "empname", "empid");
            foreach (ListItem li in chkPartACopyTo.Items)
            {
                li.Selected = true;
            }

            ddlLocation_SelectedIndexChanged(null, null);
        }

        protected void ddlLocation_SelectedIndexChanged(object sender, EventArgs e)
        {
            string sba_code, sbu_code, department_code, location_code;
            sba_code = ddlsba.SelectedValue;
            sbu_code = ddlSbu.SelectedValue;
            department_code = ddlDepartment.SelectedValue;
            location_code = ddlLocation.SelectedValue;
        }

        private void ClearCheckboxlist(CheckBoxList chklist)
        {
            foreach (ListItem li in chklist.Items)
            {
                if (li.Selected == true)
                {
                    li.Selected = false;
                }
            }
        }

        private void workflowdataBind(DataTable dt, GridView gv, Label l1, Label l2, Label l3, Label l4)
        {
            if (dt.Rows.Count > 0)
            {
                appHelper.SetupNameofSubmission(l1, l2, l3, l4, dt);

                gv.DataSource = dt;
                gv.DataBind();
            }
        }

        private void setworkflow_data(string incident_id, string status, string actions_role, string to, string remarks)
        {
            try
            {
                string errorCode = string.Empty;

                DataSet wf_ds = new DataSet(); 

                DataTable wfdt = new DataTable
                {
                    TableName = "incidents_workflows"
                };
                wfdt.Columns.Add(new DataColumn("incident_id", typeof(string)));
                wfdt.Columns.Add(new DataColumn("actions_code", typeof(string)));
                wfdt.Columns.Add(new DataColumn("actions_role", typeof(string)));
                wfdt.Columns.Add(new DataColumn("from", typeof(string)));
                wfdt.Columns.Add(new DataColumn("to", typeof(string)));
                wfdt.Columns.Add(new DataColumn("remarks", typeof(string)));
                wfdt.Columns.Add(new DataColumn("Date", typeof(string)));
                wfdt.Columns.Add(new DataColumn("attachment", typeof(string)));

                wf_ds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");
                if (wf_ds != null && wf_ds.Tables[0].Rows.Count > 0)
                {
                    wfdt = wf_ds.Tables[0];
                }
                else
                {
                    wf_ds = new DataSet();
                }

                DataRow wfrow = wfdt.NewRow();
                wfrow["incident_id"] = incident_id;
                wfrow["actions_code"] = status;
                wfrow["actions_role"] = actions_role;
                wfrow["from"] = userLogin.UserId;
                wfrow["to"] = to;
                wfrow["remarks"] = remarks;
                wfrow["Date"] = string.Empty;
                wfrow["attachment"] = string.Empty;
                wfdt.Rows.Add(wfrow);

                wf_ds.Tables.Clear();
                wf_ds.Tables.Add(wfdt);
                AppSession.SetSession("SESSION_LIST_WORKFLOWS", wf_ds);
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(Page, "Error", ex.Message);
            }
        }

        private void save_workflow_to(string incident_id, out string errorCode)
        {
            errorCode = string.Empty;
            CommonFun appHelper = new CommonFun();
            string returnValue = string.Empty;
            string error_Code = string.Empty;
            try
            {
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                WorkflowIncidentBE incidentBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                DataSet wf_ds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");
                ibc.insert_incidents_workflows(incident_id, wf_ds, out error_Code);

            }
            catch (Exception ex)
            {

                errorCode = ex.Message;
            }
        }

        private void set_attach_docs(string sessionkey, string incident_id, string attachment_type, string reference_code
            , string file_id, string file_name, string file_path, string file_extension, string file_desc, string remarks
            , ListView lv)
        {
            DataSet ds = new DataSet();

            DataTable attachDT = new DataTable
            {
                TableName = "incidents_attachment"
            };
            attachDT.Columns.Add(new DataColumn("uid", typeof(string)));
            attachDT.Columns.Add(new DataColumn("incident_id", typeof(string)));
            attachDT.Columns.Add(new DataColumn("attachment_type", typeof(string)));
            attachDT.Columns.Add(new DataColumn("reference_code", typeof(string)));
            attachDT.Columns.Add(new DataColumn("file_id", typeof(string)));
            attachDT.Columns.Add(new DataColumn("file_name", typeof(string)));
            attachDT.Columns.Add(new DataColumn("file_path", typeof(string)));
            attachDT.Columns.Add(new DataColumn("file_extension", typeof(string)));
            attachDT.Columns.Add(new DataColumn("file_desc", typeof(string)));
            attachDT.Columns.Add(new DataColumn("remarks", typeof(string)));

            ds = (DataSet)AppSession.GetSession(sessionkey);

            if (ds != null && ds.Tables[0].Rows.Count > 0)
            {
                Session.Remove(sessionkey);
                attachDT = ds.Tables[0];
            }
            DataRow row = attachDT.NewRow();
            row["incident_id"] = incident_id;
            row["attachment_type"] = attachment_type;
            row["reference_code"] = reference_code;
            row["file_id"] = file_id;
            row["file_name"] = file_name;
            row["file_path"] = file_path;
            row["file_extension"] = file_extension;
            row["file_desc"] = file_desc;
            row["remarks"] = remarks;
            attachDT.Rows.Add(row);

            ds.Tables.Clear();
            ds.Tables.Add(attachDT);
            AppSession.SetSession(sessionkey, ds);

            if (lv != null)
            {
                lv.DataSource = ds;
                lv.DataBind();
            }
        }

        private void SendEmailNotification(WorkflowIncidentBE incidents, string aFrom, string aTo, DataTable dt, string strRemarks, out string errorCodeO)
        {

            WorkflowIncidentBC ibc = new WorkflowIncidentBC();
            DataSet ds = ibc.get_sendemaildata_by_id(incidents.incident_id, aFrom, aTo);

            string subject = string.Empty;
            string stremailHeader = string.Empty;
            string strcommentslabel = string.Empty;
            string sunburst_link = string.Empty;
            string strinjured_person_info = string.Empty;

            if (ds != null && ds.Tables[0] != null && ds.Tables[0].Rows.Count > 0)
            {  

                if (ds.Tables[0].Rows[0]["emailsubject"].ToString() != string.Empty)
                {
                    subject = ds.Tables[0].Rows[0]["emailsubject"].ToString();
                }
                else
                {
                    subject = "-";
                }

                if (ds.Tables[0].Rows[0]["emailheader"].ToString() != string.Empty)
                {
                    stremailHeader = ds.Tables[0].Rows[0]["emailheader"].ToString();
                }
                else
                {
                    stremailHeader = "-";
                }

                if (ds.Tables[0].Rows[0]["commentslabel"].ToString() != string.Empty)
                {
                    strcommentslabel = ds.Tables[0].Rows[0]["commentslabel"].ToString();
                }

                if (ds.Tables[0].Rows[0]["email_link"].ToString() != string.Empty)
                {
                    sunburst_link = ds.Tables[0].Rows[0]["email_link"].ToString();
                }
                else
                {
                    sunburst_link = ConfigurationManager.AppSettings["Login_Link"].ToString();
                }

                if (ds.Tables[0].Rows[0]["injured_person_info"].ToString() != string.Empty)
                {
                    strinjured_person_info = ds.Tables[0].Rows[0]["injured_person_info"].ToString();
                }
            }

            errorCodeO = string.Empty;
            string errorCode = string.Empty;
            string emailto = string.Empty;
            string emailtorole = string.Empty;
            string encryptedIncId = string.Empty;
            string encryptedHODId = string.Empty;
            string encryptedStatus = string.Empty;
            string encryptedModifyDate = string.Empty;
            string IncidentDateTime = string.Empty;
            string SubmittedDateTime = string.Empty;

            DataSet CC = new DataSet();
            CommonFun appHelper = new CommonFun();
            try
            {
                if (incidents != null)
                {
                    string passwordHash = ConfigurationManager.AppSettings["PasswordHash"].ToString();
                    string saltKey = ConfigurationManager.AppSettings["SaltKey"].ToString();
                    string viKey = ConfigurationManager.AppSettings["VIKey"].ToString();

                    encryptedIncId = appHelper.Encrypt(incidents.incident_id, passwordHash, saltKey, viKey);

                    if (dt.Rows.Count > 0)
                    {
                        for (int i = 0; i < dt.Rows.Count; i++)
                        {
                            string strTo = dt.Rows[i]["to"].ToString();
                            string stractions_role = dt.Rows[i]["actions_role"].ToString();

                            encryptedHODId = appHelper.Encrypt(strTo, passwordHash, saltKey, viKey);
                            encryptedStatus = appHelper.Encrypt(incidents.status, passwordHash, saltKey, viKey);
                            encryptedModifyDate = appHelper.Encrypt(Convert.ToDateTime(incidents.modify_date).ToString("yyyy-MM-dd HH:mm:ss"), passwordHash, saltKey, viKey);

                            string _url = "inc_id =" + incidents.incident_id + "|user_id=" + strTo + "|status_code=" + incidents.status + "|modify_date=" + incidents.modify_date;
                            string encryptedpage = appHelper.Encrypt(_url, passwordHash, saltKey, viKey);

                            string emailFrom = ConfigurationManager.AppSettings["MailFrom"].ToString();

                            string emailTemplateLink = ConfigurationManager.AppSettings["TemplateLink"].ToString();

                            string loginLink = ConfigurationManager.AppSettings["Login_Link"].ToString();

                            EmployeeBE empBE = new EmployeeBE
                            {
                                EmpID = strTo
                            };
                            EmployeeBC empBC = new EmployeeBC();
                            empBC.GetEmployeeEmailAddress(empBE, out emailto, out emailtorole, out errorCode);

                            if (!string.IsNullOrEmpty(emailto))
                            {
                                string body = CommonFun.GetHtmlContent(emailTemplateLink + "IncidentSubmitted.htm");
                                body = body.Replace("[emailheader]", stremailHeader);
                                body = body.Replace("[incidentid]", incidents.incident_id);
                                body = body.Replace("[inctype]", appHelper.GetIncidentTypeListByID(incidents.incident_id));
                                body = body.Replace("[datetime]", incidents.incident_datetime); 
                                body = body.Replace("[USERNAME]", incidents.superior_name);
                                body = body.Replace("[sbu]", incidents.sbu_name);
                                body = body.Replace("[department]", incidents.department_name);
                                body = body.Replace("[location]", incidents.location_name);
                                body = body.Replace("[incDesc]", incidents.incident_desc);
                                body = body.Replace("[Designation]", incidents.superior_designation);

                                body = body.Replace("[creatorname]", incidents.superior_name);
                                body = body.Replace("[submittedon]", incidents.creation_date);
                                body = body.Replace("[Remarks]", strRemarks);
                                body = body.Replace("[Comments]", strcommentslabel);
                                body = body.Replace("[injured_person_info]", strinjured_person_info);
                                body = body.Replace("[LINK]", loginLink);

                                appHelper.SendToMailMessage(emailFrom, emailto, subject, body, true, System.Net.Mail.MailPriority.Normal, out errorCode);
                                errorCodeO = errorCode;
                            }
                        } 
                    }
                }
            }
            catch (Exception ex)
            {

                errorCodeO = "ERR-111";
            }
        }

        public void save_attachfiles(string sessionkey, ListView lv, out string errorCode)
        {
            errorCode = string.Empty;
            CommonFun appHelper = new CommonFun();
            try
            {
                DataSet ds = new DataSet();

                ds = (DataSet)AppSession.GetSession(sessionkey);
                int totalfiles = 0;
                if (ds != null && ds.Tables[0].Rows.Count > 0)
                {

                    totalfiles = ds.Tables[0].Rows.Count;
                    if (lv != null && lv.Items.Count == totalfiles)
                    {

                        for (int i = 0; i < lv.Items.Count; i++)
                        {

                            string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                            ListViewDataItem li = lv.Items[i];
                            LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");
                            string filename = lnkatt.Text;
                            string filepath = Server.MapPath(tempFolderPath + filename);

                            string FolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                            string path = HttpContext.Current.Server.MapPath(FolderPath + lnkatt.Text);
                            System.IO.FileInfo file = new System.IO.FileInfo(path);

                            if (File.Exists(filepath))
                            {
                                File.Copy(filepath, path, true);
                                if (File.Exists(path))
                                {
                                    File.Delete(filepath);
                                }
                                else
                                {
                                    errorCode = "Missing path " + path;
                                }
                            }
                        }

                        WorkflowIncidentBC iBC = new WorkflowIncidentBC();
                        iBC.insert_incidents_attachfiles(ds, userLogin.UserId, out errorCode);

                        Session.Remove(sessionkey);
                    }
                }
            }
            catch (Exception ex)
            {

                errorCode = ex.Message;
            }
        }

        protected void lnkTempAttach_Click(object sender, EventArgs e)
        {
            try
            {
                LinkButton lf = (LinkButton)sender;
                string filename = lf.Text;

                FileUploadBE upload = new FileUploadBE();
                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);

                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string Pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {

                    string passwordHash = ConfigurationManager.AppSettings["PasswordHash"].ToString();
                    string saltKey = ConfigurationManager.AppSettings["SaltKey"].ToString();
                    string viKey = ConfigurationManager.AppSettings["VIKey"].ToString();

                    string url = "FilePreview.aspx?" + "file=" + appHelper.Encrypt(filename, passwordHash, saltKey, viKey) + "&directory=" + appHelper.Encrypt(tempFolderPath, passwordHash, saltKey, viKey);

                    ScriptManager.RegisterStartupScript(this, typeof(string), "OPEN_WINDOW", "var Mleft = (screen.width/2)-(760/2);var Mtop = (screen.height/2)-(700/2);window.open( '" + url + "', null, 'height=700,width=760,status=yes,toolbar=no,scrollbars=yes,menubar=no,location=no,top=\'+Mtop+\', left=\'+Mleft+\'' );", true);
                }
                else if (File.Exists(Pfilepath))
                {

                    string passwordHash = ConfigurationManager.AppSettings["PasswordHash"].ToString();
                    string saltKey = ConfigurationManager.AppSettings["SaltKey"].ToString();
                    string viKey = ConfigurationManager.AppSettings["VIKey"].ToString();

                    string url = "FilePreview.aspx?" + "file=" + appHelper.Encrypt(filename, passwordHash, saltKey, viKey) + "&directory=" + appHelper.Encrypt(PFolderPath, passwordHash, saltKey, viKey);

                    ScriptManager.RegisterStartupScript(this, typeof(string), "OPEN_WINDOW", "var Mleft = (screen.width/2)-(760/2);var Mtop = (screen.height/2)-(700/2);window.open( '" + url + "', null, 'height=700,width=760,status=yes,toolbar=no,scrollbars=yes,menubar=no,location=no,top=\'+Mtop+\', left=\'+Mleft+\'' );", true);
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(Page, "Error", ex.Message);
            }
        }

        private void attachmentdataBind(DataTable dt, ListView lv, string sessionkey)
        {
            try
            {
                if (dt != null && dt.Rows.Count > 0)
                {
                    DataSet ds = new DataSet();
                    ds.Clear();
                    ds.Tables.Add(dt.Copy());
                    AppSession.SetSession(sessionkey, ds);

                    lv.DataSource = dt;
                    lv.DataBind();
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(Page, "Error", ex.Message);
            }
        }

        protected void attach_files_Click(object sender, EventArgs e)
        {
            try
            {
                LinkButton lf = (LinkButton)sender;
                string filename = lf.Text;

                FileUploadBE upload = new FileUploadBE();
                string FolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(FolderPath + filename);
                if (File.Exists(filepath))
                {

                    string passwordHash = ConfigurationManager.AppSettings["PasswordHash"].ToString();
                    string saltKey = ConfigurationManager.AppSettings["SaltKey"].ToString();
                    string viKey = ConfigurationManager.AppSettings["VIKey"].ToString();

                    string url = "FilePreview.aspx?" + "file=" + appHelper.Encrypt(filename, passwordHash, saltKey, viKey) + "&directory=" + appHelper.Encrypt(FolderPath, passwordHash, saltKey, viKey);

                    ScriptManager.RegisterStartupScript(this, typeof(string), "OPEN_WINDOW", "var Mleft = (screen.width/2)-(760/2);var Mtop = (screen.height/2)-(700/2);window.open( '" + url + "', null, 'height=700,width=760,status=yes,toolbar=no,scrollbars=yes,menubar=no,location=no,top=\'+Mtop+\', left=\'+Mleft+\'' );", true);
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(Page, "Error", ex.Message);
            }
        }

        #region PartA

        private void InitPartA(int istatus, WorkflowIncidentBE incidentBE, DataSet ds)
        {
            pnl_PartA.Visible = true;
            pnl_PartA_1.Visible = true;
            pnl_PartA_2.Visible = true;

            btnPartASave.Visible = false;

            appHelper.SetupLookUpDDList(ddlIncidentType, "Incident Type");

            if (istatus <= 8 && istatus >= 1)
            {
                btnPartASave.Visible = true;
                lble_incident_id.Visible = true;
                lble_incident_id.Text = string.Empty;
                lble_incident_label.Visible = true;

                lble_incident_id.Text = incidentBE.incident_id;

                chkIncidentType.DataSource = ds.Tables[1];
                chkIncidentType.DataTextField = "lookup_value";
                chkIncidentType.DataValueField = "lookup_code";
                chkIncidentType.DataBind();

                for (int i = 0; i < ds.Tables[1].Rows.Count; i++)
                {
                    if (ds.Tables[1].Rows[i]["lookup_code"].ToString().Equals(chkIncidentType.Items[i].Value))
                    {
                        chkIncidentType.Items[i].Selected = true;
                    }
                }

                ddlIncidentType.SelectedValue = chkIncidentType.SelectedValue;

                appHelper.SetupLookUpDDList(ddlsba, "SBA", "--Select--");
                ddlsba.SelectedValue = incidentBE.sba_code;
                appHelper.Setup_all_sbus(ddlSbu, ddlsba.SelectedValue);
                ddlSbu.SelectedValue = incidentBE.sbu_code;

                if (incidentBE.sbu_code != "" && incidentBE.sbu_code != null && ddlSbu.SelectedValue == "") 
                {
                    AddItemIntoDropDownList(ddlSbu, incidentBE.sbu_name, incidentBE.sbu_code);
                    ddlSbu.SelectedValue = incidentBE.sbu_code;
                }

                ddlSbu_SelectedIndexChanged(null, null);

                currenttab = Convert.ToInt16(hdncurrenttab.Value);
                baseHelper.SetActiveTab(Page, currenttab); 

                ddlDepartment.SelectedValue = incidentBE.department;

                if (incidentBE.department != "" && incidentBE.department != null && ddlDepartment.SelectedValue == "") 
                {
                    AddItemIntoDropDownList(ddlDepartment, incidentBE.department_name, incidentBE.department);
                    ddlDepartment.SelectedValue = incidentBE.department;
                }

                ddlLocation.SelectedValue = incidentBE.location;

                if (incidentBE.location != "" && incidentBE.location != null && ddlLocation.SelectedValue == "") 
                {
                    AddItemIntoDropDownList(ddlLocation, incidentBE.location_name, incidentBE.location);
                    ddlLocation.SelectedValue = incidentBE.location;
                }

                txtLocation.Text = incidentBE.exact_location;

                ddlPartA_HODID.SelectedValue = incidentBE.hod_id;

                if (incidentBE.hod_id != "" && incidentBE.hod_id != null && ddlPartA_HODID.SelectedValue != incidentBE.hod_id) 
                {
                    DataSet dsUserInfo = GetUserInfoByUserID(incidentBE.hod_id); 
                    AddItemIntoDropDownList(ddlPartA_HODID, dsUserInfo.Tables[0].Rows[0]["UserIDName"].ToString(), incidentBE.hod_id);
                    ddlPartA_HODID.SelectedValue = incidentBE.hod_id;
                }

                ddlPartA_AHOD.SelectedValue = incidentBE.ahod_id;

                if (incidentBE.ahod_id != "" && incidentBE.ahod_id != null && ddlPartA_AHOD.SelectedValue != incidentBE.ahod_id) 
                {
                    DataSet dsUserInfo = GetUserInfoByUserID(incidentBE.ahod_id); 
                    AddItemIntoDropDownList(ddlPartA_AHOD, dsUserInfo.Tables[0].Rows[0]["UserIDName"].ToString(), incidentBE.ahod_id);
                    ddlPartA_AHOD.SelectedValue = incidentBE.ahod_id;
                }

                ddlPartA_WSHOID.SelectedValue = incidentBE.wsho_id;

                if (incidentBE.wsho_id != "" && incidentBE.wsho_id != null && ddlPartA_WSHOID.SelectedValue != incidentBE.wsho_id) 
                {
                    DataSet dsUserInfo = GetUserInfoByUserID(incidentBE.wsho_id); 
                    AddItemIntoDropDownList(ddlPartA_WSHOID, dsUserInfo.Tables[0].Rows[0]["UserIDName"].ToString(), incidentBE.wsho_id);
                    ddlPartA_WSHOID.SelectedValue = incidentBE.wsho_id;
                }

                lblvincident_id.Text = incidentBE.incident_id;
                txtIncDescription.Text = incidentBE.incident_desc;
                txtIncDate.Text = incidentBE.incident_date;
                txtIncTime.Text = incidentBE.incident_time;

                txtIncDescription_2.Text = incidentBE.damage_description;
                if (incidentBE.is_jobrelated != null)
                {
                    if (incidentBE.is_jobrelated == "Yes")
                    {
                        rdois_job_related.SelectedValue = "1";
                    }
                    else
                    {
                        rdois_job_related.SelectedValue = "0";
                    }
                }
                txtisworkingovertime.Text = incidentBE.is_working_overtime;
                rdois_job_related.SelectedValue = incidentBE.is_jobrelated;
                txthospital_name.Text = incidentBE.examined_hospital_clinic_name;
                txtoffical_work_hrs.Text = incidentBE.official_working_hrs;
                rdoHasEyeWitness.SelectedValue = incidentBE.any_eyewitness.ToString();

                lstViewInjuredPerson.DataSource = ds.Tables[2];
                lstViewInjuredPerson.DataBind();
                DataSet ipds = new DataSet();
                ipds.Tables.Clear();
                ipds.Tables.Add(ds.Tables[2].Copy());
                AppSession.SetSession("SESSION_LIST_InjuredPerson", ipds);

                if (incidentBE.any_eyewitness == 1)
                {
                    rdoHasEyeWitness_SelectedIndexChanged(null, null);
                    lstViewPartC_EyeWitnesses.DataSource = ds.Tables[3];
                    lstViewPartC_EyeWitnesses.DataBind();

                }

                DataSet ewds = new DataSet();
                DataTable ewDT = new DataTable
                {
                    TableName = "EyeWitnesses"
                };
                ewDT.Columns.Add(new DataColumn("empid", typeof(string)));
                ewDT.Columns.Add(new DataColumn("empname", typeof(string)));
                ewDT.Columns.Add(new DataColumn("empdesignation", typeof(string)));
                ewDT.Columns.Add(new DataColumn("empcontactno", typeof(string)));

                if (ds.Tables[3].Rows.Count > 0)
                {
                    ewDT = ds.Tables[3];
                }

                ewds.Tables.Clear();
                ewds.Tables.Add(ewDT.Copy());
                AppSession.SetSession("SESSION_LIST_PartC_EyeWitnesses", ewds);

                WorkflowIncidentBC iBC = new WorkflowIncidentBC();
                DataSet wfds = iBC.get_wirs_incidents_workflows_by_id(incidentBE.incident_id, "01");
                workflowdataBind(wfds.Tables[0], gv_parta_workflow, lblRepoter, lblReporterID, lblPartASubmittionDate, lblRepoterDesignation);
            }
            else
            {
                appHelper.SetupLookUpCheckboxlist(chkIncidentType, "Incident Type");
                chkIncidentType.SelectedValue = "1";

                appHelper.SetupLookUpDDList(ddlsba, "SBA", "--Select--");
                ddlsba.SelectedValue = userLogin.sbaname;
                appHelper.Setup_all_sbus(ddlSbu, ddlsba.SelectedValue);
                ddlSbu_SelectedIndexChanged(null, null);

                ds = new DataSet();
                DataSet hodds = new DataSet();
                DataSet wshods = new DataSet();
                DataSet ahodds = new DataSet();
                DataSet copytods = new DataSet();

                UserBC userBC = new UserBC();
                string sba_code, sbu_code;
                ds = userBC.GetEmployeeInfoByEmployeeNo(userLogin.UserId);

                lblRepoter.Text = ds.Tables[0].Rows[0]["empname"].ToString();
                lblReporterID.Text = userLogin.UserId;
                lblRepoterDesignation.Text = ds.Tables[0].Rows[0]["empdesignation"].ToString();
                lblPartASubmittionDate.Text = DateTime.Now.ToString("dd-MMM-yyyy");
                sba_code = ds.Tables[0].Rows[0]["sba_code"].ToString();
                sbu_code = ds.Tables[0].Rows[0]["sbu_code"].ToString();

                string department_code, location_code;
                department_code = ddlDepartment.SelectedValue;
                location_code = ddlLocation.SelectedValue;
                wshods = userBC.get_wsho_by_sbu(sba_code, sbu_code, department_code, location_code);
                hodds = userBC.get_hod_by_sbu(sba_code, sbu_code, department_code, location_code);
                ahodds = userBC.get_ahod_by_sbu(sba_code, sbu_code, department_code, location_code);

                copytods = userBC.get_partA_cclist_by_sbu(sba_code, sbu_code, department_code, location_code);

                appHelper.BindCodeToListControl(ddlPartA_HODID, hodds, "empname", "empid", string.Empty);
                appHelper.BindCodeToListControl(ddlPartA_AHOD, ahodds, "empname", "empid", string.Empty);
                appHelper.BindCodeToListControl(ddlPartA_WSHOID, wshods, "empname", "empid", string.Empty);

                appHelper.BindCheckBoxList(chkPartACopyTo, copytods, "empname", "empid");
                foreach (ListItem li in chkPartACopyTo.Items)
                {
                    li.Selected = true;
                }
            }
        }

        protected void AddItemIntoDropDownList(ListControl dropDownListName, string text, string value)
        {
            ListItem li = new ListItem
            {
                Text = text,
                Value = value
            };

            dropDownListName.Items.Add(li);
        }

        protected DataSet GetUserInfoByUserID(string userID)
        {
            DataSet dsUserInfo = appHelper.get_UserInfo_by_userID(userID);
            return dsUserInfo;
        }

        protected void gv_injured_person_RowCommand(object sender, GridViewCommandEventArgs e)
        {
            try
            {
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                WorkflowIncidentBE ibe = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                if (e.CommandName == "ShowDetails")
                {

                    int index = Convert.ToInt32(e.CommandArgument);

                    GridViewRow row = gv_injured_person.Rows[index];
                    Label lblinjured_emp_no = (Label)row.FindControl("lblinjured_emp_no");
                    string emp_no = lblinjured_emp_no.Text;
                    LinkButton lbtnOpen = (LinkButton)row.FindControl("lbtnOpen");
                    if (!string.IsNullOrEmpty(emp_no) && !ibe.status.Equals("02"))
                    {
                        DataSet idecds = new DataSet();
                        idecds.Tables.Clear();
                        idecds = ibc.get_injured_person_injury_description(ibe.incident_id, emp_no);

                        if (idecds.Tables[0].Rows.Count > 0)
                        {

                            string passwordHash = ConfigurationManager.AppSettings["PasswordHash"].ToString();

                            string saltKey = ConfigurationManager.AppSettings["SaltKey"].ToString();
                            string viKey = ConfigurationManager.AppSettings["VIKey"].ToString();

                            lbtnOpen.Visible = true;
                            string url = "ViewInjuredPersonDetails.aspx?incident_id=" + appHelper.Encrypt(ibe.incident_id, passwordHash, saltKey, viKey) + "&ijpname=" + appHelper.Encrypt(emp_no, passwordHash, saltKey, viKey);

                            ScriptManager.RegisterStartupScript(this, typeof(string), "OPEN_WINDOW", "var Mleft = (screen.width/2)-(760/2);var Mtop = (screen.height/2)-(700/2);window.open( '" + url + "', null, 'height=700,width=960,status=yes,toolbar=no,scrollbars=yes,menubar=no,location=no,top=\'+Mtop+\', left=\'+Mleft+\'' );", true);
                        }
                    }
                    else
                    {
                        lbtnOpen.Visible = false;
                    }
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(gv_injured_person, "Error", ex.Message);
            }
        }

        protected void rdoInjuredType_SelectedIndexChanged(object sender, EventArgs e)
        {
            hdncurrenttab.Value = "0";
            txtInjured_Name.Text = string.Empty;
            txtInjured_EmployeeNo.Text = string.Empty;

            lblEmployeeName.Text = "Name";
            lblEmployeeNo.Text = "Employee Number";
            lblRace.Text = "Race";
            lblGender.Text = "Gender";
            lblContactNumber.Text = "Contact Number";
            lblAge.Text = "Age";
            lblNationlity.Text = "Nationality";
            lblEmploymentType.Text = "Employment Type";
            lblDateofEmployment.Text = "Date of Employment(dd-MMM-yyyy)";

            if (rdoInjuredType.SelectedValue.Equals("I"))
            {
                btnsinjuredperson.Visible = true;

                txtInjured_Company.Visible = false;
                txtInjured_EmploymentType.Visible = true;
                txtInjured_DateofEmployment.Visible = true;

            }
            else
            {
                lblEmployeeNo.Text = "NRIC/Passport/Fin Number";
                lblAge.Text = "Company";

                btnsinjuredperson.Visible = false;

                txtInjured_Company.Visible = true;
                txtInjured_EmploymentType.Visible = true;
                txtInjured_DateofEmployment.Visible = true;

            }
        }

        protected void chkIncidentType_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                bool isOther = false;
                foreach (ListItem li in chkIncidentType.Items)
                {
                    if (li.Selected)
                    {
                        if (li.Value == "9")
                        {
                            isOther = true;
                        }
                        incident_arr.Add(li.Value);
                    }
                }
                if (isOther == true)
                {
                    txtIncidentOth.Enabled = true;
                    lblManInciOth.Visible = true;
                }
                else
                {
                    txtIncidentOth.Text = "";
                    txtIncidentOth.Enabled = false;
                    lblManInciOth.Visible = false;
                }

                ViewState["incident_arr"] = incident_arr;
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(chkIncidentType, "Error", ex.Message);
            }
        }

        protected void btnAddPartAInjured_Click(object sender, EventArgs e)
        {
            InsertInjuredPersonChanges();
            hdncurrenttab.Value = "0";

        }

        private void InsertInjuredPersonChanges()
        {
            bool errorFlag = false;
            string errorCode = string.Empty;
            string strRace = string.Empty;
            string strNationality = string.Empty;
            string strinjured_id = string.Empty;

            strRace = txtInjured_Race.Text;
            strNationality = txtInjured_Nationlity.Text;
            Dictionary<string, string> colItems = new Dictionary<string, string>()
                    {
                        {"InjuredPerson_name", txtInjured_Name.Text},
                        {"InjuredPerson_EmpNo", txtInjured_EmployeeNo.Text},
                        {"InjuredPerson_NRIC", strinjured_id},
                        {"InjuredPerson_Race", strRace},
                        {"InjuredPerson_Gender",  txtInjured_Gender.Text},
                        {"InjuredPerson_ContactNo", txtInjured_ContactNo.Text},

                        {"InjuredPerson_Age", hdnInjured_Age.Value},
                        {"InjuredPerson_Nationality", strNationality},
                        {"InjuredPerson_EmploymentType", txtInjured_EmploymentType.Text},
                        {"InjuredPerson_DateofEmployment", txtInjured_DateofEmployment.Text},
                        {"InjuredPerson_Designation", txtInjured_empdesignation.Text},
                        {"InjuredPerson_Company", txtInjured_Company.Text},
                     };

            if (string.IsNullOrEmpty(txtInjured_Name.Text) && errorFlag.Equals(false))
            {
                errorFlag = true;
                errorCode = "ERR-014";
                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtInjured_Name.ClientID);
            }
            if (rdoInjuredType.SelectedValue.Equals("I"))
            {

                if (string.IsNullOrEmpty(txtInjured_EmployeeNo.Text) && errorFlag.Equals(false))
                {
                    errorFlag = true;
                    errorCode = "ERR-017";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtInjured_EmployeeNo.ClientID);
                }
            }
            else if (txtInjured_DateofEmployment.Text.Length > 0 && errorFlag.Equals(false))
            {
                if (!DateTime.TryParseExact(txtInjured_DateofEmployment.Text, format, CultureInfo.InvariantCulture, DateTimeStyles.None, out DateTime dateTime))
                {
                    errorCode = "ERR-010";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDate.ClientID);
                }
            }
            else if (rdoInjuredType.SelectedValue.Equals("P"))
            {

                if (string.IsNullOrEmpty(txtInjured_EmployeeNo.Text) && errorFlag.Equals(false))
                {
                    errorFlag = true;
                    errorCode = "ERR-025";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtInjured_EmployeeNo.ClientID);
                }
                if (txtInjured_EmployeeNo.Text.Length > 0 && errorFlag.Equals(false))
                {

                    if (txtInjured_EmployeeNo.Text.Contains('-'))
                    {
                        errorFlag = true;
                        errorCode = "ERR-051";
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtInjured_EmployeeNo.ClientID);
                    }

                }
            }
            if (errorFlag.Equals(false))
            {
                txtInjured_Name.Text = string.Empty;
                txtInjured_EmployeeNo.Text = string.Empty;

                txtInjured_Race.Text = string.Empty;
                txtInjured_Gender.Text = string.Empty;
                txtInjured_ContactNo.Text = string.Empty;

                hdnInjured_Age.Value = string.Empty;
                txtInjured_Nationlity.Text = string.Empty;
                txtInjured_EmploymentType.Text = string.Empty;
                txtInjured_DateofEmployment.Text = string.Empty;
                txtInjured_Company.Text = string.Empty;
                txtInjured_empdesignation.Text = string.Empty;

                appHelper.AddListViewItem(lstViewInjuredPerson, colItems, "SESSION_LIST_InjuredPerson");
            }
        }

        protected void lstViewInjuredPerson_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstViewInjuredPerson, "SESSION_LIST_InjuredPerson");
                    hdncurrenttab.Value = "0";
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstViewInjuredPerson, "Error", ex.Message);
            }
        }

        protected void lstViewInjuredPerson_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                appHelper.DeleteListViewItem(lstViewInjuredPerson, e.ItemIndex, "SESSION_LIST_InjuredPerson");
                hdncurrenttab.Value = "0";
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstViewInjuredPerson, "Error", ex.Message);
            }
        }

        protected void btnPartA_Click(object sender, EventArgs e)
        {
            string errStr = string.Empty;
            string errtitle = string.Empty;
            try
            {  
                UserBE userBE = (UserBE)AppSession.GetSession("SESSION_OBJ_USERLOGIN");
                bool error = ValidatePartAFileds();
                if (error == false)
                {
                    errStr = Save_PartA_Record();
                    if (errStr.Equals(string.Empty))
                    {
                        errtitle = "Incident Report";
                        errStr = "SUC-001";
                    }
                    else
                    {
                        errtitle = "Notification";
                    }

                    baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errStr + ":" + ex.Message;
                baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
            }
        }

        protected void btnPartASave_Click(object sender, EventArgs e)
        {
            string errorCode = string.Empty;
            bool errorFlag = false;
            string errStr = string.Empty;
            string errtitle = string.Empty;
            try
            {
                if (string.IsNullOrEmpty(txtIncDate.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-002";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDate.ClientID);
                }
                if (txtIncDate.Text.Length != 11 && errorFlag.Equals(false))
                {
                    errorCode = "ERR-010";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDate.ClientID);
                }
                if (txtIncDate.Text.Length > 0 && errorFlag.Equals(false))
                {
                    if (!DateTime.TryParseExact(txtIncDate.Text, format, CultureInfo.InvariantCulture, DateTimeStyles.None, out DateTime dateTime))
                    {
                        errorCode = "ERR-010";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDate.ClientID);
                    }
                    else
                    {
                        DateTime incidentDate = Convert.ToDateTime(txtIncDate.Text);
                        if (incidentDate > DateTime.Now)
                        {
                            errorCode = "ERR-011";
                            errorFlag = true;
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDate.ClientID);
                        }
                    }
                }
                if (string.IsNullOrEmpty(txtIncTime.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-003";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncTime.ClientID);
                }
                if (txtIncTime.Text.Length > 0 && errorFlag.Equals(false))
                {
                    if (txtIncTime.Text.Length != 4)
                    {
                        errorCode = "ERR-012";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncTime.ClientID);
                    }
                    else if (txtIncTime.Text.Contains('-'))
                    {
                        errorCode = "ERR-012";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncTime.ClientID);
                    }
                    else if (txtIncTime.Text.Length == 4 && appHelper.IsNumeric(txtIncTime.Text))
                    {
                        int iHr = int.Parse(txtIncTime.Text.Substring(0, 2));
                        int iMin = int.Parse(txtIncTime.Text.Substring(2, 2));
                        if (iHr >= 24 || iMin >= 60)
                        {
                            errorCode = "ERR-012";
                            errorFlag = true;
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncTime.ClientID);
                        }
                    }
                    else
                    {
                        errorCode = "ERR-012";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncTime.ClientID);
                    }
                }
                if (errorFlag.Equals(false) && string.IsNullOrEmpty(ddlSbu.SelectedValue) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-004";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", ddlSbu.ClientID);
                }

                if (errorFlag.Equals(false) && string.IsNullOrEmpty(txtIncDescription.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-013";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDescription.ClientID);
                }
                if (errorFlag.Equals(false) && txtIncDescription.Text.Length > 1000 && errorFlag.Equals(false))
                {
                    errorCode = "ERR-115";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDescription.ClientID);
                }

                if (errorFlag.Equals(false) && string.IsNullOrEmpty(txtIncDescription.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-013";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDescription.ClientID);
                }
                if (errorFlag.Equals(false) && txtIncDescription.Text.Length > 1000 && errorFlag.Equals(false))
                {
                    errorCode = "ERR-115";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDescription.ClientID);
                }

                if (ddlIncidentType.SelectedValue == "1")
                {
                    if (errorFlag.Equals(false) && lstViewInjuredPerson.Items.Count < 1)
                    {
                        errorCode = "ERR-132";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", "");
                    }
                }

                if (!ddlIncidentType.SelectedValue.Equals("1"))
                {
                    if (errorFlag.Equals(false) && string.IsNullOrEmpty(txtIncDescription_2.Text) && errorFlag.Equals(false))
                    {
                        errorCode = "ERR-141";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDescription_2.ClientID);
                    }
                }

                if (rdoHasEyeWitness.SelectedValue == "1")
                {
                    if (lstViewPartC_EyeWitnesses.Items.Count < 1)
                    {
                        errorCode = "ERR-041";
                        errorFlag = true;
                        currenttab = 2;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", "");
                    }
                }

                if (errorFlag.Equals(false))
                {
                    errStr = Save_PartA_header();
                    if (errStr.Equals(string.Empty))
                    {
                        errtitle = "Incident Report";
                        errStr = "SUC-001";
                    }
                    else
                    {
                        errtitle = "Notification";
                    }
                    baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
                }
            }
            catch (Exception ex)
            {
                errorFlag = true;
                baseHelper.PopUpMessage(btnPartASave, "Error", ex.Message);
            }
        }

        private bool ValidatePartAFileds()
        {
            string errorCode = string.Empty;
            bool errorFlag = false;
            try
            {
                hdncurrenttab.Value = "0";

                if (string.IsNullOrEmpty(txtIncDate.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-002";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDate.ClientID);
                }
                if (txtIncDate.Text.Length != 11 && errorFlag.Equals(false))
                {
                    errorCode = "ERR-010";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDate.ClientID);
                }
                if (txtIncDate.Text.Length > 0 && errorFlag.Equals(false))
                {
                    if (!DateTime.TryParseExact(txtIncDate.Text, format, CultureInfo.InvariantCulture, DateTimeStyles.None, out DateTime dateTime))
                    {
                        errorCode = "ERR-010";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDate.ClientID);
                    }
                    else
                    {
                        DateTime incidentDate = Convert.ToDateTime(txtIncDate.Text);
                        if (incidentDate > DateTime.Now)
                        {
                            errorCode = "ERR-011";
                            errorFlag = true;
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDate.ClientID);
                        }
                    }
                }
                if (string.IsNullOrEmpty(txtIncTime.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-003";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncTime.ClientID);
                }
                if (txtIncTime.Text.Length > 0 && errorFlag.Equals(false))
                {
                    if (txtIncTime.Text.Length != 4)
                    {
                        errorCode = "ERR-012";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncTime.ClientID);
                    }
                    else if (txtIncTime.Text.Contains('-'))
                    {
                        errorCode = "ERR-012";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncTime.ClientID);
                    }
                    else if (txtIncTime.Text.Length == 4 && appHelper.IsNumeric(txtIncTime.Text))
                    {
                        int iHr = int.Parse(txtIncTime.Text.Substring(0, 2));
                        int iMin = int.Parse(txtIncTime.Text.Substring(2, 2));
                        if (iHr >= 24 || iMin >= 60)
                        {
                            errorCode = "ERR-012";
                            errorFlag = true;
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncTime.ClientID);
                        }
                    }
                    else
                    {
                        errorCode = "ERR-012";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncTime.ClientID);
                    }
                }

                if (string.IsNullOrEmpty(ddlSbu.SelectedValue) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-004";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", ddlSbu.ClientID);
                }

                if (string.IsNullOrEmpty(txtIncDescription.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-013";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDescription.ClientID);
                }
                if (txtIncDescription.Text.Length > 1000 && errorFlag.Equals(false))
                {
                    errorCode = "ERR-115";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDescription.ClientID);
                }

                if (string.IsNullOrEmpty(txtIncDescription.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-013";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDescription.ClientID);
                }
                if (txtIncDescription.Text.Length > 1000 && errorFlag.Equals(false))
                {
                    errorCode = "ERR-115";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtIncDescription.ClientID);
                }

                if (ddlIncidentType.SelectedValue == "1")
                {
                    if (lstViewInjuredPerson.Items.Count < 1)
                    {
                        errorCode = "ERR-132";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", txtInjured_Name.ClientID);
                    }
                }

                if (string.IsNullOrEmpty(lblRepoter.Text.Trim()))
                {
                    errorCode = "ERR-053";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", "");
                }

                if (string.IsNullOrEmpty(ddlPartA_HODID.SelectedValue.ToString()))
                {
                    errorCode = "ERR-133";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", ddlPartA_HODID.ClientID);
                }

                if (string.IsNullOrEmpty(rdoHasEyeWitness.SelectedValue.Trim()))
                {
                    errorCode = "ERR-142";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "0", rdoHasEyeWitness.ClientID);
                }

                if (rdoHasEyeWitness.SelectedValue == "1")
                {
                    if (lstViewPartC_EyeWitnesses.Items.Count < 1)
                    {
                        errorCode = "ERR-041";
                        errorFlag = true;
                        currenttab = 2;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", "");
                    }
                }
            }
            catch (Exception ex)
            {
                errorFlag = true;
                baseHelper.PopUpMessage(btnPartA, "Error", ex.Message);
            }
            return errorFlag;
        }

        public string update_part_A()
        {
            CommonFun appHelper = new CommonFun();
            ErrorMessageBC errbc = new ErrorMessageBC();

            string errStr = string.Empty;
            string returnValue = string.Empty;
            string incidentID = string.Empty;
            string errorCode = string.Empty;
            DataSet workflow_ds = new DataSet();
            try
            {
                WorkflowIncidentBE ibe = new WorkflowIncidentBE();
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();

                ibe.sba_code = ddlsba.SelectedValue;
                ibe.incident_datetime = txtIncDate.Text + " " + txtIncTime.Text.Trim().Substring(0, 2) + ":" + txtIncTime.Text.Trim().Substring(2, 2);
                ibe.sbu_code = ddlSbu.SelectedValue.Trim();
                ibe.department = ddlDepartment.SelectedValue.Trim(); 
                ibe.location = ddlLocation.SelectedValue.Trim();
                ibe.exact_location = txtLocation.Text.Trim();
                ibe.incident_desc = txtIncDescription.Text.Trim();

                ibe.damage_description = txtIncDescription_2.Text.Trim();
                ibe.any_eyewitness = Convert.ToInt16(rdoHasEyeWitness.SelectedValue);
                ibe.is_working_overtime = txtisworkingovertime.Text.Trim();
                ibe.is_jobrelated = rdois_job_related.SelectedItem.Text;
                ibe.examined_hospital_clinic_name = txthospital_name.Text.Trim();
                ibe.official_working_hrs = txtoffical_work_hrs.Text.Trim();
            }
            catch (Exception ex)
            {
                returnValue = ex.Message.ToString();
            }
            return returnValue;
        }

        public string Save_PartA_Record()
        {
            CommonFun appHelper = new CommonFun();
            ErrorMessageBC errbc = new ErrorMessageBC();

            string errStr = string.Empty;
            string returnValue = string.Empty;
            string incidentID = string.Empty;
            string errorCode = string.Empty;
            DataSet workflow_ds = new DataSet();
            try
            {

                DataSet eyewitness_ds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_EyeWitnesses");
                eyewitness_ds.Tables[0].TableName = "EyeWitnesses";

                WorkflowIncidentBE incidentBE = new WorkflowIncidentBE();
                WorkflowIncidentBC incidentBC = new WorkflowIncidentBC();

                incidentBE.sba_code = ddlsba.SelectedValue;
                incidentBE.incident_datetime = txtIncDate.Text + " " + txtIncTime.Text.Trim().Substring(0, 2) + ":" + txtIncTime.Text.Trim().Substring(2, 2);
                incidentBE.sbu_code = ddlSbu.SelectedValue.Trim();
                incidentBE.department = ddlDepartment.SelectedValue.Trim(); 
                incidentBE.location = ddlLocation.SelectedValue.Trim();
                incidentBE.exact_location = txtLocation.Text.Trim();
                incidentBE.incident_desc = txtIncDescription.Text.Trim();
                incidentBE.superior_emp_no = userLogin.UserId;
                incidentBE.superior_name = userLogin.UserName;
                incidentBE.status = "01";

                incidentBE.damage_description = txtIncDescription_2.Text.Trim();
                incidentBE.any_eyewitness = Convert.ToInt16(rdoHasEyeWitness.SelectedValue);
                incidentBE.is_working_overtime = txtisworkingovertime.Text.Trim();

                incidentBE.is_jobrelated = !string.IsNullOrEmpty(rdois_job_related.SelectedValue.Trim()) ? rdois_job_related.SelectedItem.Text.Trim() : string.Empty;
                incidentBE.examined_hospital_clinic_name = txthospital_name.Text.Trim();
                incidentBE.official_working_hrs = txtoffical_work_hrs.Text.Trim();

                DataSet InjuredPerson_ds = new DataSet();
                set_injured_person(out InjuredPerson_ds);

                string action_role = "HOD";
                setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, ddlPartA_HODID.SelectedValue.Trim(), string.Empty);
                if (ddlPartA_AHOD.SelectedValue.Trim() != string.Empty)
                {
                    action_role = "AHOD";
                    setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, ddlPartA_AHOD.SelectedValue.Trim(), string.Empty);
                }
                if (ddlPartA_WSHOID.SelectedValue.Trim() != string.Empty)
                {
                    action_role = "WSHO";
                    setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, ddlPartA_WSHOID.SelectedValue.Trim(), string.Empty);
                }

                action_role = "COPYTO";
                foreach (ListItem li in chkPartACopyTo.Items)
                {
                    if (li.Selected)
                    {
                        string copyto_usrid = string.Empty;
                        copyto_usrid = li.Value;
                        setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, copyto_usrid, string.Empty);
                    }
                }

                workflow_ds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                DataSet incidentype_ds = new DataSet();
                DataTable incidentypeDT = new DataTable
                {
                    TableName = "incidenttype"
                };
                incidentypeDT.Columns.Add(new DataColumn("incident_type", typeof(string)));
                incidentypeDT.Columns.Add(new DataColumn("type_description", typeof(string)));

                DataRow dr = null;
                dr = incidentypeDT.NewRow();
                dr["incident_type"] = ddlIncidentType.SelectedValue;
                dr["type_description"] = string.Empty;
                incidentypeDT.Rows.Add(dr);

                incidentype_ds.Tables.Add(incidentypeDT);

                incidentBC.insert_Incidents(incidentBE, incidentype_ds, InjuredPerson_ds, eyewitness_ds, workflow_ds, out incidentID, out errorCode);
                incidentBE.incident_id = incidentID;
                incidentBC.get_incident_by_id(incidentBE);

                if (!string.IsNullOrEmpty(errorCode))
                {

                    errbc.GetErrorMessage(errorCode, out errStr);
                    returnValue = errorCode + "/" + errStr;
                }
                else
                {
                    incidentBE.incident_id = incidentID;

                    AppSession.SetSession("SESSION_OBJ_INCIDENT", incidentBE);
                    SendEmailNotification(incidentBE, "00", "01", workflow_ds.Tables[0], string.Empty, out errorCode);
                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        errbc.GetErrorMessage(errorCode, out errStr);
                        returnValue = errorCode + "/" + errStr;
                    }
                    else
                    {
                        errorCode = "SUC-001";
                        returnValue = errorCode + "/" + errorCode;
                    }

                    Session.Remove("SESSION_LIST_InjuredPerson");
                    Session.Remove("SESSION_LIST_WORKFLOWS");

                }
            }
            catch (Exception ex)
            {
                returnValue = ex.Message.ToString();
            }
            return returnValue;
        }

        public string Save_PartA_header()
        {
            CommonFun appHelper = new CommonFun();
            ErrorMessageBC errbc = new ErrorMessageBC();

            string errStr = string.Empty;
            string returnValue = string.Empty;
            string incidentID = string.Empty;
            string errorCode = string.Empty;
            DataSet workflow_ds = new DataSet();
            try
            {

                DataSet eyewitness_ds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_EyeWitnesses");
                eyewitness_ds.Tables[0].TableName = "EyeWitnesses";

                WorkflowIncidentBE incidentBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                WorkflowIncidentBC incidentBC = new WorkflowIncidentBC();

                incidentBE.incident_id = lble_incident_id.Text.Trim();
                incidentBE.sba_code = ddlsba.SelectedValue; 
                incidentBE.incident_datetime = txtIncDate.Text + " " + txtIncTime.Text.Trim().Substring(0, 2) + ":" + txtIncTime.Text.Trim().Substring(2, 2);
                incidentBE.sbu_code = ddlSbu.SelectedValue.Trim();
                incidentBE.department = ddlDepartment.SelectedValue.Trim(); 
                incidentBE.location = ddlLocation.SelectedValue.Trim();
                incidentBE.exact_location = txtLocation.Text.Trim();
                incidentBE.incident_desc = txtIncDescription.Text.Trim();

                incidentBE.modified_by = userLogin.UserId;

                incidentBE.damage_description = txtIncDescription_2.Text.Trim();
                incidentBE.any_eyewitness = Convert.ToInt16(rdoHasEyeWitness.SelectedValue);
                incidentBE.is_working_overtime = txtisworkingovertime.Text.Trim();

                incidentBE.is_jobrelated = !string.IsNullOrEmpty(rdois_job_related.SelectedValue.Trim()) ? rdois_job_related.SelectedItem.Text : string.Empty;
                incidentBE.examined_hospital_clinic_name = txthospital_name.Text.Trim();
                incidentBE.official_working_hrs = txtoffical_work_hrs.Text.Trim();

                DataSet InjuredPerson_ds = new DataSet();
                set_injured_person(out InjuredPerson_ds);

                DataSet incidentype_ds = new DataSet();
                DataTable incidentypeDT = new DataTable
                {
                    TableName = "incidenttype"
                };
                incidentypeDT.Columns.Add(new DataColumn("incident_type", typeof(string)));
                incidentypeDT.Columns.Add(new DataColumn("type_description", typeof(string)));

                DataRow dr = null;
                dr = incidentypeDT.NewRow();
                dr["incident_type"] = ddlIncidentType.SelectedValue;
                dr["type_description"] = string.Empty;
                incidentypeDT.Rows.Add(dr);

                incidentype_ds.Tables.Add(incidentypeDT);

                incidentBC.update_incidents_header(incidentBE, incidentype_ds, eyewitness_ds, out errorCode);

                if (!string.IsNullOrEmpty(errorCode))
                {

                    errbc.GetErrorMessage(errorCode, out errStr);
                    returnValue = errorCode + "/" + errStr;
                }
                else
                {

                    incidentBC.update_incidents_injured(incidentBE.incident_id, InjuredPerson_ds, out errorCode);
                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        errbc.GetErrorMessage(errorCode, out errStr);
                        returnValue = errorCode + "/" + errStr;
                    }
                    else
                    {

                        string action_role = "HOD";
                        setworkflow_data(incidentBE.incident_id, "01", action_role, ddlPartA_HODID.SelectedValue.Trim(), string.Empty);
                        if (ddlPartA_AHOD.SelectedValue.Trim() != string.Empty)
                        {
                            action_role = "AHOD";
                            setworkflow_data(incidentBE.incident_id, "01", action_role, ddlPartA_AHOD.SelectedValue.Trim(), string.Empty);
                        }
                        if (ddlPartA_WSHOID.SelectedValue.Trim() != string.Empty)
                        {
                            action_role = "WSHO";
                            setworkflow_data(incidentBE.incident_id, "01", action_role, ddlPartA_WSHOID.SelectedValue.Trim(), string.Empty);
                        }
                        workflow_ds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                        incidentBC.insert_incidents_workflows(incidentBE.incident_id, workflow_ds, out errorCode);

                        if (!string.IsNullOrEmpty(errorCode))
                        {
                            errbc.GetErrorMessage(errorCode, out errStr);
                            returnValue = errorCode + "/" + errStr;
                        }
                        else
                        {

                            AppSession.SetSession("SESSION_OBJ_INCIDENT", incidentBE);
                            SendEmailNotification(incidentBE, "00", "00", workflow_ds.Tables[0], string.Empty, out errorCode);
                            if (!string.IsNullOrEmpty(errorCode))
                            {
                                errbc.GetErrorMessage(errorCode, out errStr);
                                returnValue = errorCode + "/" + errStr;
                            }
                            else
                            {
                                errorCode = "SUC-001";
                                returnValue = errorCode + "/" + errorCode;
                            }

                            Session.Remove("SESSION_LIST_InjuredPerson");
                            Session.Remove("SESSION_LIST_WORKFLOWS");

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                returnValue = ex.Message.ToString();
            }
            return returnValue;
        }

        private void set_injured_person(out DataSet ods)
        {
            ods = null;
            try
            {
                DataTable ijp_dt = new DataTable
                {

                    TableName = "Table1"
                };
                ijp_dt.Columns.Add(new DataColumn("InjuredPerson_name", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("InjuredPerson_EmpNo", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("InjuredPerson_NRIC", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("InjuredPerson_Race", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("InjuredPerson_Gender", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("InjuredPerson_ContactNo", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("InjuredPerson_Age", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("InjuredPerson_Nationality", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("InjuredPerson_EmploymentType", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("InjuredPerson_DateofEmployment", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("InjuredPerson_Designation", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("Injured_Company", typeof(string)));

                foreach (ListViewDataItem lstViewItem in lstViewInjuredPerson.Items)
                {
                    TextBox txtVInjuredName = (TextBox)lstViewItem.FindControl("txtVInjuredName");
                    TextBox txtVInjuredEmpNo = (TextBox)lstViewItem.FindControl("txtVInjuredEmpNo");
                    TextBox txtVInjuredRace = (TextBox)lstViewItem.FindControl("txtVInjuredRace");
                    TextBox txtVInjuredGender = (TextBox)lstViewItem.FindControl("txtVInjuredGender");

                    HiddenField hdnVInjuredAge = (HiddenField)lstViewItem.FindControl("hdnVInjuredAge");
                    TextBox txtVInjuredContactNo = (TextBox)lstViewItem.FindControl("txtVInjuredContactNo");
                    TextBox txtVInjuredNationality = (TextBox)lstViewItem.FindControl("txtVInjuredNationality");
                    TextBox txtVInjuredEmploymentType = (TextBox)lstViewItem.FindControl("txtVInjuredEmploymentType");
                    TextBox txtVInjuredDateofEmployment = (TextBox)lstViewItem.FindControl("txtVInjuredDateofEmployment");
                    TextBox txtVInjuredDesignation = (TextBox)lstViewItem.FindControl("txtVInjuredDesignation");
                    TextBox txtVInjuredCompany = (TextBox)lstViewItem.FindControl("txtVInjuredCompany");

                    DataRow row = ijp_dt.NewRow();
                    row["InjuredPerson_name"] = txtVInjuredName.Text.Trim();
                    row["InjuredPerson_EmpNo"] = txtVInjuredEmpNo.Text.Trim();
                    row["InjuredPerson_Race"] = txtVInjuredRace.Text.Trim();
                    row["InjuredPerson_Gender"] = txtVInjuredGender.Text.Trim();

                    row["InjuredPerson_Age"] = hdnVInjuredAge.Value.Trim();
                    row["InjuredPerson_ContactNo"] = txtVInjuredContactNo.Text.Trim();
                    row["InjuredPerson_Nationality"] = txtVInjuredNationality.Text.Trim();
                    row["InjuredPerson_EmploymentType"] = txtVInjuredEmploymentType.Text.Trim();
                    row["InjuredPerson_DateofEmployment"] = txtVInjuredDateofEmployment.Text.Trim();
                    row["InjuredPerson_Designation"] = txtVInjuredDesignation.Text.Trim();
                    row["Injured_Company"] = txtVInjuredCompany.Text.Trim();
                    ijp_dt.Rows.Add(row);
                }
                ods = new DataSet();
                ods.Tables.Clear();
                ods.Tables.Add(ijp_dt);

            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(btnPartA, "Error", ex.Message);
            }
        }

        private void BindPartA(WorkflowIncidentBE incidentBE, DataSet ds)
        {
            WorkflowIncidentBC iBC = new WorkflowIncidentBC();
            DataSet wfds = iBC.get_wirs_incidents_workflows_by_id(incidentBE.incident_id, "01");
            int istatus = Convert.ToInt16(incidentBE.status);

            if (istatus > 0)
            {
                pnl_PartA.Visible = false;
                pnl_PartA_1.Visible = false;

                pnl_PartA_2.Visible = false;
                pnl_V_PartA.Visible = true;

                lblvincident_id.Text = string.Empty;
                lblincidentType.Text = string.Empty;
                lblvDate.Text = string.Empty;
                lblvTime.Text = string.Empty;
                lblvSBU.Text = string.Empty;
                lblvDepartment.Text = string.Empty;
                lblvLocation.Text = string.Empty;
                lblvexactLocation.Text = string.Empty;
                lblvDescription.Text = string.Empty;
                lblvReporterName.Text = string.Empty;
                lblvReporterID.Text = string.Empty;
                lblvReportingDate.Text = string.Empty;
                lblReporterDesignation.Text = string.Empty;

                lblvis_jobrelated.Text = string.Empty;
                lblvexamined_hospital_clinic_name.Text = string.Empty;
                lblvis_working_overtime.Text = string.Empty;
                lblvofficial_working_hrs.Text = string.Empty;
                lblvdamage_description.Text = string.Empty;
                lblvany_eyewitness.Text = string.Empty;

                lblvincident_id.Text = incidentBE.incident_id;

                lblvDate.Text = incidentBE.incident_date;
                lblvTime.Text = incidentBE.incident_time;
                lblvSBU.Text = incidentBE.sbu_name;
                lblvDepartment.Text = incidentBE.department_name;
                lblvLocation.Text = incidentBE.location_name;
                lblvexactLocation.Text = incidentBE.exact_location;
                lblvDescription.Text = incidentBE.incident_desc;
                lblvReporterName.Text = incidentBE.superior_name;
                lblvReporterID.Text = incidentBE.superior_emp_no;
                lblvReportingDate.Text = incidentBE.creation_date;

                lblvis_jobrelated.Text = incidentBE.is_jobrelated;
                lblvexamined_hospital_clinic_name.Text = incidentBE.examined_hospital_clinic_name;
                lblvis_working_overtime.Text = incidentBE.is_working_overtime;
                lblvofficial_working_hrs.Text = incidentBE.official_working_hrs;
                lblvdamage_description.Text = incidentBE.damage_description;
                lblvany_eyewitness.Text = Convert.ToInt16(incidentBE.any_eyewitness) == 1 ? "Yes" : "No";
                lblincidentType.Text = ds.Tables[1].Rows[0]["lookup_value"].ToString();

                chkVIncidentType.DataSource = ds.Tables[1];
                chkVIncidentType.DataTextField = "lookup_value";
                chkVIncidentType.DataValueField = "lookup_code";
                chkVIncidentType.DataBind();

                for (int i = 0; i < chkVIncidentType.Items.Count; i++)
                {
                    chkVIncidentType.Items[i].Selected = true;
                }

                appHelper.SetupLookUpDDList(ddlIncidentType, "Incident Type");
                ddlIncidentType.SelectedIndex = ddlIncidentType.Items.IndexOf(ddlIncidentType.Items.FindByText(ds.Tables[1].Rows[0]["lookup_value"].ToString().Trim()));

                gv_injured_person.DataSource = ds.Tables[2];
                gv_injured_person.DataBind();

                if (ds.Tables[3].Rows.Count > 0)
                {
                    pnlview_eye_witnesses.Visible = true;
                    lstVViewPartC_EyeWitnesses.DataSource = ds.Tables[3];
                    lstVViewPartC_EyeWitnesses.DataBind();
                }

                workflowdataBind(wfds.Tables[0], gv_parta_workflow, lblvReporterName, lblvReporterID, lblvReportingDate, lblReporterDesignation);
            }
            else
            {
                pnl_PartA.Visible = true;
                pnl_PartA_1.Visible = true;
                pnl_PartA_2.Visible = true;
                pnl_V_PartA.Visible = false;
            }
        }

        protected void btnAddPartC_EyeWitnesses_Click(object sender, EventArgs e)
        {
            try
            {
                bool errorFlag = false;
                string errorCode = string.Empty;
                WorkflowIncidentBE incidentBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                Dictionary<string, string> colItems = new Dictionary<string, string>()
                    {
                        {"empid", txtPartC_EyeWitnessesID.Text},
                        {"empname", txtPartC_EyeWitnessesName.Text},
                        {"empdesignation", txtPartC_EyeWitnessesDesignation.Text},
                        {"empcontactno", txtPartC_EyeWitnessesContactNo.Text}
                     };

                if (string.IsNullOrEmpty(txtPartC_EyeWitnessesName.Text) && errorFlag.Equals(false))
                {
                    errorFlag = true;
                    errorCode = "ERR-014";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtPartC_EyeWitnessesName.ClientID);
                }

                if (string.IsNullOrEmpty(txtPartC_EyeWitnessesID.Text) && errorFlag.Equals(false))
                {
                    errorFlag = true;
                    errorCode = "ERR-017";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtPartC_EyeWitnessesID.ClientID);
                }

                if (errorFlag.Equals(false))
                {
                    ViewState["empid"] = string.Empty;
                    ViewState["empname"] = string.Empty;
                    ViewState["empdesignation"] = string.Empty;
                    ViewState["empcontactno"] = string.Empty;

                    txtPartC_EyeWitnessesName.Text = string.Empty;
                    txtPartC_EyeWitnessesID.Text = string.Empty;
                    txtPartC_EyeWitnessesDesignation.Text = string.Empty;
                    txtPartC_EyeWitnessesContactNo.Text = string.Empty;

                    appHelper.AddListViewItem(lstViewPartC_EyeWitnesses, colItems, "SESSION_LIST_PartC_EyeWitnesses");
                }

                hdncurrenttab.Value = "0"; 

            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstViewPartC_EyeWitnesses, "Error", ex.Message);
            }
        }

        protected void lstViewPartC_EyeWitnesses_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstViewPartC_EyeWitnesses, "SESSION_LIST_PartC_EyeWitnesses");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstViewPartC_EyeWitnesses, "Error", ex.Message);
            }
        }

        protected void lstViewPartC_EyeWitnesses_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                hdncurrenttab.Value = "0";
                appHelper.DeleteListViewItem(lstViewPartC_EyeWitnesses, e.ItemIndex, "SESSION_LIST_PartC_EyeWitnesses");
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstViewPartC_EyeWitnesses, "Error", ex.Message);
            }
        }

        #endregion PartA

        #region PartB

        private void InitPartB(string incidentid)
        {
            DataSet ids = new DataSet();
            WorkflowIncidentBC ibc = new WorkflowIncidentBC();
            WorkflowIncidentBE iBE = new WorkflowIncidentBE
            {
                incident_id = incidentid
            };
            ids = ibc.get_incident_by_id(iBE);
            if (iBE.status == "01")
            {
                pnl_PartB.Visible = true;
            }
            txtPartBReviewandComment.Text = string.Empty;
            DataSet uds = new DataSet();
            DataSet wshods = new DataSet();
            DataSet awshods = new DataSet();
            DataSet copytods = new DataSet();

            string sba_code, sbu_code, department_code, location_code;
            sba_code = iBE.sba_code;
            sbu_code = iBE.sbu_code;
            department_code = iBE.department;
            location_code = iBE.location;

            UserBC uBC = new UserBC();
            uds = uBC.GetEmployeeInfoByEmployeeNo(userLogin.UserId);
            wshods = uBC.get_wsho_by_sbu(sba_code, sbu_code, department_code, location_code);
            awshods = uBC.get_awsho_by_sbu(sba_code, sbu_code, department_code, location_code);
            copytods = uBC.get_active_cclist_by_sbu(sba_code, sbu_code, department_code, location_code);

            lblPartBHODName.Text = uds.Tables[0].Rows[0]["empname"].ToString();
            lblPartBHODID.Text = userLogin.UserId;
            lblPartBHODDesignation.Text = uds.Tables[0].Rows[0]["empdesignation"].ToString();
            lblPartBHODSubmittionDate.Text = DateTime.Now.ToString("dd-MMM-yyyy");

            appHelper.BindCodeToListControl(ddlPartB_WSHO, wshods, "empname", "empid", string.Empty);
            ddlPartB_WSHO.SelectedValue = iBE.wsho_id;

            appHelper.BindCodeToListControl(ddlPartB_A_WSHO, awshods, "empname", "empid", string.Empty);
            ddlPartB_A_WSHO.SelectedValue = iBE.awsho_id;

            appHelper.BindCheckBoxList(chkPartBEmailTo, copytods, "empname", "empid");
            foreach (ListItem li in chkPartBEmailTo.Items)
            {
                li.Selected = true;
            }

            txtPartBReviewandComment.Text = string.Empty;
        }

        protected void btnAddPartB_CopyTo_Click(object sender, EventArgs e)
        {
            try
            {
                bool errorFlag = false;
                string errorCode = string.Empty;
                WorkflowIncidentBE incidentBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                Dictionary<string, string> colItems = new Dictionary<string, string>()
                    {
                        {"empid", txtPartB_CopyToID.Text},
                        {"empname", txtPartB_CopyToName.Text},
                        {"empdesignation", txtPartB_CopyToDesignation.Text}
                     };

                if (string.IsNullOrEmpty(txtPartB_CopyToName.Text) && errorFlag.Equals(false))
                {
                    errorFlag = true;
                    errorCode = "ERR-014";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "1", txtPartB_CopyToName.ClientID);
                }

                if (string.IsNullOrEmpty(txtPartB_CopyToID.Text) && errorFlag.Equals(false))
                {
                    errorFlag = true;
                    errorCode = "ERR-017";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "1", txtPartB_CopyToID.ClientID);
                }
                if (errorFlag.Equals(false))
                {
                    ViewState["empid"] = string.Empty;
                    ViewState["empname"] = string.Empty;
                    ViewState["empdesignation"] = string.Empty;

                    txtPartB_CopyToID.Text = string.Empty;
                    txtPartB_CopyToName.Text = string.Empty;
                    txtPartB_CopyToDesignation.Text = string.Empty;

                    appHelper.AddListViewItem(lstPartB_CopyTo, colItems, "SESSION_LIST_B_WORKFLOWS");

                    hdncurrenttab.Value = "1"; 

                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartB_CopyTo, "Error", ex.Message);
            }
        }

        protected void lstPartB_CopyTo_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstPartB_CopyTo, "SESSION_LIST_B_WORKFLOWS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstViewInjuredPerson, "Error", ex.Message);
            }
        }

        protected void lstPartB_CopyTo_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                appHelper.DeleteListViewItem(lstPartB_CopyTo, e.ItemIndex, "SESSION_LIST_B_WORKFLOWS");

                hdncurrenttab.Value = "1"; 

            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartB_CopyTo, "Error", ex.Message);
            }
        }

        protected void btnPartB_Click(object sender, EventArgs e)
        {
            hdncurrenttab.Value = "01";
            string errtitle = string.Empty;
            string errorCode = string.Empty;
            string errStr = string.Empty;
            WorkflowIncidentBE incidentBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
            WorkflowIncidentBC incidentBC = new WorkflowIncidentBC();

            try
            {
                bool error = false;
                if (string.IsNullOrEmpty(txtPartBReviewandComment.Text.Trim()))
                {
                    errorCode = "ERR-134";
                    error = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "1", txtPartBReviewandComment.ClientID);
                }
                else if (string.IsNullOrEmpty(ddlPartB_WSHO.SelectedValue.ToString()))
                {
                    errorCode = "ERR-135";
                    error = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "1", ddlPartB_WSHO.ClientID);
                }
                if (error == false)
                {
                    CommonFun appHelper = new CommonFun();
                    ErrorMessageBC errbc = new ErrorMessageBC();
                    incidentBE.status = "02";
                    int iinjured_case_type = Convert.ToInt16(rdoinjured_case_type.SelectedValue);
                    incidentBE.injured_case_type = rdoinjured_case_type.SelectedItem.Text.Trim();
                    string action_role = "COPYTO";

                    foreach (ListItem li in chkPartBEmailTo.Items)
                    {
                        if (li.Selected)
                        {
                            string copyto_usrid = string.Empty;
                            copyto_usrid = li.Value;
                            setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, copyto_usrid, string.Empty);
                        }
                    }

                    foreach (ListViewDataItem lstViewItem in lstPartB_CopyTo.Items)
                    {
                        TextBox txtPartB_CopyToEmpNo = (TextBox)lstViewItem.FindControl("txtPartB_CopyToEmpNo");
                        if (txtPartB_CopyToEmpNo.Text.Trim() != string.Empty)
                        {
                            setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, txtPartB_CopyToEmpNo.Text.Trim(), string.Empty);
                        }
                    }

                    action_role = "WSHO";
                    setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, ddlPartB_WSHO.SelectedValue.ToString(), txtPartBReviewandComment.Text.Trim());
                    if (ddlPartB_A_WSHO.SelectedValue.Trim() != string.Empty)
                    {
                        action_role = "A_WSHO";
                        setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, ddlPartB_A_WSHO.SelectedValue.ToString(), string.Empty);
                    }
                    DataSet w_partb_ds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                    incidentBC.update_Incidents(incidentBE, out errorCode);

                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        errbc.GetErrorMessage(errorCode, out errStr);
                    }
                    else
                    {
                        if (iinjured_case_type == 1)
                        {

                            UserBC userBC = new UserBC();
                            DataSet hrds = userBC.get_hrlist_by_sbu(incidentBE.sba_code, incidentBE.sbu_code, incidentBE.department, incidentBE.location);

                            SendEmailNotification(incidentBE, "01", "02", hrds.Tables[0], txtPartBReviewandComment.Text.Trim(), out errorCode);
                        }
                        incidentBC.insert_incidents_workflows(incidentBE.incident_id, w_partb_ds, out errorCode);
                        if (!string.IsNullOrEmpty(errorCode))
                        {
                            errbc.GetErrorMessage(errorCode, out errStr);
                        }
                        else
                        {
                            SendEmailNotification(incidentBE, "01", "02", w_partb_ds.Tables[0], txtPartBReviewandComment.Text.Trim(), out errorCode);
                            if (string.IsNullOrEmpty(errorCode))
                            {
                                errtitle = "Incident Report";
                                errStr = "SUC-001";
                            }
                            else
                            {
                                errtitle = "Notification";
                                errStr = errorCode;
                            }
                            Session.Remove("SESSION_LIST_WORKFLOWS");
                            baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errorCode + ":" + ex.Message;
                baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
            }
        }

        protected void btnPartBClose_Click(object sender, EventArgs e)
        {
            string errtitle = string.Empty;
            string errorCode = string.Empty;
            string errStr = string.Empty;
            WorkflowIncidentBE incidentBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
            WorkflowIncidentBC incidentBC = new WorkflowIncidentBC();

            try
            {
                bool error = false;
                if (string.IsNullOrEmpty(txtPartBReviewandComment.Text.Trim()))
                {
                    errorCode = "ERR-134";
                    error = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "1", txtPartBReviewandComment.ClientID);
                }
                else if (string.IsNullOrEmpty(ddlPartB_WSHO.SelectedValue.ToString()))
                {
                    errorCode = "ERR-135";
                    error = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "1", ddlPartB_WSHO.ClientID);
                }
                if (error == false)
                {
                    CommonFun appHelper = new CommonFun();
                    ErrorMessageBC errbc = new ErrorMessageBC();
                    incidentBE.status = "08";
                    string action_role = "CLOSE";

                    setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, incidentBE.created_by, txtPartBReviewandComment.Text.Trim());

                    foreach (ListItem li in chkPartBEmailTo.Items)
                    {
                        if (li.Selected)
                        {
                            string copyto_usrid = string.Empty;
                            copyto_usrid = li.Value;
                            setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, copyto_usrid, string.Empty);
                        }
                    }

                    foreach (ListViewDataItem lstViewItem in lstPartB_CopyTo.Items)
                    {
                        TextBox txtPartB_CopyToEmpNo = (TextBox)lstViewItem.FindControl("txtPartB_CopyToEmpNo");
                        if (txtPartB_CopyToEmpNo.Text.Trim() != string.Empty)
                        {
                            setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, txtPartB_CopyToEmpNo.Text.Trim(), string.Empty);
                        }
                    }

                    setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, ddlPartB_WSHO.SelectedValue.ToString(), string.Empty);

                    if (ddlPartB_A_WSHO.SelectedValue.Trim() != string.Empty)
                    {
                        setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, ddlPartB_A_WSHO.SelectedValue.ToString(), string.Empty);
                    }
                    DataSet w_partb_ds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                    incidentBC.insert_incidents_workflows(incidentBE.incident_id, w_partb_ds, out errorCode);

                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        errbc.GetErrorMessage(errorCode, out errStr);
                    }
                    else
                    {
                        SendEmailNotification(incidentBE, "01", "00", w_partb_ds.Tables[0], txtPartBReviewandComment.Text.Trim(), out errorCode);
                        if (string.IsNullOrEmpty(errorCode))
                        {
                            errtitle = "Incident Report";
                            errStr = "SUC-001";
                        }
                        else
                        {
                            errtitle = "Notification";
                            errStr = errorCode;
                        }
                        Session.Remove("SESSION_LIST_WORKFLOWS");
                        baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");

                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errorCode + ":" + ex.Message;
                baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
            }
        }

        private void BindPartB(WorkflowIncidentBE incidentBE, DataSet ds)
        {
            WorkflowIncidentBC iBC = new WorkflowIncidentBC();
            DataSet wfds = iBC.get_wirs_incidents_workflows_by_id(incidentBE.incident_id, "02");

            int istatus = Convert.ToInt16(incidentBE.status);
            if (istatus > 1)
            {
                pnl_PartB.Visible = false;
                pnl_V_PartB.Visible = true;

                lblVPartBinjured_case_type.Text = incidentBE.injured_case_type;
                lblVPartBReviewandComment.Text = wfds.Tables[1].Rows[0]["remarks"].ToString();
                lblVPartBHODName.Text = string.Empty;
                lblVPartBHODID.Text = string.Empty;
                lblVPartBHODSubmittionDate.Text = string.Empty;
                lblVPartBHODDesignation.Text = string.Empty;

                workflowdataBind(wfds.Tables[0], gv_partb_workflow, lblVPartBHODName, lblVPartBHODID, lblVPartBHODSubmittionDate, lblVPartBHODDesignation);
            }
            else
            {
                pnl_PartB.Visible = true;
                pnl_V_PartB.Visible = false;
            }
        }

        #endregion PartB

        #region Part C

        private void InitPartC(string incidentid)
        {
            DataSet ids = new DataSet();
            WorkflowIncidentBC iBC = new WorkflowIncidentBC();
            WorkflowIncidentBE iBE = new WorkflowIncidentBE
            {
                incident_id = incidentid
            };
            ids = iBC.get_incident_by_id(iBE);

            string sba_code, sbu_code, department_code, location_code;
            sba_code = iBE.sba_code;
            sbu_code = iBE.sbu_code;
            department_code = iBE.department;
            location_code = iBE.location;

            UserBC uBC = new UserBC();

            int istatus = Convert.ToInt16(iBE.status);
            DataSet vds = iBC.validate_user_to_edit_inc(iBE.incident_id, userLogin.UserId, "MC");

            appHelper.SetupLookUpCheckboxlist(chkNatureInj, "Nature Of Injury");
            appHelper.SetupLookUpCheckboxlist(chkHead, "Head Neck Torso");
            appHelper.SetupLookUpCheckboxlist(chkUpper, "Upper Limbs");
            appHelper.SetupLookUpCheckboxlist(chkLower, "Lower Limbs");

            appHelper.SetupLookUpCheckboxlist(chkIncidentClass, "Incident Class");
            appHelper.SetupLookUpCheckboxlist(chkIncidentAgent, "Incident Agent");
            appHelper.SetupLookUpCheckboxlist(chkUC, "Unsafe Condition");
            appHelper.SetupLookUpCheckboxlist(chkUA, "Unsafe Act");
            appHelper.SetupLookUpCheckboxlist(chkCF, "Factors");
            appHelper.SetupLookUpRadiolist(rdoNegligent, "Negligent");

            if (iBE.status == "02")
            {
                pnl_PartC.Visible = true;

                pnl_PartC_2.Visible = true;
                pnl_PartC_3.Visible = true;
                pnl_PartC_4.Visible = true;
                pnl_PartC_5.Visible = true;
                pnl_PartC_6.Visible = true;
                pnl_PartC_7.Visible = true;

                btnSaveMC.Visible = false;
                pnlAddExtraMC.Visible = false;
                btnPartC.Visible = true;

                btnPartCSave.Visible = true;

                txtPartCAdditional_Comment.Text = string.Empty;
                DataSet uds = new DataSet();
                DataSet cwshods = new DataSet();
                DataSet cds = new DataSet();

                uds = uBC.GetEmployeeInfoByEmployeeNo(userLogin.UserId);
                cwshods = uBC.get_c_wsho_by_sbu(sba_code, sbu_code, department_code, location_code);

                lblPartCName.Text = uds.Tables[0].Rows[0]["empname"].ToString();
                lblPartCEMPID.Text = userLogin.UserId;
                lblPartCDesignation.Text = uds.Tables[0].Rows[0]["empdesignation"].ToString();
                lblPartCSubmissionDate.Text = DateTime.Now.ToString("dd-MMM-yyyy");

                appHelper.BindCodeToListControl(ddlPartC_CWSHOID, cwshods, "empname", "empid", string.Empty);

                ddlInjuredpersonPartC_3.Items.Clear();
                ddlInjuredpersonPartC_3.DataSource = ids.Tables[2];
                ddlInjuredpersonPartC_3.DataTextField = "InjuredPerson_name";
                ddlInjuredpersonPartC_3.DataValueField = "InjuredPerson_EmpNo";
                ddlInjuredpersonPartC_3.DataBind();

                ddlInjuredpersonPartC_4.Items.Clear();
                ddlInjuredpersonPartC_4.DataSource = ids.Tables[2];
                ddlInjuredpersonPartC_4.DataTextField = "InjuredPerson_name";
                ddlInjuredpersonPartC_4.DataValueField = "InjuredPerson_EmpNo";
                ddlInjuredpersonPartC_4.DataBind();

                set_partc_table();
            }
            else if (istatus == 8 && vds.Tables[0].Rows.Count > 0)
            {

                DataSet copytods = iBC.get_emaillist_MCChange(incidentid, userLogin.UserId);
                appHelper.BindCheckBoxList(chkPartCExtraMCEmailTo, copytods, "empname", "empid");

                foreach (ListItem li in chkPartCExtraMCEmailTo.Items)
                {
                    li.Selected = true;
                }

                pnlAddExtraMC.Visible = true;
                btnSaveMC.Visible = true;

                pnl_PartC.Enabled = true;
                pnl_PartC_4.Visible = true;
                pnl_PartC_4.Enabled = true;

                pnl_PartC_2.Enabled = false;
                pnl_PartC_3.Enabled = false;
                pnl_PartC_5.Enabled = false;
                pnl_PartC_6.Enabled = false;
                pnl_PartC_7.Enabled = false;

                pnl_PartC.Visible = true;

                pnl_PartC_2.Visible = true;
                pnl_PartC_3.Visible = true;
                pnl_PartC_4.Visible = true;
                pnl_PartC_5.Visible = true;
                pnl_PartC_6.Visible = true;
                pnl_PartC_7.Visible = true;

                btnPartC.Visible = false;
                btnPartCClose.Visible = false;
                btnPartCSave.Visible = false;

                txtPartCAdditional_Comment.Text = string.Empty;
                DataSet uds = new DataSet();
                DataSet cwshods = new DataSet();
                DataSet cds = new DataSet();

                uds = uBC.GetEmployeeInfoByEmployeeNo(userLogin.UserId);
                cwshods = uBC.get_c_wsho_by_sbu(sba_code, sbu_code, department_code, location_code);

                lblPartCName.Text = uds.Tables[0].Rows[0]["empname"].ToString();
                lblPartCEMPID.Text = userLogin.UserId;
                lblPartCDesignation.Text = uds.Tables[0].Rows[0]["empdesignation"].ToString();
                lblPartCSubmissionDate.Text = DateTime.Now.ToString("dd-MMM-yyyy");

                appHelper.BindCodeToListControl(ddlPartC_CWSHOID, cwshods, "empname", "empid", string.Empty);

                ddlInjuredpersonPartC_3.Items.Clear();
                ddlInjuredpersonPartC_3.DataSource = ids.Tables[2];
                ddlInjuredpersonPartC_3.DataTextField = "InjuredPerson_name";
                ddlInjuredpersonPartC_3.DataValueField = "InjuredPerson_EmpNo";
                ddlInjuredpersonPartC_3.DataBind();

                ddlInjuredpersonPartC_4.Items.Clear();
                ddlInjuredpersonPartC_4.DataSource = ids.Tables[2];
                ddlInjuredpersonPartC_4.DataTextField = "InjuredPerson_name";
                ddlInjuredpersonPartC_4.DataValueField = "InjuredPerson_EmpNo";
                ddlInjuredpersonPartC_4.DataBind();
                set_partc_table();
            }
            else if (istatus < 8 && vds.Tables[0].Rows.Count > 0)
            {
                ddlInjuredpersonPartC_3.Items.Clear();
                ddlInjuredpersonPartC_3.DataSource = ids.Tables[2];
                ddlInjuredpersonPartC_3.DataTextField = "InjuredPerson_name";
                ddlInjuredpersonPartC_3.DataValueField = "InjuredPerson_EmpNo";
                ddlInjuredpersonPartC_3.DataBind();

                ddlInjuredpersonPartC_4.Items.Clear();
                ddlInjuredpersonPartC_4.DataSource = ids.Tables[2];
                ddlInjuredpersonPartC_4.DataTextField = "InjuredPerson_name";
                ddlInjuredpersonPartC_4.DataValueField = "InjuredPerson_EmpNo";
                ddlInjuredpersonPartC_4.DataBind();

                DataSet uds = new DataSet();
                DataSet cwshods = new DataSet();
                DataSet cds = new DataSet();

                uds = uBC.GetEmployeeInfoByEmployeeNo(userLogin.UserId);
                cwshods = uBC.get_c_wsho_by_sbu(sba_code, sbu_code, department_code, location_code);

                lblPartCName.Text = uds.Tables[0].Rows[0]["empname"].ToString();
                lblPartCEMPID.Text = userLogin.UserId;
                lblPartCDesignation.Text = uds.Tables[0].Rows[0]["empdesignation"].ToString();
                lblPartCSubmissionDate.Text = DateTime.Now.ToString("dd-MMM-yyyy");

                appHelper.BindCodeToListControl(ddlPartC_CWSHOID, cwshods, "empname", "empid", string.Empty);

                ddlPartC_CWSHOID.SelectedValue = iBE.cwsho_id;

                if (iBE.cwsho_id != "" && iBE.cwsho_id != null && ddlPartC_CWSHOID.SelectedValue != iBE.cwsho_id) 
                {
                    DataSet dsUserInfo = GetUserInfoByUserID(iBE.cwsho_id); 
                    AddItemIntoDropDownList(ddlPartC_CWSHOID, dsUserInfo.Tables[0].Rows[0]["UserIDName"].ToString(), iBE.cwsho_id);
                    ddlPartC_CWSHOID.SelectedValue = iBE.cwsho_id;
                }

                pnl_PartC.Visible = true;

                pnl_PartC_2.Visible = true;
                pnl_PartC_3.Visible = true;
                pnl_PartC_4.Visible = true;
                pnl_PartC_5.Visible = true;
                pnl_PartC_6.Visible = true;
                pnl_PartC_7.Visible = true;

                set_partc_table(); 

                btnSaveMC.Visible = false;
                pnlAddExtraMC.Visible = false;
            }

            else
            {

                DataSet uds = new DataSet();
                DataSet cwshods = new DataSet();
                DataSet cds = new DataSet();

                uds = uBC.GetEmployeeInfoByEmployeeNo(userLogin.UserId);
                cwshods = uBC.get_c_wsho_by_sbu(sba_code, sbu_code, department_code, location_code);

                lblPartCName.Text = uds.Tables[0].Rows[0]["empname"].ToString();
                lblPartCEMPID.Text = userLogin.UserId;
                lblPartCDesignation.Text = uds.Tables[0].Rows[0]["empdesignation"].ToString();
                lblPartCSubmissionDate.Text = DateTime.Now.ToString("dd-MMM-yyyy");

                appHelper.BindCodeToListControl(ddlPartC_CWSHOID, cwshods, "empname", "empid", string.Empty);
                ddlPartC_CWSHOID.SelectedValue = iBE.cwsho_id;

                pnl_PartC.Visible = true;

                pnl_PartC_2.Visible = true;
                pnl_PartC_3.Visible = true;
                pnl_PartC_4.Visible = true;
                pnl_PartC_5.Visible = true;
                pnl_PartC_6.Visible = true;
                pnl_PartC_7.Visible = true;

                set_partc_table(); 

                btnSaveMC.Visible = false;
                pnlAddExtraMC.Visible = false;
            }
        }

        private void set_partc_table()
        {
            try
            {
                string errorCode = string.Empty;
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                WorkflowIncidentBE ibe = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");

                DataSet ivds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_PersonInterviewed");

                DataTable ivDT = new DataTable
                {

                    TableName = "PersonInterviewed"
                };
                ivDT.Columns.Add(new DataColumn("empid", typeof(string)));
                ivDT.Columns.Add(new DataColumn("empname", typeof(string)));
                ivDT.Columns.Add(new DataColumn("empdesignation", typeof(string)));
                ivDT.Columns.Add(new DataColumn("empcontactno", typeof(string)));
                ivDT.Columns.Add(new DataColumn("remarks", typeof(string)));

                ivDT.Rows.Clear();

                DataSet partcds = new DataSet();
                partcds = ibc.get_incident_partc_id(ibe);

                if (ivds.Tables.Count > 0 && partcds.Tables[0].Rows.Count > 0)
                {
                    ivDT = partcds.Tables[0];
                }
                if (ivds.Tables[0].Rows.Count > 0)
                {
                    for (int i = 0; i < partcds.Tables[0].Rows.Count; i++)
                    {
                        DataRow dr = partcds.Tables[0].Rows[i];
                        ivDT.Rows.Add(dr.ItemArray);
                        partcds.Tables[0].Rows.Remove(dr);
                    }
                }
                ivds.Tables.Clear();
                ivds.Tables.Add(ivDT.Copy());
                AppSession.SetSession("SESSION_LIST_PartC_PersonInterviewed", ivds);

                DataSet ireportds = new DataSet();
                DataTable ireportDT = new DataTable
                {
                    TableName = "ireport"
                };
                ireportDT.Columns.Add(new DataColumn("injured_name", typeof(string)));
                ireportDT.Columns.Add(new DataColumn("injured_emp_no", typeof(string)));
                ireportDT.Columns.Add(new DataColumn("fourth_day_mc_date", typeof(string)));
                ireportDT.Columns.Add(new DataColumn("ireport_no", typeof(string)));
                ireportDT.Columns.Add(new DataColumn("ireport_date", typeof(string)));

                if (partcds.Tables[1].Rows.Count > 0)
                {
                    for (int i = 0; i < partcds.Tables[1].Rows.Count; i++)
                    {
                        DataRow dr = partcds.Tables[1].Rows[i];
                        ireportDT.Rows.Add(dr.ItemArray);
                    }
                }

                ireportds.Tables.Clear();
                ireportds.Tables.Add(ireportDT.Copy());
                AppSession.SetSession("SESSION_LIST_ireport", ireportds);

                lst_ireport.DataSource = ireportds;
                lst_ireport.DataBind();

                DataSet ipds = ibc.get_incidents_attachedfiles_by_id(ibe.incident_id, "part-c-ip-attach-doc", string.Empty);
                attachmentdataBind(ipds.Tables[0], lstPartCIPAttach, "SESSION_LIST_CIP_ATTACHMENTS");
                DataSet ipsds = ibc.get_incidents_attachedfiles_by_id(ibe.incident_id, "part-c-wsho-s-attach-doc", string.Empty);
                attachmentdataBind(ipsds.Tables[0], lstPartCIPSAttach, "SESSION_LIST_CIPS_ATTACHMENTS");
                DataSet ccpds = ibc.get_incidents_attachedfiles_by_id(ibe.incident_id, "part-c-cp-attach-doc", string.Empty);
                attachmentdataBind(ccpds.Tables[0], lstPartCCPAttach, "SESSION_LIST_CCP_ATTACHMENTS");
                DataSet CIJPds = ibc.get_incidents_attachedfiles_by_id(ibe.incident_id, "part-c-ijp-attach-doc", string.Empty);
                attachmentdataBind(CIJPds.Tables[0], lstPartCIJPAttach, "SESSION_LIST_CIJP_ATTACHMENTS");
                DataSet CIJMCds = ibc.get_incidents_attachedfiles_by_id(ibe.incident_id, "part-c-ijmr-attach-doc", string.Empty);
                attachmentdataBind(CIJMCds.Tables[0], lstPartCIJMCAttach, "SESSION_LIST_CIJMC_ATTACHMENTS");

                lstViewPartC_PersonInterviewed.DataSource = ivds;
                lstViewPartC_PersonInterviewed.DataBind();

                DataSet idds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_3InjuredDetails");
                DataSet mcds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_4_MC");

                DataTable injureddetailsDT = new DataTable();
                DataTable injureddetailsDisplayDT = new DataTable();
                DataTable mcdt = new DataTable();

                injureddetailsDisplayDT.TableName = "injured_details_display";
                injureddetailsDisplayDT.Columns.Add(new DataColumn("incident_id", typeof(string)));
                injureddetailsDisplayDT.Columns.Add(new DataColumn("injured_id", typeof(string)));
                injureddetailsDisplayDT.Columns.Add(new DataColumn("empname", typeof(string)));
                injureddetailsDisplayDT.Columns.Add(new DataColumn("part_of_body_injured", typeof(string)));
                injureddetailsDisplayDT.Columns.Add(new DataColumn("nature_injury", typeof(string)));
                injureddetailsDisplayDT.Columns.Add(new DataColumn("injured_description", typeof(string)));
                injureddetailsDisplayDT.Columns.Add(new DataColumn("attach_statement", typeof(string)));
                injureddetailsDisplayDT.Columns.Add(new DataColumn("head_neck_torso", typeof(string)));
                injureddetailsDisplayDT.Columns.Add(new DataColumn("upper_limbs", typeof(string)));
                injureddetailsDisplayDT.Columns.Add(new DataColumn("lower_limps", typeof(string)));

                injureddetailsDT.TableName = "injured_details";
                injureddetailsDT.Columns.Add(new DataColumn("incident_id", typeof(string)));
                injureddetailsDT.Columns.Add(new DataColumn("injured_id", typeof(string)));
                injureddetailsDT.Columns.Add(new DataColumn("injury_type", typeof(string)));
                injureddetailsDT.Columns.Add(new DataColumn("injury_code", typeof(string)));
                injureddetailsDT.Columns.Add(new DataColumn("injury_name", typeof(string)));
                injureddetailsDT.Columns.Add(new DataColumn("other_desc", typeof(string)));

                mcdt.TableName = "injured_mc";
                mcdt.Columns.Add(new DataColumn("incident_id", typeof(string)));
                mcdt.Columns.Add(new DataColumn("injured_id", typeof(string)));
                mcdt.Columns.Add(new DataColumn("injured_name", typeof(string)));
                mcdt.Columns.Add(new DataColumn("hospital_clinic_name", typeof(string)));
                mcdt.Columns.Add(new DataColumn("from_date", typeof(string)));
                mcdt.Columns.Add(new DataColumn("to_date", typeof(string)));
                mcdt.Columns.Add(new DataColumn("no_days", typeof(string)));
                mcdt.Columns.Add(new DataColumn("morethan24hrs", typeof(string)));
                mcdt.Columns.Add(new DataColumn("morethan24hrs_text", typeof(string)));
                mcdt.Columns.Add(new DataColumn("attachment", typeof(string)));

                injureddetailsDisplayDT.Rows.Clear();
                injureddetailsDT.Rows.Clear();
                mcdt.Rows.Clear();

                DataTable ipdt = new DataTable();
                ipdt = partcds.Tables[1];

                foreach (DataRow iprow in ipdt.Rows)
                {
                    string emp_no = iprow["injured_emp_no"].ToString();
                    DataSet idecds = new DataSet();
                    idecds.Tables.Clear();
                    idecds = ibc.get_injured_person_injury_description(ibe.incident_id, emp_no);
                    if (idecds.Tables[5].Rows.Count > 0)
                    {

                        for (int i = 0; i < idecds.Tables[5].Rows.Count; i++)
                        {
                            DataRow dr = idecds.Tables[5].Rows[i];
                            injureddetailsDisplayDT.Rows.Add(dr.ItemArray);
                        }
                    }

                    if (idecds.Tables[1].Rows.Count > 0)
                    {
                        for (int i = 0; i < idecds.Tables[1].Rows.Count; i++)
                        {
                            DataRow dr = idecds.Tables[1].Rows[i];
                            injureddetailsDT.Rows.Add(dr.ItemArray);
                        }
                    }

                    idds.Tables.Clear();
                    idds.Tables.Add(injureddetailsDisplayDT.Copy());
                    idds.Tables.Add(injureddetailsDT.Copy());
                    AppSession.SetSession("SESSION_LIST_PartC_3InjuredDetails", idds);

                    if (idecds.Tables[3].Rows.Count > 0)
                    {
                        for (int i = 0; i < idecds.Tables[3].Rows.Count; i++)
                        {
                            DataRow dr = idecds.Tables[3].Rows[i];
                            mcdt.Rows.Add(dr.ItemArray);
                            mcdt.Rows[i]["from_date"] = Convert.ToDateTime(mcdt.Rows[i]["from_date"]).ToString("dd-MMM-yyyy");
                            mcdt.Rows[i]["to_date"] = Convert.ToDateTime(mcdt.Rows[i]["to_date"]).ToString("dd-MMM-yyyy");

                        }
                    }

                    mcds.Tables.Clear();
                    mcds.Tables.Add(mcdt.Copy());
                    AppSession.SetSession("SESSION_LIST_PartC_4_MC", mcds);

                    lstViewPartC_3InjuredPersonDetails.DataSource = injureddetailsDisplayDT;
                    lstViewPartC_3InjuredPersonDetails.DataBind();

                    lstViewPartC_4ML.DataSource = mcds.Tables[0];
                    lstViewPartC_4ML.DataBind();
                }
                if (partcds.Tables[3].Rows.Count > 0)
                {

                    for (int i = 0; i < chkIncidentClass.Items.Count; i++)
                    {
                        DataRow[] result = partcds.Tables[3].Select("lookup_type = 'Incident Class'");
                        foreach (DataRow row in result)
                        {
                            if (row["lookup_code"].ToString().Equals(chkIncidentClass.Items[i].Value))
                            {
                                chkIncidentClass.Items[i].Selected = true;
                                if (row["lookup_code"].ToString() == "99")
                                {
                                    txtclassincOTH.Enabled = true;
                                    txtclassincOTH.Text = row["other_desc"].ToString().Trim();
                                }
                            }
                        }
                    }

                    for (int i = 0; i < chkIncidentAgent.Items.Count; i++)
                    {
                        DataRow[] result = partcds.Tables[3].Select("lookup_type = 'Incident Agent'");
                        foreach (DataRow row in result)
                        {
                            if (row["lookup_code"].ToString().Equals(chkIncidentAgent.Items[i].Value))
                            {
                                chkIncidentAgent.Items[i].Selected = true;
                                if (row["lookup_code"].ToString() == "99")
                                {
                                    txtAgentOTH.Enabled = true;
                                    txtAgentOTH.Text = row["other_desc"].ToString().Trim();
                                }
                            }
                        }
                    }

                    for (int i = 0; i < chkUC.Items.Count; i++)
                    {
                        DataRow[] result = partcds.Tables[3].Select("lookup_type = 'Unsafe Condition'");
                        foreach (DataRow row in result)
                        {
                            if (row["lookup_code"].ToString().Equals(chkUC.Items[i].Value))
                            {
                                chkUC.Items[i].Selected = true;
                                if (row["lookup_code"].ToString() == "99")
                                {
                                    txtUCOTH.Enabled = true;
                                    txtUCOTH.Text = row["other_desc"].ToString().Trim();
                                }
                            }
                        }
                    }

                    for (int i = 0; i < chkUA.Items.Count; i++)
                    {
                        DataRow[] result = partcds.Tables[3].Select("lookup_type = 'Unsafe Act'");
                        foreach (DataRow row in result)
                        {
                            if (row["lookup_code"].ToString().Equals(chkUA.Items[i].Value))
                            {
                                chkUA.Items[i].Selected = true;
                                if (row["lookup_code"].ToString() == "99")
                                {
                                    txtUAOTH.Enabled = true;
                                    txtUAOTH.Text = row["other_desc"].ToString().Trim();
                                }
                            }
                        }
                    }

                    for (int i = 0; i < chkCF.Items.Count; i++)
                    {
                        DataRow[] result = partcds.Tables[3].Select("lookup_type = 'Factors'");
                        foreach (DataRow row in result)
                        {
                            if (row["lookup_code"].ToString().Equals(chkCF.Items[i].Value))
                            {
                                chkCF.Items[i].Selected = true;
                                if (row["lookup_code"].ToString() == "99")
                                {
                                    txtCFOTH.Enabled = true;
                                    txtCFOTH.Text = row["other_desc"].ToString().Trim();
                                }
                            }
                        }
                    }
                }
                txtPartC_WhatandWhy.Text = ibe.what_happened_and_why_comments;
                txtManCorrectiveandPreventiveAction.Text = ibe.recommend_action_desc;
                rdoNegligent.SelectedValue = ibe.negligent;
                txtPartCAdditional_Comment.Text = ibe.negligent_comments;

            }
            catch (Exception ex)
            {
                baseHelper.PopUpClosingWindow(Page, "Error", ex.Message);
            }
        }

        protected void imgBtnAttPartCIP_Click(object sender, ImageClickEventArgs e)
        {
            string errorCode = string.Empty;
            try
            {

                if (uploadAttPartCIP.HasFile.Equals(false))
                {

                    errorCode = "ERR-066";
                    baseHelper.popUpMessageSetfocus(imgBtnAttPartCIP, "Error", errorCode, "2", uploadAttPartCIP.ClientID);
                }
                else
                {
                    foreach (HttpPostedFile uploadedFile in uploadAttPartCIP.PostedFiles)
                    {

                        string fileExtension = Path.GetExtension(uploadedFile.FileName);

                        bool isValidFileExtension = appHelper.IsValidFileExtension(fileExtension.Replace('.', ' ').Trim());
                        if (isValidFileExtension == false)
                        {
                            errorCode = "ERR-067";
                            baseHelper.popUpMessageSetfocus(imgBtnAttPartCIP, "Error", errorCode, "2", uploadAttPartCIP.ClientID);
                        }
                        else
                        {

                            double DOmaxByteSize = appHelper.MegabytesToBytes(Convert.ToInt32(ConfigurationManager.AppSettings["CertiMaxFileSize_MB"].ToString()));

                            if (uploadAttPartCIP.PostedFile.ContentLength > DOmaxByteSize)
                            {
                                string message = string.Format("Your attachment has exceeded the limit of {0}MB. Please scan your document at 300dpi or lower.", ConfigurationManager.AppSettings["DOMaxFileSize_MB"].ToString());
                                string htmlTags = string.Format("javascript:popUpMessageSetfocus('{0}','{1}','{2}','{3}');", "Error", message, 2, uploadAttPartCIP.ClientID);
                                ScriptManager.RegisterStartupScript(imgBtnAttPartCIP, this.GetType(), "popUpMessageSetfocusScript", htmlTags, true);
                            }
                            else
                            {

                                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();

                                WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                                string incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks;

                                incident_id = iBE.incident_id;
                                attachment_type = "part-c-ip-attach-doc";
                                reference_code = string.Empty;
                                file_extension = Path.GetExtension(uploadedFile.FileName);
                                file_id = Guid.NewGuid().ToString() + file_extension;
                                file_name = incident_id + "-C-IV-" + txtPartC_PersonInterviewedID.Text + "-" + Path.GetFileName(uploadedFile.FileName);
                                file_path = Server.MapPath(tempFolderPath);
                                file_desc = string.Empty;
                                remarks = string.Empty;

                                uploadedFile.SaveAs(Server.MapPath(tempFolderPath + file_name));

                                set_attach_docs("SESSION_LIST_CIP_ATTACHMENTS", incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks, lstPartCIPAttach);
                            }
                        }
                    }
                }

                hdncurrenttab.Value = "2"; 
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(imgBtnAttPartCIP, "Error", ex.Message);
            }
        }

        protected void lstPartCIPAttach_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstPartCIPAttach, "SESSION_LIST_CIP_ATTACHMENTS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartCIPAttach, "Error", ex.Message);
            }
        }

        protected void lstPartCIPAttach_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                hdncurrenttab.Value = "2";
                ListViewDataItem li = lstPartCIPAttach.Items[e.ItemIndex];
                LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");
                string filename = @lnkatt.Text;

                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);
                string pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {
                    File.Delete(filepath);
                }
                else if (File.Exists(pfilepath))
                {
                    File.Delete(pfilepath);
                }

                string errorCode = string.Empty;
                ErrorMessageBC errbc = new ErrorMessageBC();
                HiddenField hdnfileid = (HiddenField)li.FindControl("hdnfileid");
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                ibc.update_incidents_attachfiles(hdnfileid.Value, userLogin.UserId, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    string errStr = string.Empty;
                    errbc.GetErrorMessage(errorCode, out errStr);
                }

                appHelper.DeleteListViewItem(lstPartCIPAttach, e.ItemIndex, "SESSION_LIST_CIP_ATTACHMENTS");
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartCIPAttach, "Error", ex.Message);
            }
        }

        protected void imgBtnAttPartCIPS_Click(object sender, ImageClickEventArgs e)
        {
            string errorCode = string.Empty;
            try
            {

                if (uploadAttPartCIPS.HasFile.Equals(false))
                {

                    errorCode = "ERR-066";
                    baseHelper.popUpMessageSetfocus(imgBtnAttPartCIPS, "Error", errorCode, "2", uploadAttPartCIPS.ClientID);
                }
                else
                {
                    foreach (HttpPostedFile uploadedFile in uploadAttPartCIPS.PostedFiles)
                    {

                        string fileExtension = Path.GetExtension(uploadedFile.FileName);

                        bool isValidFileExtension = appHelper.IsValidFileExtension(fileExtension.Replace('.', ' ').Trim());
                        if (isValidFileExtension == false)
                        {
                            errorCode = "ERR-067";
                            baseHelper.popUpMessageSetfocus(imgBtnAttPartCIPS, "Error", errorCode, "2", uploadAttPartCIPS.ClientID);
                        }
                        else
                        {

                            double DOmaxByteSize = appHelper.MegabytesToBytes(Convert.ToInt32(ConfigurationManager.AppSettings["CertiMaxFileSize_MB"].ToString()));

                            if (uploadAttPartCIPS.PostedFile.ContentLength > DOmaxByteSize)
                            {
                                string message = string.Format("Your attachment has exceeded the limit of {0}MB. Please scan your document at 300dpi or lower.", ConfigurationManager.AppSettings["DOMaxFileSize_MB"].ToString());
                                string htmlTags = string.Format("javascript:popUpMessageSetfocus('{0}','{1}','{2}','{3}');", "Error", message, 2, uploadAttPartCIPS.ClientID);
                                ScriptManager.RegisterStartupScript(imgBtnAttPartCIPS, this.GetType(), "popUpMessageSetfocusScript", htmlTags, true);
                            }
                            else
                            {

                                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();

                                WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                                string incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks;

                                incident_id = iBE.incident_id;
                                attachment_type = "part-c-wsho-s-attach-doc";
                                reference_code = string.Empty;
                                file_extension = Path.GetExtension(uploadedFile.FileName);
                                file_id = Guid.NewGuid().ToString() + file_extension;

                                file_name = incident_id + "-C-WSHO-S-" + Path.GetFileName(uploadedFile.FileName);
                                file_path = Server.MapPath(tempFolderPath);
                                file_desc = string.Empty;
                                remarks = string.Empty;

                                uploadedFile.SaveAs(Server.MapPath(tempFolderPath + file_name));

                                set_attach_docs("SESSION_LIST_CIPS_ATTACHMENTS", incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks, lstPartCIPSAttach);
                            }
                        }
                    }
                }

                hdncurrenttab.Value = "2"; 
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(imgBtnAttPartCIPS, "Error", ex.Message);
            }
        }

        protected void btnAddPartC_PersonInterviewed_Click(object sender, EventArgs e)
        {
            try
            {
                bool errorFlag = false;
                string errorCode = string.Empty;
                WorkflowIncidentBE incidentBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                Dictionary<string, string> colItems = new Dictionary<string, string>()
                    {
                        {"empid", txtPartC_PersonInterviewedID.Text},
                        {"empname", txtPartC_PersonInterviewedName.Text},
                        {"empdesignation", txtPartC_PersonInterviewedDesignation.Text},
                        {"empcontactno", txtPartC_PersonInterviewedContactNo.Text},
                        {"remarks", string.Empty}

                     };

                if (string.IsNullOrEmpty(txtPartC_PersonInterviewedName.Text) && errorFlag.Equals(false))
                {
                    errorFlag = true;
                    errorCode = "ERR-014";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtPartC_PersonInterviewedName.ClientID);
                }

                if (string.IsNullOrEmpty(txtPartC_PersonInterviewedID.Text) && errorFlag.Equals(false))
                {
                    errorFlag = true;
                    errorCode = "ERR-017";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtPartC_PersonInterviewedID.ClientID);
                }

                if (errorFlag.Equals(false))
                {
                    txtPartC_PersonInterviewedName.Text = string.Empty;
                    txtPartC_PersonInterviewedID.Text = string.Empty;
                    txtPartC_PersonInterviewedDesignation.Text = string.Empty;
                    txtPartC_PersonInterviewedContactNo.Text = string.Empty;

                    appHelper.AddListViewItem(lstViewPartC_PersonInterviewed, colItems, "SESSION_LIST_PartC_PersonInterviewed");
                }

                hdncurrenttab.Value = "2"; 

            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstViewPartC_PersonInterviewed, "Error", ex.Message);
            }
        }

        protected void lstViewPartC_PersonInterviewed_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstViewPartC_PersonInterviewed, "SESSION_LIST_PartC_PersonInterviewed");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstViewPartC_PersonInterviewed, "Error", ex.Message);
            }
        }

        protected void lstViewPartC_PersonInterviewed_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                hdncurrenttab.Value = "2";
                appHelper.DeleteListViewItem(lstViewPartC_PersonInterviewed, e.ItemIndex, "SESSION_LIST_PartC_PersonInterviewed");
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstViewPartC_PersonInterviewed, "Error", ex.Message);
            }
        }

        protected void chkHead_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                foreach (ListItem li in chkHead.Items)
                {
                    if (li.Selected)
                    {
                        head_neck_torso.Add(li.Value);
                    }
                }
                ViewState["head_neck_torso"] = head_neck_torso;
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(chkHead, "Error", ex.Message);
            }
        }

        protected void chkUpper_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                foreach (ListItem li in chkUpper.Items)
                {
                    if (li.Selected)
                    {
                        upper_limbs.Add(li.Value);
                    }
                }
                ViewState["upper_limbs"] = upper_limbs;
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(chkUpper, "Error", ex.Message);
            }
        }

        protected void chkLower_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                foreach (ListItem li in chkLower.Items)
                {
                    if (li.Selected)
                    {
                        lower_limbs.Add(li.Value);
                    }
                }
                ViewState["lower_limbs"] = lower_limbs;
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(chkLower, "Error", ex.Message);
            }
        }

        protected void chkUC_SelectedIndexChanged(object sender, EventArgs e)
        {
            bool isOther = false;
            try
            {
                foreach (ListItem li in chkUC.Items)
                {
                    if (li.Selected)
                    {
                        if (li.Value == "99")
                        {
                            isOther = true;
                        }
                    }
                }
                if (isOther == true)
                {
                    txtUCOTH.Enabled = true;

                }
                else
                {
                    txtUCOTH.Enabled = false;
                    txtUCOTH.Text = string.Empty;

                }

            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(chkUC, "Error", ex.Message);
            }
        }

        protected void chkUA_SelectedIndexChanged(object sender, EventArgs e)
        {
            bool isOther = false;
            try
            {
                foreach (ListItem li in chkUA.Items)
                {
                    if (li.Selected)
                    {
                        if (li.Value == "99")
                        {
                            isOther = true;
                        }
                    }
                }
                if (isOther == true)
                {
                    txtUAOTH.Enabled = true;

                }
                else
                {
                    txtUAOTH.Enabled = false;
                    txtUAOTH.Text = string.Empty;

                }

            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(chkUC, "Error", ex.Message);
            }
        }

        protected void chkNatureInj_SelectedIndexChanged(object sender, EventArgs e)
        {
            bool isOther = false;
            try
            {
                foreach (ListItem li in chkNatureInj.Items)
                {
                    if (li.Selected)
                    {
                        if (li.Value == "99")
                        {
                            isOther = true;
                        }
                        nature_injuried.Add(li.Value);
                    }
                }
                if (isOther == true)
                {
                    txtNatureInjOth.Enabled = true;
                    lblManNatureOth.Visible = true;
                }
                else
                {
                    txtNatureInjOth.Enabled = false;
                    txtNatureInjOth.Text = string.Empty;
                    lblManNatureOth.Visible = false;
                }
                ViewState["nature_injuried"] = nature_injuried;
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(chkNatureInj, "Error", ex.Message);
            }
        }

        protected void imgBtnAttPartCIJP_Click(object sender, ImageClickEventArgs e)
        {
            string errorCode = string.Empty;
            try
            {

                if (uploadAttPartCIJP.HasFile.Equals(false))
                {

                    errorCode = "ERR-066";
                    baseHelper.popUpMessageSetfocus(imgBtnAttPartCIJP, "Error", errorCode, "2", uploadAttPartCIJP.ClientID);
                }
                else
                {
                    foreach (HttpPostedFile uploadedFile in uploadAttPartCIJP.PostedFiles)
                    {

                        string fileExtension = Path.GetExtension(uploadedFile.FileName);

                        bool isValidFileExtension = appHelper.IsValidFileExtension(fileExtension.Replace('.', ' ').Trim());
                        if (isValidFileExtension == false)
                        {
                            errorCode = "ERR-067";
                            baseHelper.popUpMessageSetfocus(imgBtnAttPartCIJP, "Error", errorCode, "2", uploadAttPartCIJP.ClientID);
                        }
                        else
                        {

                            double DOmaxByteSize = appHelper.MegabytesToBytes(Convert.ToInt32(ConfigurationManager.AppSettings["CertiMaxFileSize_MB"].ToString()));

                            if (uploadAttPartCIJP.PostedFile.ContentLength > DOmaxByteSize)
                            {
                                string message = string.Format("Your attachment has exceeded the limit of {0}MB. Please scan your document at 300dpi or lower.", ConfigurationManager.AppSettings["DOMaxFileSize_MB"].ToString());
                                string htmlTags = string.Format("javascript:popUpMessageSetfocus('{0}','{1}','{2}','{3}');", "Error", message, 2, uploadAttPartCIJP.ClientID);
                                ScriptManager.RegisterStartupScript(imgBtnAttPartCIJP, this.GetType(), "popUpMessageSetfocusScript", htmlTags, true);
                            }
                            else
                            {

                                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();

                                WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                                string incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks;

                                incident_id = iBE.incident_id;
                                attachment_type = "part-c-ijp-attach-doc";
                                reference_code = ddlInjuredpersonPartC_3.SelectedValue.ToString();
                                file_extension = Path.GetExtension(uploadedFile.FileName);
                                file_id = Guid.NewGuid().ToString() + file_extension;
                                file_name = incident_id + "-C-IJP-" + reference_code + "" + Path.GetFileName(uploadedFile.FileName);
                                file_path = Server.MapPath(tempFolderPath);
                                file_desc = string.Empty;
                                remarks = string.Empty;

                                uploadedFile.SaveAs(Server.MapPath(tempFolderPath + file_name));

                                set_attach_docs("SESSION_LIST_CIJP_ATTACHMENTS", incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks, lstPartCIJPAttach);
                            }
                        }
                    }
                }

                hdncurrenttab.Value = "2"; 
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(imgBtnAttPartCIJP, "Error", ex.Message);
            }
        }

        protected void lstPartCIJPAttach_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstPartCIJPAttach, "SESSION_LIST_CIJP_ATTACHMENTS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartCIJPAttach, "Error", ex.Message);
            }
        }

        protected void lstPartCIJPAttach_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                hdncurrenttab.Value = "2";
                ListViewDataItem li = lstPartCIJPAttach.Items[e.ItemIndex];
                LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");
                string filename = @lnkatt.Text;

                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);
                string pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {
                    File.Delete(filepath);
                }
                else if (File.Exists(pfilepath))
                {
                    File.Delete(pfilepath);
                }

                string errorCode = string.Empty;
                ErrorMessageBC errbc = new ErrorMessageBC();
                HiddenField hdnfileid = (HiddenField)li.FindControl("hdnfileid");
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                ibc.update_incidents_attachfiles(hdnfileid.Value, userLogin.UserId, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    string errStr = string.Empty;
                    errbc.GetErrorMessage(errorCode, out errStr);
                }

                appHelper.DeleteListViewItem(lstPartCIJPAttach, e.ItemIndex, "SESSION_LIST_CIJP_ATTACHMENTS");
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartCIJPAttach, "Error", ex.Message);
            }
        }

        protected void btnAddPartC_3InjuredPersonDetails_Click(object sender, EventArgs e)
        {
            try
            {
                string errorCode = string.Empty;
                bool errorFlag = false;

                if (ddlIncidentType.SelectedValue == "1")
                {

                    string name = !string.IsNullOrEmpty(ddlInjuredpersonPartC_3.SelectedValue) ? ddlInjuredpersonPartC_3.SelectedItem.Text : string.Empty;
                    if (string.IsNullOrEmpty(name.Trim()))
                    {
                        errorFlag = true;
                        errorCode = "ERR-014";
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", ddlInjuredpersonPartC_3.ClientID);
                    }

                    if (string.IsNullOrEmpty(txtInjuredDescription.Text) && errorFlag.Equals(false))
                    {
                        errorFlag = true;
                        errorCode = "ERR-136";
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtInjuredDescription.ClientID);
                    }

                    if (chkVIncidentType.SelectedValue.Equals("1") && errorFlag.Equals(false))
                    {
                        int count = 0;
                        foreach (ListItem li in chkHead.Items)
                        {
                            if (li.Selected)
                            {
                                count++;
                            }
                        }

                        foreach (ListItem li in chkUpper.Items)
                        {
                            if (li.Selected)
                            {
                                count++;
                            }
                        }

                        foreach (ListItem li in chkLower.Items)
                        {
                            if (li.Selected)
                            {
                                count++;
                            }
                        }

                        if (count == 0 && errorFlag.Equals(false))
                        {
                            errorCode = "ERR-029";
                            errorFlag = true;
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", chkHead.ClientID);
                        }
                    }

                    if (errorFlag.Equals(false))
                    {
                        int count = 0;
                        foreach (ListItem li in chkNatureInj.Items)
                        {
                            if (li.Selected)
                            {
                                count++;
                                if (li.Value == "99" && string.IsNullOrEmpty(txtNatureInjOth.Text))
                                {
                                    errorCode = "ERR-062";
                                    errorFlag = true;
                                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtNatureInjOth.ClientID);
                                }
                            }
                        }
                        if (count == 0 && errorFlag.Equals(false))
                        {
                            errorCode = "ERR-030";
                            errorFlag = true;
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", chkNatureInj.ClientID);
                        }
                    }
                }

                if (errorFlag.Equals(false))
                {
                    setPartC_3InjuredPersonIncidentInfo();
                }

                hdncurrenttab.Value = "2"; 
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(btnAddPartC_3InjuredPersonDetails, "Error", ex.Message);
            }
        }

        private void setPartC_3InjuredPersonIncidentInfo()
        {
            try
            {
                WorkflowIncidentBE incidentBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                DataSet ds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_3InjuredDetails");

                DataTable injureddetailsDT = new DataTable();
                DataTable injureddetailsDisplayDT = new DataTable();

                if (ds.Tables.Count > 1)
                {
                    injureddetailsDT = ds.Tables[1];
                    injureddetailsDisplayDT = ds.Tables[0];
                }
                else
                {
                    injureddetailsDisplayDT.TableName = "injured_details_display";
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("incident_id", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("injured_id", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("empname", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("part_of_body_injured", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("nature_injury", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("injured_description", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("attach_statement", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("head_neck_torso", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("upper_limbs", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("lower_limps", typeof(string)));

                    injureddetailsDT.TableName = "injured_details";
                    injureddetailsDT.Columns.Add(new DataColumn("incident_id", typeof(string)));
                    injureddetailsDT.Columns.Add(new DataColumn("injured_id", typeof(string)));
                    injureddetailsDT.Columns.Add(new DataColumn("injury_type", typeof(string)));
                    injureddetailsDT.Columns.Add(new DataColumn("injury_code", typeof(string)));
                    injureddetailsDT.Columns.Add(new DataColumn("injury_name", typeof(string)));
                    injureddetailsDT.Columns.Add(new DataColumn("other_desc", typeof(string)));
                }

                string part_of_body_injured, strchkHead, strchkUpper, strchkLower, nature_of_injury;

                part_of_body_injured = string.Empty; 
                strchkHead = string.Empty;
                strchkUpper = string.Empty;
                strchkLower = string.Empty;

                nature_of_injury = string.Empty;

                DataRow ddr = null;
                ddr = injureddetailsDisplayDT.NewRow();
                ddr["incident_id"] = incidentBE.incident_id;
                ddr["injured_id"] = ddlInjuredpersonPartC_3.SelectedValue.Trim();
                ddr["empname"] = !string.IsNullOrEmpty(ddlInjuredpersonPartC_3.SelectedValue.Trim()) ? ddlInjuredpersonPartC_3.SelectedItem.Text : string.Empty;
                ddr["injured_description"] = txtInjuredDescription.Text.Trim();

                foreach (ListItem li in chkHead.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = injureddetailsDT.NewRow();
                        dr["incident_id"] = incidentBE.incident_id;
                        dr["injured_id"] = !string.IsNullOrEmpty(ddlInjuredpersonPartC_3.SelectedValue.Trim()) ? ddlInjuredpersonPartC_3.SelectedValue.Trim() : string.Empty;
                        dr["injury_type"] = "Head Neck Torso";
                        dr["injury_code"] = li.Value;
                        dr["injury_name"] = li.Text;
                        dr["other_desc"] = string.Empty;
                        injureddetailsDT.Rows.Add(dr);
                        if (strchkHead == string.Empty)
                        {
                            strchkHead = "<ul> Head Neck Torso ";
                        }
                        strchkHead = strchkHead + "<li>" + li.Text + " </li> ";
                    }
                }
                if (strchkHead != string.Empty)
                {
                    strchkHead = strchkHead + "</ul>";
                }
                foreach (ListItem li in chkUpper.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = injureddetailsDT.NewRow();
                        dr["incident_id"] = incidentBE.incident_id;

                        dr["injured_id"] = !string.IsNullOrEmpty(ddlInjuredpersonPartC_3.SelectedValue.Trim()) ? ddlInjuredpersonPartC_3.SelectedValue.Trim() : string.Empty;
                        dr["injury_type"] = "Upper Limbs";
                        dr["injury_code"] = li.Value;
                        dr["injury_name"] = li.Text;
                        dr["other_desc"] = string.Empty;
                        injureddetailsDT.Rows.Add(dr);
                        if (strchkUpper == string.Empty)
                        {
                            strchkUpper = "<ul> Upper Limbs ";
                        }
                        strchkUpper = strchkUpper + "<li>" + li.Text + " </li> ";
                    }
                }

                if (strchkUpper != string.Empty)
                {
                    strchkUpper = strchkUpper + "</ul>";
                }

                foreach (ListItem li in chkLower.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = injureddetailsDT.NewRow();
                        dr["incident_id"] = incidentBE.incident_id;
                        dr["injured_id"] = !string.IsNullOrEmpty(ddlInjuredpersonPartC_3.SelectedValue.Trim()) ? ddlInjuredpersonPartC_3.SelectedValue.Trim() : string.Empty;
                        dr["injury_type"] = "Lower Limbs";
                        dr["injury_code"] = li.Value;
                        dr["injury_name"] = li.Text;
                        dr["other_desc"] = string.Empty;
                        injureddetailsDT.Rows.Add(dr);

                        if (strchkLower == string.Empty)
                        {
                            strchkLower = "<ul> Lower Limbs";
                        }
                        strchkLower = strchkLower + "<li>" + li.Text + " </li> ";
                    }
                }

                if (strchkLower != string.Empty)
                {
                    strchkLower = strchkLower + "</ul>";
                }

                foreach (ListItem li in chkNatureInj.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = injureddetailsDT.NewRow();
                        dr["incident_id"] = incidentBE.incident_id;

                        dr["injured_id"] = !string.IsNullOrEmpty(ddlInjuredpersonPartC_3.SelectedValue.Trim()) ? ddlInjuredpersonPartC_3.SelectedValue.Trim() : string.Empty;

                        if (nature_of_injury == string.Empty)
                        {
                            nature_of_injury = "<ul>";
                        }

                        if (li.Text == "Others")
                        {
                            dr["injury_type"] = "Nature Of Injury";
                            dr["injury_code"] = li.Value;
                            dr["injury_name"] = li.Text + " : " + txtNatureInjOth.Text;
                            dr["other_desc"] = txtNatureInjOth.Text;

                            nature_of_injury = nature_of_injury + "<li>" + li.Text + " : " + txtNatureInjOth.Text + "</li>";
                        }
                        else
                        {
                            dr["injury_type"] = "Nature Of Injury";
                            dr["injury_code"] = li.Value;
                            dr["injury_name"] = li.Text;
                            dr["other_desc"] = string.Empty;

                            nature_of_injury = nature_of_injury + "<li>" + li.Text + "</li> ";
                        }
                        injureddetailsDT.Rows.Add(dr);
                    }
                }

                if (nature_of_injury != string.Empty)
                {
                    nature_of_injury = nature_of_injury + "</ul>";
                }

                ddr["part_of_body_injured"] = part_of_body_injured + " " + strchkHead + " " + strchkUpper + " " + strchkLower;

                ddr["nature_injury"] = nature_of_injury;

                injureddetailsDisplayDT.Rows.Add(ddr);

                ds.Tables.Clear();
                ds.Tables.Add(injureddetailsDisplayDT);
                ds.Tables.Add(injureddetailsDT);
                AppSession.SetSession("SESSION_LIST_PartC_3InjuredDetails", ds);

                lstViewPartC_3InjuredPersonDetails.DataSource = ds;
                lstViewPartC_3InjuredPersonDetails.DataBind();

                ClearCheckboxlist(chkHead);
                ClearCheckboxlist(chkLower);
                ClearCheckboxlist(chkUpper);
                ClearCheckboxlist(chkNatureInj);
                txtNatureInjOth.Text = string.Empty;
                txtInjuredDescription.Text = string.Empty;
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(Page, "Error", ex.Message);
            }
        }

        protected void lstViewPartC_3InjuredPersonDetails_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstViewPartC_3InjuredPersonDetails, "SESSION_LIST_PartC_3InjuredDetails");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstViewPartC_3InjuredPersonDetails, "Error", ex.Message);
            }
        }

        protected void lstViewPartC_3InjuredPersonDetails_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                hdncurrenttab.Value = "2";
                DataSet ds = new DataSet();
                DataTable dt = new DataTable();
                ds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_3InjuredDetails");

                string incident_id = string.Empty, injured_id = string.Empty;
                incident_id = ds.Tables[0].Rows[e.ItemIndex]["incident_id"].ToString();
                injured_id = ds.Tables[0].Rows[e.ItemIndex]["injured_id"].ToString();

                dt = ds.Tables[1];
                if (dt.Rows.Count > 0)
                {
                    DataRow[] result = dt.Select("incident_id = '" + incident_id + "' and injured_id= '" + injured_id + "'");
                    foreach (DataRow row in result)
                    {
                        dt.Rows.Remove(row);
                    }
                }
                ds.Tables.Remove("injured_details");
                ds.Tables.Add(dt);
                appHelper.DeleteListViewItem(lstViewPartC_3InjuredPersonDetails, e.ItemIndex, "SESSION_LIST_PartC_3InjuredDetails");

            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstViewPartC_3InjuredPersonDetails, "Error", ex.Message);
            }
        }

        protected void imgBtnAttPartCIJMC_Click(object sender, ImageClickEventArgs e)
        {
            string errorCode = string.Empty;
            try
            {

                if (uploadAttPartCIJMC.HasFile.Equals(false))
                {

                    errorCode = "ERR-066";
                    baseHelper.popUpMessageSetfocus(imgBtnAttPartCIJMC, "Error", errorCode, "2", uploadAttPartCIJMC.ClientID);
                }
                else
                {
                    foreach (HttpPostedFile uploadedFile in uploadAttPartCIJMC.PostedFiles)
                    {

                        string fileExtension = Path.GetExtension(uploadedFile.FileName);

                        bool isValidFileExtension = appHelper.IsValidFileExtension(fileExtension.Replace('.', ' ').Trim());
                        if (isValidFileExtension == false)
                        {
                            errorCode = "ERR-067";
                            baseHelper.popUpMessageSetfocus(imgBtnAttPartCIJMC, "Error", errorCode, "2", uploadAttPartCIJMC.ClientID);
                        }
                        else
                        {

                            double DOmaxByteSize = appHelper.MegabytesToBytes(Convert.ToInt32(ConfigurationManager.AppSettings["CertiMaxFileSize_MB"].ToString()));

                            if (uploadAttPartCIJMC.PostedFile.ContentLength > DOmaxByteSize)
                            {
                                string message = string.Format("Your attachment has exceeded the limit of {0}MB. Please scan your document at 300dpi or lower.", ConfigurationManager.AppSettings["DOMaxFileSize_MB"].ToString());
                                string htmlTags = string.Format("javascript:popUpMessageSetfocus('{0}','{1}','{2}','{3}');", "Error", message, 2, uploadAttPartCIJMC.ClientID);
                                ScriptManager.RegisterStartupScript(imgBtnAttPartCIJMC, this.GetType(), "popUpMessageSetfocusScript", htmlTags, true);
                            }
                            else
                            {

                                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();

                                WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                                string incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks;

                                incident_id = iBE.incident_id;
                                attachment_type = "part-c-ijmr-attach-doc";
                                reference_code = ddlInjuredpersonPartC_4.SelectedValue.ToString();
                                file_extension = Path.GetExtension(uploadedFile.FileName);
                                file_id = Guid.NewGuid().ToString() + file_extension;
                                file_name = incident_id + "-C-IJML-" + reference_code + "-" + Path.GetFileName(uploadedFile.FileName);
                                file_path = Server.MapPath(tempFolderPath);
                                file_desc = string.Empty;
                                remarks = string.Empty;

                                uploadedFile.SaveAs(Server.MapPath(tempFolderPath + file_name));

                                set_attach_docs("SESSION_LIST_CIJMC_ATTACHMENTS", incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks, lstPartCIJMCAttach);
                            }
                        }
                    }
                }

                hdncurrenttab.Value = "2"; 
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(imgBtnAttPartCIJMC, "Error", ex.Message);
            }
        }

        protected void lstPartCIJMCAttach_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstPartCIJMCAttach, "SESSION_LIST_CIJMC_ATTACHMENTS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartCIJMCAttach, "Error", ex.Message);
            }
        }

        protected void lstPartCIJMCAttach_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                hdncurrenttab.Value = "2";
                ListViewDataItem li = lstPartCIJMCAttach.Items[e.ItemIndex];
                LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");
                string filename = @lnkatt.Text;

                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);
                string pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {
                    File.Delete(filepath);
                }
                else if (File.Exists(pfilepath))
                {
                    File.Delete(pfilepath);
                }

                string errorCode = string.Empty;
                ErrorMessageBC errbc = new ErrorMessageBC();
                HiddenField hdnfileid = (HiddenField)li.FindControl("hdnfileid");
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                ibc.update_incidents_attachfiles(hdnfileid.Value, userLogin.UserId, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    string errStr = string.Empty;
                    errbc.GetErrorMessage(errorCode, out errStr);
                }

                appHelper.DeleteListViewItem(lstPartCIJMCAttach, e.ItemIndex, "SESSION_LIST_CIJMC_ATTACHMENTS");
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartCIJMCAttach, "Error", ex.Message);
            }
        }

        protected void btnAddPartC_4MedicalLeave_Click(object sender, EventArgs e)
        {
            if (!ValidateApplyMC())
            {
                SavePartC_4MLChanges();

                hdncurrenttab.Value = "2"; 
            }
        }

        private bool ValidateApplyMC()
        {
            hdncurrenttab.Value = "2";
            bool errorFlag = false;
            string errorCode = string.Empty;
            decimal nodays = 0;

            if (string.IsNullOrEmpty(txtHospital_ClinicName.Text) && errorFlag.Equals(false))
            {
                errorFlag = true;
                errorCode = "ERR-035";
                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtHospital_ClinicName.ClientID);
            }
            if (string.IsNullOrEmpty(txtMCFrom.Text) && errorFlag.Equals(false))
            {
                errorFlag = true;
                errorCode = "ERR-036";
                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtMCFrom.ClientID);
            }
            if (string.IsNullOrEmpty(txtMCTo.Text) && errorFlag.Equals(false))
            {
                errorFlag = true;
                errorCode = "ERR-037";
                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtMCTo.ClientID);
            }
            if (txtMCFrom.Text.Length != 11 && errorCode.Equals(false))
            {
                errorCode = "ERR-010";
                errorFlag = true;
                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtMCFrom.ClientID);
            }
            if (txtMCTo.Text.Length != 11 && errorCode.Equals(false))
            {
                errorCode = "ERR-010";
                errorFlag = true;
                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtMCTo.ClientID);
            }
            if (!DateTime.TryParseExact(txtMCFrom.Text, format, CultureInfo.InvariantCulture, DateTimeStyles.None, out DateTime dateTime) && errorFlag.Equals(false))
            {
                errorCode = "ERR-010";
                errorFlag = true;
                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtMCFrom.ClientID);
            }
            if (!DateTime.TryParseExact(txtMCTo.Text, format, CultureInfo.InvariantCulture, DateTimeStyles.None, out dateTime) && errorFlag.Equals(false))
            {
                errorCode = "ERR-010";
                errorFlag = true;
                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtMCTo.ClientID);
            }
            if (txtMCFrom.Text.Length > 0 && txtMCTo.Text.Length > 0 && errorFlag.Equals(false))
            {
                DateTime mcFrom = Convert.ToDateTime(txtMCFrom.Text);
                DateTime mcTo = Convert.ToDateTime(txtMCTo.Text);

                string str_incdate = string.Empty;
                if (txtIncDate.Text.Trim() == string.Empty)
                {
                    str_incdate = lblvDate.Text.Trim();
                }
                else
                {
                    str_incdate = txtIncDate.Text.Trim();
                }
                DateTime IncDate = Convert.ToDateTime(str_incdate);

                if (mcFrom < IncDate)
                {
                    errorCode = "ERR-065";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtMCFrom.ClientID);
                }
                else if (mcFrom > mcTo)
                {
                    errorCode = "ERR-038";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtMCFrom.ClientID);
                }
                else if (string.IsNullOrEmpty(txtMCFrom.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-103";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtMCDays.ClientID);
                }
                else if (txtMCDays.Text.Length > 0 && errorFlag.Equals(false))
                {
                    if (appHelper.IsDecimal(txtMCDays.Text) == false)
                    {
                        errorCode = "ERR-103";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtMCDays.ClientID);
                    }
                    else
                    {
                        decimal enterdays = Convert.ToDecimal(txtMCDays.Text);

                        Regex deicmalPattern = new Regex(@"^[0-9]{0,6}(\.[0-9]{1,2})?$");

                        nodays = Convert.ToDecimal(Convert.ToInt16((mcTo - mcFrom).TotalDays) + 1);

                        if (deicmalPattern.IsMatch(txtMCDays.Text) == false)
                        {
                            errorCode = "ERR-103";
                            errorFlag = true;
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtMCDays.ClientID);
                        }
                        if (enterdays > nodays || enterdays == 0)
                        {
                            errorCode = "ERR-103";
                            errorFlag = true;
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtMCDays.ClientID);
                        }
                    }
                }
            }
            return errorFlag;
        }

        private void SavePartC_4MLChanges()
        {
            try
            {

                DataSet ds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_4_MC");
                DataTable dt = new DataTable();

                if (ds.Tables[0].Rows.Count > 0)
                {
                    dt = ds.Tables[0];
                }
                else 
                {
                    dt.TableName = "injured_mc";
                    dt.Columns.Add(new DataColumn("incident_id", typeof(string)));
                    dt.Columns.Add(new DataColumn("injured_id", typeof(string)));
                    dt.Columns.Add(new DataColumn("injured_name", typeof(string)));
                    dt.Columns.Add(new DataColumn("hospital_clinic_name", typeof(string)));
                    dt.Columns.Add(new DataColumn("from_date", typeof(string)));
                    dt.Columns.Add(new DataColumn("to_date", typeof(string)));
                    dt.Columns.Add(new DataColumn("no_days", typeof(string)));
                    dt.Columns.Add(new DataColumn("morethan24hrs", typeof(string)));
                    dt.Columns.Add(new DataColumn("morethan24hrs_text", typeof(string)));
                    dt.Columns.Add(new DataColumn("attachment", typeof(string)));
                }

                DataRow row = dt.NewRow();
                row["injured_id"] = ddlInjuredpersonPartC_4.SelectedValue.ToString();
                row["injured_name"] = ddlInjuredpersonPartC_4.SelectedItem.Text;
                row["hospital_clinic_name"] = txtHospital_ClinicName.Text;
                row["from_date"] = txtMCFrom.Text;
                row["to_date"] = txtMCTo.Text;
                row["no_days"] = txtMCDays.Text;
                row["morethan24hrs"] = rdoMCmorethan24hrs.SelectedValue;
                row["morethan24hrs_text"] = rdoMCmorethan24hrs.SelectedItem.Text;
                row["attachment"] = string.Empty; 
                dt.Rows.Add(row);

                ds.Tables.Clear();
                ds.Tables.Add(dt);

                AppSession.SetSession("SESSION_LIST_PartC_4_MC", ds);

                lstViewPartC_4ML.DataSource = dt;
                lstViewPartC_4ML.DataBind();

                txtHospital_ClinicName.Text = string.Empty;
                txtMCFrom.Text = string.Empty;
                txtMCTo.Text = string.Empty;
                txtMCDays.Text = string.Empty;

            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(Page, "Error", ex.Message);
            }
        }

        protected void lstViewPartC_4ML_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstViewPartC_4ML, "SESSION_LIST_PartC_4_MC");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstViewPartC_4ML, "Error", ex.Message);
            }
        }

        protected void lstViewPartC_4ML_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            string error_code = string.Empty;
            DataSet ds = new DataSet();
            DataTable dt = new DataTable();

            try
            {
                hdncurrenttab.Value = "2";
                appHelper.DeleteListViewItem(lstViewPartC_4ML, e.ItemIndex, "SESSION_LIST_PartC_4_MC");
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstViewPartC_4ML, "Error", ex.Message);
            }
        }

        protected void chkIncidentClass_SelectedIndexChanged(object sender, EventArgs e)
        {
            bool isOther = false;

            try
            {
                foreach (ListItem li in chkIncidentClass.Items)
                {
                    if (li.Selected)
                    {
                        if (li.Value == "99")
                        {
                            isOther = true;
                        }

                    }
                }
                if (isOther == true)
                {
                    txtclassincOTH.Enabled = true;

                }
                else
                {
                    txtclassincOTH.Enabled = false;
                    txtclassincOTH.Text = string.Empty;

                }

            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(chkIncidentClass, "Error", ex.Message);
            }
        }

        protected void chkIncidentAgent_SelectedIndexChanged(object sender, EventArgs e)
        {
            bool isOther = false;

            try
            {
                foreach (ListItem li in chkIncidentAgent.Items)
                {
                    if (li.Selected)
                    {
                        if (li.Value == "99")
                        {
                            isOther = true;
                        }
                    }
                }
                if (isOther == true)
                {
                    txtAgentOTH.Enabled = true;

                }
                else
                {
                    txtAgentOTH.Enabled = false;
                    txtAgentOTH.Text = string.Empty;

                }

            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(chkIncidentAgent, "Error", ex.Message);
            }
        }

        protected void chkCF_SelectedIndexChanged(object sender, EventArgs e)
        {
            bool isOther = false;

            try
            {
                foreach (ListItem li in chkCF.Items)
                {
                    if (li.Selected)
                    {
                        if (li.Value == "99")
                        {
                            isOther = true;
                        }

                    }
                }
                if (isOther == true)
                {
                    txtCFOTH.Enabled = true;

                }
                else
                {
                    txtCFOTH.Enabled = false;
                    txtCFOTH.Text = string.Empty;

                }

            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(chkCF, "Error", ex.Message);
            }
        }

        protected void imgBtnAttPartCCP_Click(object sender, ImageClickEventArgs e)
        {
            string errorCode = string.Empty;
            try
            {

                if (uploadAttPartCCP.HasFile.Equals(false))
                {

                    errorCode = "ERR-066";
                    baseHelper.popUpMessageSetfocus(imgBtnAttPartCCP, "Error", errorCode, "2", uploadAttPartCCP.ClientID);
                }
                else
                {
                    foreach (HttpPostedFile uploadedFile in uploadAttPartCCP.PostedFiles)
                    {

                        string fileExtension = Path.GetExtension(uploadedFile.FileName);

                        bool isValidFileExtension = appHelper.IsValidFileExtension(fileExtension.Replace('.', ' ').Trim());
                        if (isValidFileExtension == false)
                        {
                            errorCode = "ERR-067";
                            baseHelper.popUpMessageSetfocus(imgBtnAttPartCCP, "Error", errorCode, "2", uploadAttPartCCP.ClientID);
                        }
                        else
                        {

                            double DOmaxByteSize = appHelper.MegabytesToBytes(Convert.ToInt32(ConfigurationManager.AppSettings["CertiMaxFileSize_MB"].ToString()));

                            if (uploadAttPartCCP.PostedFile.ContentLength > DOmaxByteSize)
                            {
                                string message = string.Format("Your attachment has exceeded the limit of {0}MB. Please scan your document at 300dpi or lower.", ConfigurationManager.AppSettings["DOMaxFileSize_MB"].ToString());
                                string htmlTags = string.Format("javascript:popUpMessageSetfocus('{0}','{1}','{2}','{3}');", "Error", message, 2, uploadAttPartCCP.ClientID);
                                ScriptManager.RegisterStartupScript(imgBtnAttPartCCP, this.GetType(), "popUpMessageSetfocusScript", htmlTags, true);
                            }
                            else
                            {

                                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();

                                WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                                string incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks;

                                incident_id = iBE.incident_id;
                                attachment_type = "part-c-cp-attach-doc";
                                reference_code = string.Empty;
                                file_extension = Path.GetExtension(uploadedFile.FileName);
                                file_id = Guid.NewGuid().ToString() + file_extension;
                                file_name = incident_id + "-C-CP-" + Path.GetFileName(uploadedFile.FileName);
                                file_path = Server.MapPath(tempFolderPath);
                                file_desc = string.Empty;
                                remarks = string.Empty;

                                uploadedFile.SaveAs(Server.MapPath(tempFolderPath + file_name));

                                set_attach_docs("SESSION_LIST_CCP_ATTACHMENTS", incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks, lstPartCCPAttach);
                            }
                        }
                    }
                }

                hdncurrenttab.Value = "2"; 
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(imgBtnAttPartCCP, "Error", ex.Message);
            }
        }

        protected void lstPartCCPAttach_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstPartCCPAttach, "SESSION_LIST_CCP_ATTACHMENTS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartCCPAttach, "Error", ex.Message);
            }
        }

        protected void lstPartCCPAttach_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                hdncurrenttab.Value = "2";
                ListViewDataItem li = lstPartCCPAttach.Items[e.ItemIndex];
                LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");
                string filename = @lnkatt.Text;
                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);
                string pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {
                    File.Delete(filepath);
                }
                else if (File.Exists(pfilepath))
                {
                    File.Delete(pfilepath);
                }

                string errorCode = string.Empty;
                ErrorMessageBC errbc = new ErrorMessageBC();
                HiddenField hdnfileid = (HiddenField)li.FindControl("hdnfileid");
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                ibc.update_incidents_attachfiles(hdnfileid.Value, userLogin.UserId, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    string errStr = string.Empty;
                    errbc.GetErrorMessage(errorCode, out errStr);
                }
                appHelper.DeleteListViewItem(lstPartCCPAttach, e.ItemIndex, "SESSION_LIST_CCP_ATTACHMENTS");
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartCCPAttach, "Error", ex.Message);
            }
        }

        protected void btnPartC_Click(object sender, EventArgs e)
        {

            hdncurrenttab.Value = "2"; 
            if (!ValidatePartC())
            {
                Submit_PartC_Record();
            }
        }

        protected void btnPartCSave_Click(object sender, EventArgs e)
        {

            hdncurrenttab.Value = "2"; 
            Save_PartC_Record();
        }

        protected void btnSaveMC_Click(object sender, EventArgs e)
        {
            hdncurrenttab.Value = "2"; 
            Save_MC();
        }

        protected void btnPartCClose_Click(object sender, EventArgs e)
        {
            string errtitle = string.Empty;
            string errorCode = string.Empty;
            string errStr = string.Empty;
            WorkflowIncidentBE incidentBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
            WorkflowIncidentBC incidentBC = new WorkflowIncidentBC();

            try
            {
                bool error = false;
                if (string.IsNullOrEmpty(txtPartCAdditional_Comment.Text.Trim()))
                {
                    errorCode = "ERR-134";
                    error = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtPartCAdditional_Comment.ClientID);
                }
                else if (string.IsNullOrEmpty(ddlPartB_WSHO.SelectedValue.ToString()))
                {
                    errorCode = "ERR-135";
                    error = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", ddlPartB_WSHO.ClientID);
                }
                if (error == false)
                {
                    CommonFun appHelper = new CommonFun();
                    ErrorMessageBC errbc = new ErrorMessageBC();
                    incidentBE.status = "08";
                    string action_role = "CLOSE";

                    setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, ddlPartC_CWSHOID.SelectedValue, txtManCorrectiveandPreventiveAction.Text.Trim());

                    DataSet w_partb_ds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                    incidentBC.insert_incidents_workflows(incidentBE.incident_id, w_partb_ds, out errorCode);

                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        errbc.GetErrorMessage(errorCode, out errStr);
                    }
                    else
                    {
                        SendEmailNotification(incidentBE, "02", "00", w_partb_ds.Tables[0], txtPartCAdditional_Comment.Text.Trim(), out errorCode);
                        if (string.IsNullOrEmpty(errorCode))
                        {
                            errtitle = "Incident Report";
                            errStr = "SUC-001";
                        }
                        else
                        {
                            errtitle = "Notification";
                            errStr = errorCode;
                        }
                        Session.Remove("SESSION_LIST_WORKFLOWS");
                        baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");

                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errorCode + ":" + ex.Message;
                baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
            }
        }

        private void Save_MC()
        {
            try
            {
                CommonFun appHelper = new CommonFun();
                ErrorMessageBC errbc = new ErrorMessageBC();

                string errorCode = string.Empty;
                string returnValue = string.Empty;
                string errStr = string.Empty;
                string errtitle = string.Empty;

                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                WorkflowIncidentBE ibe = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");

                DataSet attachmentds = new DataSet();

                DataSet InjuredMCds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_4_MC");
                ibc.Save_MC(ibe, InjuredMCds, attachmentds, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    errbc.GetErrorMessage(errorCode, out errStr);
                    returnValue = errorCode + "/" + errStr;
                }
                else
                {
                    save_attachfiles("SESSION_LIST_CIJMC_ATTACHMENTS", lstPartCIJMCAttach, out errorCode);
                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", btnPartC.ClientID);
                    }
                    else
                    {
                        string action_role = "COPYTO";

                        foreach (ListItem li in chkPartCExtraMCEmailTo.Items)
                        {
                            if (li.Selected)
                            {
                                string copyto_usrid = string.Empty;
                                copyto_usrid = li.Value;
                                setworkflow_data(ibe.incident_id, ibe.status, action_role, copyto_usrid, string.Empty);
                            }
                        }
                        DataSet wfds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");
                        SendEmailNotification(ibe, "02", "02", wfds.Tables[0], string.Empty, out errorCode);
                        if (string.IsNullOrEmpty(errorCode))
                        {
                            errtitle = "Incident Report";
                            errStr = "SUC-001";

                            Session.Remove("SESSION_LIST_PartC_4_MC");
                            Session.Remove("SESSION_LIST_WORKFLOWS");
                            Session.Remove("SESSION_LIST_CIJMC_ATTACHMENTS");
                            baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
                        }
                        else
                        {
                            errtitle = "Notification";
                            errStr = errorCode;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(Page, "Error", ex.Message);
            }
        }

        private bool ValidatePartC()
        {
            string errorCode = string.Empty;
            bool errorFlag = false;
            hdncurrenttab.Value = "2";
            if (errorFlag.Equals(false))
            {

                if (string.IsNullOrEmpty(txtPartC_WhatandWhy.Text.Trim()) && errorFlag.Equals(false))
                {
                    errorFlag = true;
                    errorCode = "ERR-076";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtPartC_WhatandWhy.ClientID);
                }
                if (txtPartC_WhatandWhy.Text.Length > 8000 && errorFlag.Equals(false))
                {
                    errorCode = "ERR-122";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtPartC_WhatandWhy.ClientID);
                }

                if (lstViewPartC_PersonInterviewed.Items.Count < 1)
                {
                    errorCode = "ERR-068";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", "");
                }

                if (ddlIncidentType.SelectedValue == "1")
                {
                    DataTable listDT = new DataTable();
                    if (lstViewPartC_3InjuredPersonDetails.Items.Count < 1)
                    {
                        errorCode = "ERR-136";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", "");
                    }
                    else
                    {
                        DataSet InjuredDetailsds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_3InjuredDetails");
                        listDT = InjuredDetailsds.Tables[0];
                        for (int i = 0; i < ddlInjuredpersonPartC_3.Items.Count; i++)
                        {
                            string experssion = "injured_id='" + ddlInjuredpersonPartC_3.Items[i].Value + "'";
                            DataRow[] drlist = listDT.Select(experssion);
                            if (drlist.Length <= 0)
                            {
                                errorCode = "ERR-136";
                                errorFlag = true;
                                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", ddlInjuredpersonPartC_3.ClientID);
                            }
                            else if (drlist.Length > 1)
                            {
                                errorCode = "ERR-140";
                                errorFlag = true;
                                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", ddlInjuredpersonPartC_3.ClientID);
                            }
                        }
                    }
                }

                int count = 0;

                if (ddlIncidentType.SelectedValue == "1")
                {

                    foreach (ListItem li in chkIncidentClass.Items)
                    {
                        if (li.Selected)
                        {
                            count++;
                            if (li.Value == "99" && string.IsNullOrEmpty(txtclassincOTH.Text))
                            {
                                errorCode = "ERR-078";
                                errorFlag = true;
                                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtclassincOTH.ClientID);
                            }
                        }
                    }
                    if (count == 0 && errorFlag.Equals(false))
                    {
                        errorCode = "ERR-077";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", chkIncidentClass.ClientID);
                    }

                    count = 0;
                    foreach (ListItem li in chkIncidentAgent.Items)
                    {
                        if (li.Selected)
                        {
                            count++;
                            if (li.Value == "99" && string.IsNullOrEmpty(txtAgentOTH.Text))
                            {
                                errorCode = "ERR-080";
                                errorFlag = true;
                                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtAgentOTH.ClientID);
                            }
                        }
                    }
                    if (count == 0 && errorFlag.Equals(false))
                    {
                        errorCode = "ERR-079";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", chkIncidentAgent.ClientID);
                    }

                    count = 0;
                    foreach (ListItem li in chkUC.Items)
                    {
                        if (li.Selected)
                        {
                            count++;
                            if (li.Value == "99" && string.IsNullOrEmpty(txtUCOTH.Text))
                            {
                                errorCode = "ERR-082";
                                errorFlag = true;
                                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtUCOTH.ClientID);
                            }
                        }
                    }
                    if (count == 0 && errorFlag.Equals(false))
                    {
                        errorCode = "ERR-081";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", chkUC.ClientID);
                    }

                    count = 0;
                    foreach (ListItem li in chkUA.Items)
                    {
                        if (li.Selected)
                        {
                            count++;
                            if (li.Value == "99" && string.IsNullOrEmpty(txtUAOTH.Text))
                            {
                                errorCode = "ERR-084";
                                errorFlag = true;
                                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtUAOTH.ClientID);
                            }
                        }
                    }
                    if (count == 0 && errorFlag.Equals(false))
                    {
                        errorCode = "ERR-083";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", chkUA.ClientID);
                    }

                    count = 0;
                    foreach (ListItem li in chkCF.Items)
                    {
                        if (li.Selected)
                        {
                            count++;
                            if (li.Value == "99" && string.IsNullOrEmpty(txtCFOTH.Text))
                            {
                                errorCode = "ERR-086";
                                errorFlag = true;
                                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtCFOTH.ClientID);
                            }
                        }
                    }
                    if (count == 0 && errorFlag.Equals(false))
                    {
                        errorCode = "ERR-085";
                        errorFlag = true;
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", chkCF.ClientID);
                    }
                }

                if (string.IsNullOrEmpty(txtManCorrectiveandPreventiveAction.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-137";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtManCorrectiveandPreventiveAction.ClientID);
                }

                if (string.IsNullOrEmpty(rdoNegligent.SelectedValue) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-088";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", rdoNegligent.ClientID);
                }

                if (string.IsNullOrEmpty(txtPartCAdditional_Comment.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-089";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtPartCAdditional_Comment.ClientID);
                }
                if (txtPartCAdditional_Comment.Text.Length > 8000 && errorFlag.Equals(false))
                {
                    errorCode = "ERR-125";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", txtPartCAdditional_Comment.ClientID);
                }

                if (string.IsNullOrEmpty(ddlPartC_CWSHOID.SelectedValue) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-138";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", ddlPartC_CWSHOID.ClientID);
                }
            }
            return errorFlag;
        }

        public string Submit_PartC_Record()
        {
            CommonFun appHelper = new CommonFun();
            ErrorMessageBC errbc = new ErrorMessageBC();

            string errorCode = string.Empty;
            string returnValue = string.Empty;
            string errStr = string.Empty;
            string errtitle = string.Empty;

            WorkflowIncidentBC ibc = new WorkflowIncidentBC();
            WorkflowIncidentBE incidentBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");

            DataSet causeanalysisds = new DataSet();
            DataTable causeanalysisDT = new DataTable();

            try
            {
                DataSet InjuredDetailsds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_3InjuredDetails");
                DataSet InjuredMCds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_4_MC");

                DataSet Interviewedds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_PersonInterviewed");
                Interviewedds.Tables[0].TableName = "PersonInterviewed";

                causeanalysisDT.TableName = "cause_analysis";
                causeanalysisDT.Columns.Add(new DataColumn("lookup_type", typeof(string)));
                causeanalysisDT.Columns.Add(new DataColumn("lookup_code", typeof(string)));
                causeanalysisDT.Columns.Add(new DataColumn("type_description", typeof(string)));

                foreach (ListItem li in chkIncidentClass.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = causeanalysisDT.NewRow();
                        if (li.Value == "99")
                        {
                            dr["lookup_type"] = "Incident Class";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = txtclassincOTH.Text;
                        }
                        else
                        {
                            dr["lookup_type"] = "Incident Class";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = string.Empty;
                        }
                        causeanalysisDT.Rows.Add(dr);
                    }
                }

                foreach (ListItem li in chkIncidentAgent.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = causeanalysisDT.NewRow();
                        if (li.Value == "99")
                        {
                            dr["lookup_type"] = "Incident Agent";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = txtAgentOTH.Text;
                        }
                        else
                        {
                            dr["lookup_type"] = "Incident Agent";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = string.Empty;
                        }
                        causeanalysisDT.Rows.Add(dr);
                    }
                }

                foreach (ListItem li in chkUC.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = causeanalysisDT.NewRow();
                        if (li.Value == "99")
                        {
                            dr["lookup_type"] = "Unsafe Condition";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = txtUCOTH.Text;
                        }
                        else
                        {
                            dr["lookup_type"] = "Unsafe Condition";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = string.Empty;
                        }
                        causeanalysisDT.Rows.Add(dr);
                    }
                }

                foreach (ListItem li in chkUA.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = causeanalysisDT.NewRow();
                        if (li.Value == "99")
                        {
                            dr["lookup_type"] = "Unsafe Act";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = txtUAOTH.Text;
                        }
                        else
                        {
                            dr["lookup_type"] = "Unsafe Act";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = string.Empty;
                        }
                        causeanalysisDT.Rows.Add(dr);
                    }
                }

                foreach (ListItem li in chkCF.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = causeanalysisDT.NewRow();
                        if (li.Value == "99")
                        {
                            dr["lookup_type"] = "Factors";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = txtCFOTH.Text;
                        }
                        else
                        {
                            dr["lookup_type"] = "Factors";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = string.Empty;
                        }
                        causeanalysisDT.Rows.Add(dr);
                    }
                }
                causeanalysisds.Tables.Clear();
                causeanalysisds.Tables.Add(causeanalysisDT);

                incidentBE.status = "03";
                incidentBE.recommend_action_desc = txtManCorrectiveandPreventiveAction.Text.Trim();
                incidentBE.negligent = rdoNegligent.SelectedValue;
                incidentBE.negligent_comments = txtPartCAdditional_Comment.Text;
                incidentBE.what_happened_and_why_comments = txtPartC_WhatandWhy.Text.Trim();
                incidentBE.modified_by = userLogin.UserId;

                string action_role = "CWSHO";

                setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, ddlPartC_CWSHOID.SelectedValue, txtPartCAdditional_Comment.Text.Trim());
                DataSet wfds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                DataSet attachmentds = new DataSet();
                DataTable attachmentdt = new DataTable
                {
                    TableName = "incidents_attachment"
                };
                attachmentdt.Columns.Add(new DataColumn("incident_id", typeof(string)));
                attachmentdt.Columns.Add(new DataColumn("injured_id", typeof(string)));
                attachmentdt.Columns.Add(new DataColumn("attachment_type", typeof(string)));
                attachmentdt.Columns.Add(new DataColumn("attachment_code", typeof(string)));
                attachmentdt.Columns.Add(new DataColumn("file_path", typeof(string)));
                attachmentdt.Columns.Add(new DataColumn("file_type", typeof(string)));

                DataTable ijp_dt = new DataTable
                {
                    TableName = "incidents_injured"
                };
                ijp_dt.Columns.Add(new DataColumn("injured_emp_no", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("fourth_day_mc_date", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("ireport_no", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("ireport_date", typeof(string)));

                foreach (ListViewDataItem lstViewItem in lst_ireport.Items)
                {
                    HiddenField hdninjured_personid = (HiddenField)lstViewItem.FindControl("hdninjured_personid");
                    TextBox txtfourth_day_mc_date = (TextBox)lstViewItem.FindControl("txtfourth_day_mc_date");
                    TextBox txtireport_no = (TextBox)lstViewItem.FindControl("txtireport_no");
                    TextBox txtireport_date = (TextBox)lstViewItem.FindControl("txtireport_date");

                    DataRow row = ijp_dt.NewRow();
                    row["injured_emp_no"] = hdninjured_personid.Value.Trim();
                    row["fourth_day_mc_date"] = txtfourth_day_mc_date.Text.Trim();
                    row["ireport_no"] = txtireport_no.Text.Trim();
                    row["ireport_date"] = txtireport_date.Text.Trim();

                    ijp_dt.Rows.Add(row);
                }

                DataSet ireport_ds = new DataSet();
                ireport_ds.Tables.Clear();
                ireport_ds.Tables.Add(ijp_dt);

                ibc.submit_incident_partc(incidentBE, ireport_ds, Interviewedds, InjuredDetailsds, causeanalysisds, InjuredMCds, wfds, attachmentds, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    errbc.GetErrorMessage(errorCode, out errStr);
                    returnValue = errorCode + "/" + errStr;
                }
                else
                {
                    save_attachfiles("SESSION_LIST_CIP_ATTACHMENTS", lstPartCIPAttach, out errorCode);
                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", btnPartC.ClientID);
                    }
                    else
                    {
                        save_attachfiles("SESSION_LIST_CIPS_ATTACHMENTS", lstPartCIPSAttach, out errorCode);
                        if (!string.IsNullOrEmpty(errorCode))
                        {
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", btnPartC.ClientID);
                        }
                        else
                        {
                            save_attachfiles("SESSION_LIST_CIJP_ATTACHMENTS", lstPartCIJPAttach, out errorCode);
                            if (!string.IsNullOrEmpty(errorCode))
                            {
                                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", btnPartC.ClientID);
                            }
                            else
                            {
                                save_attachfiles("SESSION_LIST_CIJMC_ATTACHMENTS", lstPartCIJMCAttach, out errorCode);
                                if (!string.IsNullOrEmpty(errorCode))
                                {
                                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", btnPartC.ClientID);
                                }
                                else
                                {
                                    save_attachfiles("SESSION_LIST_CCP_ATTACHMENTS", lstPartCCPAttach, out errorCode);
                                    if (!string.IsNullOrEmpty(errorCode))
                                    {
                                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", btnPartC.ClientID);
                                    }
                                    else
                                    {
                                        SendEmailNotification(incidentBE, "02", "03", wfds.Tables[0], txtPartCAdditional_Comment.Text.Trim(), out errorCode);
                                        if (string.IsNullOrEmpty(errorCode))
                                        {
                                            errtitle = "Incident Report";
                                            errStr = "SUC-001";
                                        }
                                        else
                                        {
                                            errtitle = "Notification";
                                            errStr = errorCode;
                                        }
                                        Session.Remove("SESSION_LIST_PartC_EyeWitnesses");
                                        Session.Remove("SESSION_LIST_PartC_PersonInterviewed");
                                        Session.Remove("SESSION_LIST_PartC_3InjuredDetails");
                                        Session.Remove("SESSION_LIST_PartC_4_MC");
                                        Session.Remove("SESSION_LIST_WORKFLOWS");
                                        Session.Remove("SESSION_LIST_CIPS_ATTACHMENTS");
                                        Session.Remove("SESSION_LIST_CIJMC_ATTACHMENTS");
                                        baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");

                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errorCode + ":" + ex.Message;
                returnValue = returnValue + ":" + ex.Message;
            }
            return returnValue;
        }

        public string Save_PartC_Record()
        {
            CommonFun appHelper = new CommonFun();
            ErrorMessageBC errbc = new ErrorMessageBC();

            string errorCode = string.Empty;
            string returnValue = string.Empty;
            string errStr = string.Empty;
            string errtitle = string.Empty;
            string currentIncidentStatus = string.Empty;

            WorkflowIncidentBC ibc = new WorkflowIncidentBC();
            WorkflowIncidentBE incidentBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
            currentIncidentStatus = incidentBE.status;

            DataSet causeanalysisds = new DataSet();
            DataTable causeanalysisDT = new DataTable();

            try
            {
                DataSet InjuredDetailsds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_3InjuredDetails");
                DataSet InjuredMCds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_4_MC");

                DataSet Interviewedds = (DataSet)AppSession.GetSession("SESSION_LIST_PartC_PersonInterviewed");
                Interviewedds.Tables[0].TableName = "PersonInterviewed";

                causeanalysisDT.TableName = "cause_analysis";
                causeanalysisDT.Columns.Add(new DataColumn("lookup_type", typeof(string)));
                causeanalysisDT.Columns.Add(new DataColumn("lookup_code", typeof(string)));
                causeanalysisDT.Columns.Add(new DataColumn("type_description", typeof(string)));

                foreach (ListItem li in chkIncidentClass.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = causeanalysisDT.NewRow();
                        if (li.Value == "99")
                        {
                            dr["lookup_type"] = "Incident Class";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = txtclassincOTH.Text;
                        }
                        else
                        {
                            dr["lookup_type"] = "Incident Class";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = string.Empty;
                        }
                        causeanalysisDT.Rows.Add(dr);
                    }
                }

                foreach (ListItem li in chkIncidentAgent.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = causeanalysisDT.NewRow();
                        if (li.Value == "99")
                        {
                            dr["lookup_type"] = "Incident Agent";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = txtAgentOTH.Text;
                        }
                        else
                        {
                            dr["lookup_type"] = "Incident Agent";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = string.Empty;
                        }
                        causeanalysisDT.Rows.Add(dr);
                    }
                }

                foreach (ListItem li in chkUC.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = causeanalysisDT.NewRow();
                        if (li.Value == "99")
                        {
                            dr["lookup_type"] = "Unsafe Condition";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = txtUCOTH.Text;
                        }
                        else
                        {
                            dr["lookup_type"] = "Unsafe Condition";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = string.Empty;
                        }
                        causeanalysisDT.Rows.Add(dr);
                    }
                }

                foreach (ListItem li in chkUA.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = causeanalysisDT.NewRow();
                        if (li.Value == "99")
                        {
                            dr["lookup_type"] = "Unsafe Act";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = txtUAOTH.Text;
                        }
                        else
                        {
                            dr["lookup_type"] = "Unsafe Act";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = string.Empty;
                        }
                        causeanalysisDT.Rows.Add(dr);
                    }
                }

                foreach (ListItem li in chkCF.Items)
                {
                    if (li.Selected)
                    {
                        DataRow dr = null;
                        dr = causeanalysisDT.NewRow();
                        if (li.Value == "99")
                        {
                            dr["lookup_type"] = "Factors";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = txtCFOTH.Text;
                        }
                        else
                        {
                            dr["lookup_type"] = "Factors";
                            dr["lookup_code"] = li.Value;
                            dr["type_description"] = string.Empty;
                        }
                        causeanalysisDT.Rows.Add(dr);
                    }
                }
                causeanalysisds.Tables.Clear();
                causeanalysisds.Tables.Add(causeanalysisDT);

                incidentBE.status = "02";
                incidentBE.recommend_action_desc = txtManCorrectiveandPreventiveAction.Text.Trim().Trim();
                incidentBE.negligent = rdoNegligent.SelectedValue.Trim();
                incidentBE.negligent_comments = txtPartCAdditional_Comment.Text.Trim();
                incidentBE.what_happened_and_why_comments = txtPartC_WhatandWhy.Text.Trim();
                incidentBE.modified_by = userLogin.UserId;

                DataSet attachmentds = new DataSet();
                DataTable attachmentdt = new DataTable
                {
                    TableName = "incidents_attachment"
                };
                attachmentdt.Columns.Add(new DataColumn("incident_id", typeof(string)));
                attachmentdt.Columns.Add(new DataColumn("injured_id", typeof(string)));
                attachmentdt.Columns.Add(new DataColumn("attachment_type", typeof(string)));
                attachmentdt.Columns.Add(new DataColumn("attachment_code", typeof(string)));
                attachmentdt.Columns.Add(new DataColumn("file_path", typeof(string)));
                attachmentdt.Columns.Add(new DataColumn("file_type", typeof(string)));

                DataTable ijp_dt = new DataTable
                {
                    TableName = "incidents_injured"
                };
                ijp_dt.Columns.Add(new DataColumn("injured_emp_no", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("fourth_day_mc_date", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("ireport_no", typeof(string)));
                ijp_dt.Columns.Add(new DataColumn("ireport_date", typeof(string)));

                foreach (ListViewDataItem lstViewItem in lst_ireport.Items)
                {
                    HiddenField hdninjured_personid = (HiddenField)lstViewItem.FindControl("hdninjured_personid");
                    TextBox txtfourth_day_mc_date = (TextBox)lstViewItem.FindControl("txtfourth_day_mc_date");
                    TextBox txtireport_no = (TextBox)lstViewItem.FindControl("txtireport_no");
                    TextBox txtireport_date = (TextBox)lstViewItem.FindControl("txtireport_date");

                    DataRow row = ijp_dt.NewRow();
                    row["injured_emp_no"] = hdninjured_personid.Value.Trim();
                    row["fourth_day_mc_date"] = txtfourth_day_mc_date.Text.Trim();
                    row["ireport_no"] = txtireport_no.Text.Trim();
                    row["ireport_date"] = txtireport_date.Text.Trim();

                    ijp_dt.Rows.Add(row);
                }

                DataSet ireport_ds = new DataSet();
                ireport_ds.Tables.Clear();
                ireport_ds.Tables.Add(ijp_dt);

                ibc.save_incident_partc(incidentBE, ireport_ds, Interviewedds, InjuredDetailsds, causeanalysisds, InjuredMCds, attachmentds, out errorCode);

                if (!string.IsNullOrEmpty(errorCode))
                {
                    errbc.GetErrorMessage(errorCode, out errStr);
                    returnValue = errorCode + "/" + errStr;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", btnPartC.ClientID);
                }
                else
                {
                    save_attachfiles("SESSION_LIST_CIP_ATTACHMENTS", lstPartCIPAttach, out errorCode);
                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", btnPartC.ClientID);
                    }
                    else
                    {
                        save_attachfiles("SESSION_LIST_CIPS_ATTACHMENTS", lstPartCIPSAttach, out errorCode);
                        if (!string.IsNullOrEmpty(errorCode))
                        {
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", btnPartC.ClientID);
                        }
                        else
                        {
                            save_attachfiles("SESSION_LIST_CIJP_ATTACHMENTS", lstPartCIJPAttach, out errorCode);
                            if (!string.IsNullOrEmpty(errorCode))
                            {
                                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", btnPartC.ClientID);
                            }
                            else
                            {
                                save_attachfiles("SESSION_LIST_CIJMC_ATTACHMENTS", lstPartCIJMCAttach, out errorCode);
                                if (!string.IsNullOrEmpty(errorCode))
                                {
                                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", btnPartC.ClientID);
                                }
                                else
                                {
                                    save_attachfiles("SESSION_LIST_CCP_ATTACHMENTS", lstPartCCPAttach, out errorCode);
                                    if (!string.IsNullOrEmpty(errorCode))
                                    {
                                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", btnPartC.ClientID);
                                    }
                                    else
                                    {
                                        string action_role = "COPYTO";

                                        setworkflow_data(incidentBE.incident_id, incidentBE.status, action_role, ddlPartC_CWSHOID.SelectedValue, string.Empty);

                                        DataSet wfds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                                        if (!string.IsNullOrEmpty(errorCode))
                                        {
                                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", btnPartC.ClientID);
                                        }
                                        else
                                        {
                                            errtitle = "Incident Report";
                                            errStr = "SUC-002";

                                            Session.Remove("SESSION_LIST_PartC_EyeWitnesses");
                                            Session.Remove("SESSION_LIST_PartC_PersonInterviewed");
                                            Session.Remove("SESSION_LIST_PartC_3InjuredDetails");
                                            Session.Remove("SESSION_LIST_PartC_4_MC");
                                            Session.Remove("SESSION_LIST_WORKFLOWS");
                                            Session.Remove("SESSION_LIST_CIPS_ATTACHMENTS");
                                            Session.Remove("SESSION_LIST_CIJMC_ATTACHMENTS");
                                            baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");

                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errorCode + ":" + ex.Message;
                returnValue = returnValue + ":" + ex.Message;
                baseHelper.PopUpMessage(Page, "Error", ex.Message);
            }
            return returnValue;
        }

        protected void lv_partc_v_pi_attach_ItemCreated(object sender, ListViewItemEventArgs e)
        {
            try
            {
                ImageButton btnDelete = (ImageButton)e.Item.FindControl("btnDelete");
                if (userLogin.UserRole == "9")
                {
                    btnDelete.Visible = true;
                }
                else
                {
                    btnDelete.Visible = false;
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lv_partc_v_pi_attach, "Error", ex.Message);
            }
        }

        protected void lv_partc_v_pi_attach_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            string errorCode = string.Empty;
            CommonFun appHelper = new CommonFun();
            ErrorMessageBC errbc = new ErrorMessageBC();

            try
            {
                hdncurrenttab.Value = "2";
                ListViewDataItem li = lv_partc_v_pi_attach.Items[e.ItemIndex];
                LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");

                string filename = @lnkatt.Text;
                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);
                string pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {
                    File.Delete(filepath);
                }
                else if (File.Exists(pfilepath))
                {
                    File.Delete(pfilepath);
                }

                HiddenField hdnfileid = (HiddenField)li.FindControl("hdnfileid");
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                ibc.update_incidents_attachfiles(hdnfileid.Value, userLogin.UserId, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    string errStr = string.Empty;
                    errbc.GetErrorMessage(errorCode, out errStr);
                }
                else
                {
                    appHelper.DeleteListViewItem(lv_partc_v_pi_attach, e.ItemIndex, "SESSION_LIST_CIP_ATTACHMENTS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lv_partc_v_pi_attach, "Error", ex.Message);
            }
        }

        protected void lv_partc_v_pis_attach_ItemCreated(object sender, ListViewItemEventArgs e)
        {
            try
            {
                ImageButton btnDelete = (ImageButton)e.Item.FindControl("btnDelete");
                if (userLogin.UserRole == "9")
                {
                    btnDelete.Visible = true;
                }
                else
                {
                    btnDelete.Visible = false;
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lv_partc_v_pis_attach, "Error", ex.Message);
            }
        }

        protected void lv_partc_v_pis_attach_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            string errorCode = string.Empty;
            CommonFun appHelper = new CommonFun();
            ErrorMessageBC errbc = new ErrorMessageBC();
            try
            {
                hdncurrenttab.Value = "2";
                ListViewDataItem li = lv_partc_v_pis_attach.Items[e.ItemIndex];
                LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");

                string filename = @lnkatt.Text;
                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);
                string pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {
                    File.Delete(filepath);
                }
                else if (File.Exists(pfilepath))
                {
                    File.Delete(pfilepath);
                }

                HiddenField hdnfileid = (HiddenField)li.FindControl("hdnfileid");
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                ibc.update_incidents_attachfiles(hdnfileid.Value, userLogin.UserId, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    string errStr = string.Empty;
                    errbc.GetErrorMessage(errorCode, out errStr);
                }
                else
                {
                    appHelper.DeleteListViewItem(lv_partc_v_pis_attach, e.ItemIndex, "SESSION_LIST_CIPS_ATTACHMENTS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lv_partc_v_pis_attach, "Error", ex.Message);
            }
        }

        protected void lv_partc_v_cp_attach_ItemCreated(object sender, ListViewItemEventArgs e)
        {
            try
            {
                ImageButton btnDelete = (ImageButton)e.Item.FindControl("btnDelete");
                if (userLogin.UserRole == "9")
                {
                    btnDelete.Visible = true;
                }
                else
                {
                    btnDelete.Visible = false;
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lv_partc_v_cp_attach, "Error", ex.Message);
            }
        }

        protected void lstPartCIPSAttach_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstPartCIPSAttach, "SESSION_LIST_CIPS_ATTACHMENTS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartCIPSAttach, "Error", ex.Message);
            }
        }

        protected void lstPartCIPSAttach_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                hdncurrenttab.Value = "2";
                ListViewDataItem li = lstPartCIPSAttach.Items[e.ItemIndex];
                LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");
                string filename = @lnkatt.Text;

                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);
                string pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {
                    File.Delete(filepath);
                }
                else if (File.Exists(pfilepath))
                {
                    File.Delete(pfilepath);
                }

                string errorCode = string.Empty;
                ErrorMessageBC errbc = new ErrorMessageBC();
                HiddenField hdnfileid = (HiddenField)li.FindControl("hdnfileid");
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                ibc.update_incidents_attachfiles(hdnfileid.Value, userLogin.UserId, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    string errStr = string.Empty;
                    errbc.GetErrorMessage(errorCode, out errStr);
                }

                appHelper.DeleteListViewItem(lstPartCIPSAttach, e.ItemIndex, "SESSION_LIST_CIPS_ATTACHMENTS");
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartCIPSAttach, "Error", ex.Message);
            }
        }

        protected void lst_ireport_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lst_ireport, "SESSION_LIST_ireport");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lst_ireport, "Error", ex.Message);
            }
        }

        protected void lst_ireport_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            string error_code = string.Empty;
            DataSet ds = new DataSet();
            DataTable dt = new DataTable();

            try
            {
                DropDownList ddl_injured_person = (DropDownList)lst_ireport.InsertItem.FindControl("ddl_injured_person");
                TextBox txtfourth_day_mc_date = (TextBox)lst_ireport.InsertItem.FindControl("txtfourth_day_mc_date");
                TextBox txtireport_no = (TextBox)lst_ireport.InsertItem.FindControl("txtireport_no");
                TextBox txtireport_date = (TextBox)lst_ireport.InsertItem.FindControl("txtireport_date");

                ViewState["iInjuredPerson_EmpNo"] = ddl_injured_person.SelectedValue.ToString();
                ViewState["itxtHospitalName"] = txtfourth_day_mc_date.Text;
                ViewState["itxtMCFrom"] = txtireport_no.Text;
                ViewState["itxtMCTo"] = txtireport_date.Text;

                appHelper.DeleteListViewItem(lst_ireport, e.ItemIndex, "SESSION_LIST_MC");
                ViewState["isNewRow"] = true;

            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lst_ireport, "Error", ex.Message);
            }
        }

        protected void lstViewML_PreRender(object sender, EventArgs e)
        {

        }

        protected void txtMCFrom_TextChanged(object sender, EventArgs e)
        {
            TextBox mcFrom = (TextBox)sender;
            string errorCode = string.Empty;
            TextBox mcTo = (TextBox)mcFrom.Parent.FindControl("txtMCTo");
            TextBox mcdays = (TextBox)mcFrom.Parent.FindControl("txtMCDays");
            decimal nodays;

            try
            {
                if (string.IsNullOrEmpty(mcFrom.Text))
                {

                    errorCode = "ERR-036";
                    baseHelper.popUpMessageSetfocus(lstViewPartC_4ML, "Error", errorCode, "2", mcFrom.ClientID);
                }
                else if (mcFrom.Text.Length > 0)
                {
                    if (DateTime.TryParseExact(mcFrom.Text, format, CultureInfo.InvariantCulture, DateTimeStyles.None, out DateTime dateTime) == false)
                    {
                        errorCode = "ERR-010";
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", mcFrom.ClientID);
                    }
                    else
                    {
                        if (mcTo.Text.Length > 0)
                        {
                            DateTime from = Convert.ToDateTime(mcFrom.Text);
                            DateTime to = Convert.ToDateTime(mcTo.Text);

                            if (from > to)
                            {
                                errorCode = "ERR-038";
                                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", mcFrom.ClientID);
                            }
                            else
                            {
                                nodays = Convert.ToDecimal(Convert.ToInt16((to - from).TotalDays) + 1);
                                mcdays.Text = string.Format("{0:0.0}", nodays);  
                            }
                        }
                    }
                }
                hdncurrenttab.Value = "2";
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(Page, "Error", ex.Message);
            }
        }

        protected void txtMCTo_TextChanged(object sender, EventArgs e)
        {
            hdncurrenttab.Value = "2";
            TextBox mcTo = (TextBox)sender;
            decimal nodays;

            string errorCode = string.Empty;
            TextBox mcFrom = (TextBox)mcTo.Parent.FindControl("txtMCFrom");
            TextBox mcdays = (TextBox)mcTo.Parent.FindControl("txtMCDays");
            try
            {
                if (string.IsNullOrEmpty(mcTo.Text))
                {

                    errorCode = "ERR-037";
                    baseHelper.popUpMessageSetfocus(lstViewPartC_4ML, "Error", errorCode, "2", mcTo.ClientID);
                }
                else if (mcTo.Text.Length > 0)
                {
                    if (DateTime.TryParseExact(mcTo.Text, format, CultureInfo.InvariantCulture, DateTimeStyles.None, out DateTime dateTime) == false)
                    {
                        errorCode = "ERR-010";
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", mcTo.ClientID);
                    }
                    else
                    {
                        DateTime from = Convert.ToDateTime(mcFrom.Text);
                        DateTime to = Convert.ToDateTime(mcTo.Text);
                        if (from > to)
                        {
                            errorCode = "ERR-038";
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "2", mcFrom.ClientID);
                        }
                        else
                        {
                            nodays = Convert.ToDecimal(Convert.ToInt16((to - from).TotalDays) + 1);
                            mcdays.Text = string.Format("{0:0.0}", nodays);  
                        }
                    }
                }
                hdncurrenttab.Value = "2";
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(Page, "Error", ex.Message);
            }
        }

        private void BindPartC(string incidentid)
        {
            try
            {
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                WorkflowIncidentBE ibe = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");

                DataSet wfds = ibc.get_wirs_incidents_workflows_by_id(incidentid, "03");
                int istatus = Convert.ToInt16(ibe.status);
                DataSet vds = ibc.validate_user_to_edit_inc(incidentid, userLogin.UserId, "MC");

                if (istatus == 2 && vds.Tables[0].Rows.Count > 0)
                {

                    InitPartC(incidentid);
                }

                else if (istatus > 2)
                {
                    pnl_V_PartC.Visible = true;

                    lblVPartC_CorrectiveandPreventiveAction.Text = string.Empty;

                    lblVPartCVNegligent.Text = string.Empty;
                    lblVPartCAdditional_Comment.Text = string.Empty;

                    lblVPartCName.Text = string.Empty;
                    lblVPartCEMPID.Text = string.Empty;
                    lblVPartCSubmissionDate.Text = string.Empty;
                    lblVPartCDesignation.Text = string.Empty;

                    lblVPartC_CorrectiveandPreventiveAction.Text = ibe.recommend_action_desc;

                    if (ibe.negligent.Equals("0"))
                    {
                        lblVPartCVNegligent.Text = "Negligent";
                    }
                    else
                    {
                        lblVPartCVNegligent.Text = "Non Negligent";
                    }
                    lblVPartCAdditional_Comment.Text = ibe.negligent_comments;
                    lblPartC_WSHORemarks.Text = ibe.what_happened_and_why_comments;

                    DataSet ipds = ibc.get_incidents_attachedfiles_by_id(ibe.incident_id, "part-c-ip-attach-doc", string.Empty);
                    attachmentdataBind(ipds.Tables[0], lv_partc_v_pi_attach, "SESSION_LIST_CIP_ATTACHMENTS");
                    DataSet ipsds = ibc.get_incidents_attachedfiles_by_id(ibe.incident_id, "part-c-wsho-s-attach-doc", string.Empty);
                    attachmentdataBind(ipsds.Tables[0], lv_partc_v_pis_attach, "SESSION_LIST_CIPS_ATTACHMENTS");
                    DataSet ccpds = ibc.get_incidents_attachedfiles_by_id(ibe.incident_id, "part-c-cp-attach-doc", string.Empty);
                    attachmentdataBind(ccpds.Tables[0], lv_partc_v_cp_attach, "SESSION_LIST_CCP_ATTACHMENTS");

                    DataSet partcds = new DataSet();
                    partcds = ibc.get_incident_partc_id(ibe);

                    lstViewPartC_ireport.DataSource = partcds.Tables[1];
                    lstViewPartC_ireport.DataBind();

                    lstVViewPartC_PersonInterviewed.DataSource = partcds.Tables[0];
                    lstVViewPartC_PersonInterviewed.DataBind();

                    DataSet idds = new DataSet();
                    DataSet mcds = new DataSet();
                    DataTable injureddetailsDT = new DataTable();
                    DataTable injureddetailsDisplayDT = new DataTable();
                    DataTable mcdt = new DataTable();

                    injureddetailsDisplayDT.TableName = "injured_details_display";
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("incident_id", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("injured_id", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("empname", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("part_of_body_injured", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("nature_injury", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("injured_description", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("attach_statement", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("head_neck_torso", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("upper_limbs", typeof(string)));
                    injureddetailsDisplayDT.Columns.Add(new DataColumn("lower_limps", typeof(string)));

                    injureddetailsDT.TableName = "injured_details";
                    injureddetailsDT.Columns.Add(new DataColumn("incident_id", typeof(string)));
                    injureddetailsDT.Columns.Add(new DataColumn("injured_id", typeof(string)));
                    injureddetailsDT.Columns.Add(new DataColumn("injury_type", typeof(string)));
                    injureddetailsDT.Columns.Add(new DataColumn("injury_code", typeof(string)));
                    injureddetailsDT.Columns.Add(new DataColumn("injury_name", typeof(string)));
                    injureddetailsDT.Columns.Add(new DataColumn("other_desc", typeof(string)));

                    mcdt.TableName = "injured_mc";
                    mcdt.Columns.Add(new DataColumn("incident_id", typeof(string)));
                    mcdt.Columns.Add(new DataColumn("injured_id", typeof(string)));
                    mcdt.Columns.Add(new DataColumn("injured_name", typeof(string)));
                    mcdt.Columns.Add(new DataColumn("hospital_clinic_name", typeof(string)));
                    mcdt.Columns.Add(new DataColumn("from_date", typeof(string)));
                    mcdt.Columns.Add(new DataColumn("to_date", typeof(string)));
                    mcdt.Columns.Add(new DataColumn("no_days", typeof(string)));
                    mcdt.Columns.Add(new DataColumn("morethan24hrs", typeof(string)));
                    mcdt.Columns.Add(new DataColumn("morethan24hrs_text", typeof(string)));
                    mcdt.Columns.Add(new DataColumn("attachment", typeof(string)));

                    injureddetailsDisplayDT.Rows.Clear();
                    injureddetailsDT.Rows.Clear();
                    mcdt.Rows.Clear();

                    DataTable ipdt = new DataTable();
                    ipdt = partcds.Tables[4];

                    foreach (DataRow iprow in ipdt.Rows)
                    {
                        string emp_no = iprow["injured_emp_no"].ToString();
                        DataSet idecds = new DataSet();
                        idecds.Tables.Clear();
                        idecds = ibc.get_injured_person_injury_description(ibe.incident_id, emp_no);
                        if (idecds.Tables[5].Rows.Count > 0)
                        {
                            for (int i = 0; i < idecds.Tables[5].Rows.Count; i++)
                            {
                                DataRow dr = idecds.Tables[5].Rows[i];
                                injureddetailsDisplayDT.Rows.Add(dr.ItemArray);
                            }
                        }

                        if (idecds.Tables[1].Rows.Count > 0)
                        {
                            for (int i = 0; i < idecds.Tables[1].Rows.Count; i++)
                            {
                                DataRow dr = idecds.Tables[1].Rows[i];
                                injureddetailsDT.Rows.Add(dr.ItemArray);
                            }
                        }

                        idds.Tables.Clear();
                        idds.Tables.Add(injureddetailsDisplayDT.Copy());
                        idds.Tables.Add(injureddetailsDT.Copy());
                        AppSession.SetSession("SESSION_LIST_PartC_3InjuredDetails", idds);

                        if (idecds.Tables[3].Rows.Count > 0)
                        {
                            for (int i = 0; i < idecds.Tables[3].Rows.Count; i++)
                            {
                                DataRow dr = idecds.Tables[3].Rows[i];
                                mcdt.Rows.Add(dr.ItemArray);

                            }
                        }

                        mcds.Tables.Clear();
                        mcds.Tables.Add(mcdt.Copy());
                        AppSession.SetSession("SESSION_LIST_PartC_4_MC", mcds);

                        lstPartC_3VInjuredPersonDetails.DataSource = injureddetailsDisplayDT;
                        lstPartC_3VInjuredPersonDetails.DataBind();

                        DataSet CIJPds = ibc.get_incidents_attachedfiles_by_id(ibe.incident_id, "part-c-ijp-attach-doc", string.Empty);
                        attachmentdataBind(CIJPds.Tables[0], lstPartCVIJPAttach, "SESSION_LIST_CIJP_ATTACHMENTS");

                        lstViewPartC_4VML.DataSource = mcds.Tables[0];
                        lstViewPartC_4VML.DataBind();
                        DataSet CIJMCds = ibc.get_incidents_attachedfiles_by_id(ibe.incident_id, "part-c-ijmr-attach-doc", string.Empty);
                        attachmentdataBind(CIJMCds.Tables[0], lstPartCVIJMCAttach, "SESSION_LIST_CIJMC_ATTACHMENTS");
                    }

                    lstVPartC_Incident_Analysis.DataSource = partcds.Tables[2];
                    lstVPartC_Incident_Analysis.DataBind();

                    workflowdataBind(wfds.Tables[0], gv_partc_workflow, lblVPartCName, lblVPartCEMPID, lblVPartCSubmissionDate, lblVPartCDesignation);
                }
                else
                {
                    pnl_PartC.Visible = true;

                    pnl_PartC_2.Visible = true;
                    pnl_PartC_3.Visible = true;
                    pnl_PartC_4.Visible = true;
                    pnl_PartC_5.Visible = true;
                    pnl_PartC_6.Visible = true;
                    pnl_PartC_7.Visible = true;

                    pnl_V_PartC.Visible = false;

                    if (wfds.Tables[0].Rows.Count > 0)
                    {
                        set_partc_table(); 
                    }
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(Page, "Error", ex.Message);
            }
        }

        #endregion Part C

        #region Part D

        private void InitPartD(string incidentid)
        {
            try
            {
                DataSet ids = new DataSet();
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                WorkflowIncidentBE iBE = new WorkflowIncidentBE
                {
                    incident_id = incidentid
                };
                ids = ibc.get_incident_by_id(iBE);
                if (iBE.status == "03")
                {
                    pnl_PartD.Visible = true;
                }

                txtPartBReviewandComment.Text = string.Empty;
                DataSet uds = new DataSet();
                DataSet wshods = new DataSet();
                DataSet hhodds = new DataSet();
                DataSet cds = new DataSet();

                string sba_code, sbu_code, department_code, location_code;
                sba_code = iBE.sba_code;
                sbu_code = iBE.sbu_code;
                department_code = iBE.department;
                location_code = iBE.location;

                UserBC uBC = new UserBC();
                uds = uBC.GetEmployeeInfoByEmployeeNo(userLogin.UserId);
                wshods = uBC.get_wsho_by_sbu(sba_code, sbu_code, department_code, location_code);
                hhodds = uBC.get_h_hod_by_sbu(sba_code, sbu_code, department_code, location_code);

                lblPartD_SubmittedName.Text = uds.Tables[0].Rows[0]["empname"].ToString();
                lblPartD_SubmittedNo.Text = userLogin.UserId;
                lblPartD_SubmittedDate.Text = DateTime.Now.ToString("dd-MMM-yyyy");
                lblPartD_SubmittedDesgnation.Text = uds.Tables[0].Rows[0]["empdesignation"].ToString();

                ddlPartD_WSHO.Items.Clear();
                ddlPartD_WSHO.DataSource = wshods;
                ddlPartD_WSHO.DataTextField = "empname";
                ddlPartD_WSHO.DataValueField = "empid";
                ddlPartD_WSHO.DataBind();
                ddlPartD_WSHO.SelectedValue = iBE.wsho_id;

                ddlPartD_HSBUID.Items.Clear();
                ddlPartD_HSBUID.DataSource = hhodds;
                ddlPartD_HSBUID.DataTextField = "empname";
                ddlPartD_HSBUID.DataValueField = "empid";
                ddlPartD_HSBUID.DataBind();
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(Page, "Error", ex.Message);
            }
        }

        private void BindPartD(WorkflowIncidentBE incidentBE)
        {
            WorkflowIncidentBC iBC = new WorkflowIncidentBC();
            DataSet wfds = iBC.get_wirs_incidents_workflows_by_id(incidentBE.incident_id, "04");

            int istatus = Convert.ToInt16(incidentBE.status);
            if (istatus > 3)
            {
                pnl_PartD.Visible = false;
                pnl_V_PartD.Visible = true;

                lblVPartDReviewandComment.Text = string.Empty;

                lblVPartDName.Text = string.Empty;
                lblVPartDID.Text = string.Empty;
                lblVPartDSubmittionDate.Text = string.Empty;
                lblVPartDDesignation.Text = string.Empty;

                if (wfds.Tables[0].Rows.Count > 0)
                {
                    pnl_V_PartD.Visible = true;
                    workflowdataBind(wfds.Tables[0], gv_partd_workflow, lblVPartDName, lblVPartDID, lblVPartDSubmittionDate, lblVPartDDesignation);
                    lblVPartDReviewandComment.Text = wfds.Tables[1].Rows[0]["remarks"].ToString();

                }
            }
            else
            {
                pnl_PartD.Visible = true;
                pnl_V_PartD.Visible = false;
            }
        }

        protected void btnPartDReverttoPartC_Click(object sender, EventArgs e)
        {

            hdncurrenttab.Value = "3"; 
            string errStr = string.Empty;
            string errtitle = string.Empty;
            try
            {
                string errorCode = string.Empty;
                bool errorFlag = false;

                if (string.IsNullOrEmpty(txtPartD_Comment.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-137";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "3", txtPartD_Comment.ClientID);
                }

                if (string.IsNullOrEmpty(ddlPartD_WSHO.SelectedValue.ToString()) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-135";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "3", ddlPartD_WSHO.ClientID);
                }

                if (errorFlag.Equals(false))
                {
                    WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                    WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");

                    iBE.status = "02";
                    string action_role = "WSHO";
                    setworkflow_data(iBE.incident_id, iBE.status, action_role, ddlPartD_WSHO.SelectedValue, txtPartD_Comment.Text);

                    action_role = "A_WSHO";
                    setworkflow_data(iBE.incident_id, iBE.status, action_role, iBE.awsho_id, string.Empty);

                    save_workflow_to(iBE.incident_id, out errorCode); 

                    DataSet wfds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "3", btnPartD.ClientID);
                    }
                    else
                    {
                        SendEmailNotification(iBE, "03", "02", wfds.Tables[0], txtPartD_Comment.Text.Trim(), out errorCode);
                        if (string.IsNullOrEmpty(errorCode))
                        {
                            errtitle = "Incident Report";
                            errStr = "SUC-001";
                        }
                        else
                        {
                            errtitle = "Notification";
                            errStr = errorCode;
                        }
                        Session.Remove("SESSION_LIST_WORKFLOWS");

                        baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errStr + ":" + ex.Message;
                baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
            }
        }

        protected void btnPartD_Click(object sender, EventArgs e)
        {
            string errtitle = string.Empty;
            string errStr = string.Empty;

            hdncurrenttab.Value = "3"; 
            try
            {
                string errorCode = string.Empty;
                bool errorFlag = false;

                if (string.IsNullOrEmpty(txtPartD_Comment.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-137";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "3", txtPartD_Comment.ClientID);
                }

                if (string.IsNullOrEmpty(ddlPartD_HSBUID.SelectedValue) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-133";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "3", ddlPartD_HSBUID.ClientID);
                }

                if (errorFlag.Equals(false))
                {
                    WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                    WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");

                    iBE.status = "04";
                    string action_role = "HSBU";
                    setworkflow_data(iBE.incident_id, iBE.status, action_role, ddlPartD_HSBUID.SelectedValue.Trim(), txtPartD_Comment.Text);

                    save_workflow_to(iBE.incident_id, out errorCode);
                    DataSet wfds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "3", btnPartD.ClientID);
                    }
                    else
                    {
                        SendEmailNotification(iBE, "03", "04", wfds.Tables[0], txtPartD_Comment.Text.Trim(), out errorCode);
                        if (string.IsNullOrEmpty(errorCode))
                        {
                            errtitle = "Incident Report";
                            errStr = "SUC-001";
                        }
                        else
                        {
                            errtitle = "Notification";
                            errStr = errorCode;
                        }
                        Session.Remove("SESSION_LIST_WORKFLOWS");
                        baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");

                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errStr + ":" + ex.Message;
                baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
            }
        }

        #endregion Part D

        #region partE

        protected void btnAddPartE_CopyTo_Click(object sender, EventArgs e)
        {
            try
            {
                bool errorFlag = false;
                string errorCode = string.Empty;
                Dictionary<string, string> colItems = new Dictionary<string, string>()
                    {
                        {"empid", txtPartE_CopyToID.Text},
                        {"empname", txtPartE_CopyToName.Text},
                        {"empdesignation", txtPartE_CopyToDesignation.Text}
                     };

                if (string.IsNullOrEmpty(txtPartE_CopyToName.Text) && errorFlag.Equals(false))
                {
                    errorFlag = true;
                    errorCode = "ERR-014";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "4", txtPartE_CopyToName.ClientID);
                }

                if (string.IsNullOrEmpty(txtPartE_CopyToID.Text) && errorFlag.Equals(false))
                {
                    errorFlag = true;
                    errorCode = "ERR-017";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "4", txtPartE_CopyToID.ClientID);
                }
                if (errorFlag.Equals(false))
                {
                    ViewState["empid"] = string.Empty;
                    ViewState["empname"] = string.Empty;
                    ViewState["empdesignation"] = string.Empty;

                    txtPartE_CopyToID.Text = string.Empty;
                    txtPartE_CopyToName.Text = string.Empty;
                    txtPartE_CopyToDesignation.Text = string.Empty;

                    appHelper.AddListViewItem(lstPartE_CopyTo, colItems, "SESSION_LIST_E_WORKFLOWS");
                }

                hdncurrenttab.Value = "4"; 
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartE_CopyTo, "Error", ex.Message);
            }
        }

        protected void lstPartE_CopyTo_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstPartE_CopyTo, "SESSION_LIST_E_WORKFLOWS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartE_CopyTo, "Error", ex.Message);
            }
        }

        protected void lstPartE_CopyTo_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {

                hdncurrenttab.Value = "4";
                appHelper.DeleteListViewItem(lstPartE_CopyTo, e.ItemIndex, "SESSION_LIST_E_WORKFLOWS");
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartE_CopyTo, "Error", ex.Message);
            }
        }

        protected void btnPartEReverttoPartC_Click(object sender, EventArgs e)
        {

            hdncurrenttab.Value = "4"; 
            string errtitle = string.Empty;
            string errStr = string.Empty;
            try
            {
                string errorCode = string.Empty;
                bool errorFlag = false;

                if (string.IsNullOrEmpty(txtPartE_Comment.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-137";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "4", txtPartE_Comment.ClientID);
                }

                if (string.IsNullOrEmpty(ddlPartE_WSHO.SelectedValue.ToString()) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-135";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "4", ddlPartE_WSHO.ClientID);
                }

                if (errorFlag.Equals(false))
                {
                    WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                    WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");

                    iBE.status = "02";
                    string action_role = "COPYTO";

                    foreach (ListItem li in chkPartEEmailTo.Items)
                    {
                        if (li.Selected)
                        {
                            string copyto_usrid = string.Empty;
                            copyto_usrid = li.Value;
                            setworkflow_data(iBE.incident_id, iBE.status, action_role, copyto_usrid, string.Empty);
                        }
                    }

                    foreach (ListViewDataItem lstViewItem in lstPartE_CopyTo.Items)
                    {
                        TextBox txtPartE_CopyToEmpNo = (TextBox)lstViewItem.FindControl("txtPartE_CopyToEmpNo");
                        if (txtPartE_CopyToEmpNo.Text.Trim() != string.Empty)
                        {
                            setworkflow_data(iBE.incident_id, iBE.status, action_role, txtPartE_CopyToEmpNo.Text.Trim(), string.Empty);
                        }
                    }
                    action_role = "WSHO";
                    setworkflow_data(iBE.incident_id, iBE.status, action_role, ddlPartE_WSHO.SelectedValue, txtPartE_Comment.Text);

                    action_role = "A_WSHO";
                    setworkflow_data(iBE.incident_id, iBE.status, action_role, iBE.awsho_id, string.Empty);

                    save_workflow_to(iBE.incident_id, out errorCode); 
                    DataSet wfds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");
                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "4", btnPartEReverttoPartC.ClientID);
                    }
                    else
                    {
                        SendEmailNotification(iBE, "04", "02", wfds.Tables[0], txtPartE_Comment.Text.Trim(), out errorCode);
                        if (string.IsNullOrEmpty(errorCode))
                        {
                            errtitle = "Incident Report";
                            errStr = "SUC-001";
                        }
                        else
                        {
                            errtitle = "Notification";
                            errStr = errorCode;
                        }
                        Session.Remove("SESSION_LIST_WORKFLOWS");
                        baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");

                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errStr + ":" + ex.Message;
                baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
            }
        }

        protected void btnPartE_Click(object sender, EventArgs e)
        {

            hdncurrenttab.Value = "4"; 
            string errStr = string.Empty;
            string errtitle = string.Empty;
            try
            {
                string errorCode = string.Empty;
                bool errorFlag = false;

                if (string.IsNullOrEmpty(txtPartE_Comment.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-134";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "4", txtPartE_Comment.ClientID);
                }

                if (string.IsNullOrEmpty(ddlPartE_HOD.SelectedValue.ToString()) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-133";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "4", ddlPartE_HOD.ClientID);
                }

                if (errorFlag.Equals(false))
                {
                    WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                    WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");

                    iBE.status = "05";
                    string action_role = "COPYTO";

                    foreach (ListItem li in chkPartEEmailTo.Items)
                    {
                        if (li.Selected)
                        {
                            string copyto_usrid = string.Empty;
                            copyto_usrid = li.Value;
                            setworkflow_data(iBE.incident_id, iBE.status, action_role, copyto_usrid, string.Empty);
                        }
                    }

                    foreach (ListViewDataItem lstViewItem in lstPartE_CopyTo.Items)
                    {
                        TextBox txtPartE_CopyToEmpNo = (TextBox)lstViewItem.FindControl("txtPartE_CopyToEmpNo");
                        if (txtPartE_CopyToEmpNo.Text.Trim() != string.Empty)
                        {
                            setworkflow_data(iBE.incident_id, iBE.status, action_role, txtPartE_CopyToEmpNo.Text.Trim(), string.Empty);
                        }
                    }
                    action_role = "HOD";
                    setworkflow_data(iBE.incident_id, iBE.status, action_role, ddlPartE_HOD.SelectedValue.ToString(), txtPartE_Comment.Text);

                    save_workflow_to(iBE.incident_id, out errorCode);

                    DataSet wfds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "4", btnPartE.ClientID);
                    }
                    else
                    {
                        SendEmailNotification(iBE, "04", "05", wfds.Tables[0], txtPartE_Comment.Text.Trim(), out errorCode);
                        if (string.IsNullOrEmpty(errorCode))
                        {
                            errtitle = "Incident Report";
                            errStr = "SUC-001";
                        }
                        else
                        {
                            errtitle = "Notification";
                            errStr = errorCode;
                        }
                        Session.Remove("SESSION_LIST_WORKFLOWS");
                        baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");

                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errStr + ":" + ex.Message;
                baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
            }
        }

        private void BindPartE(WorkflowIncidentBE incidentBE)
        {
            WorkflowIncidentBC iBC = new WorkflowIncidentBC();
            DataSet wfds = iBC.get_wirs_incidents_workflows_by_id(incidentBE.incident_id, "05");

            int istatus = Convert.ToInt16(incidentBE.status);
            if (istatus > 4)
            {
                pnl_PartE.Visible = false;
                pnl_V_PartE.Visible = true;

                lblVPartEReviewandComment.Text = string.Empty;

                lblVPartEName.Text = string.Empty;
                lblVPartEID.Text = string.Empty;
                lblVPartESubmittionDate.Text = string.Empty;
                lblVPartEDesignation.Text = string.Empty;

                if (wfds.Tables[0].Rows.Count > 0)
                {
                    pnl_V_PartE.Visible = true;
                    workflowdataBind(wfds.Tables[0], gv_parte_workflow, lblVPartEName, lblVPartEID, lblVPartESubmittionDate, lblVPartEDesignation);
                    lblVPartEReviewandComment.Text = wfds.Tables[1].Rows[0]["remarks"].ToString();

                }
            }
            else
            {
                pnl_PartE.Visible = true;
                pnl_V_PartE.Visible = false;
            }
        }

        private void InitPartE(string incidentid)
        {
            DataSet ids = new DataSet();
            WorkflowIncidentBC ibc = new WorkflowIncidentBC();

            WorkflowIncidentBE iBE = new WorkflowIncidentBE
            {
                incident_id = incidentid
            };
            ids = ibc.get_incident_by_id(iBE);
            if (iBE.status == "04")
            {
                pnl_PartE.Visible = true;
            }

            txtPartE_Comment.Text = string.Empty;
            DataSet uds = new DataSet();
            DataSet wshods = new DataSet();
            DataSet hodds = new DataSet();
            DataSet copytods = new DataSet();

            string sba_code, sbu_code, department_code, location_code;
            sba_code = iBE.sba_code;
            sbu_code = iBE.sbu_code;
            department_code = iBE.department;
            location_code = iBE.location;
            UserBC uBC = new UserBC();
            uds = uBC.GetEmployeeInfoByEmployeeNo(userLogin.UserId);
            wshods = uBC.get_wsho_by_sbu(sba_code, sbu_code, department_code, location_code);
            hodds = uBC.get_hod_by_sbu(sba_code, sbu_code, department_code, location_code);
            copytods = uBC.get_active_cclist_by_sbu(sba_code, sbu_code, department_code, location_code);

            lblPartE_SubmittedName.Text = uds.Tables[0].Rows[0]["empname"].ToString();
            lblPartE_SubmittedNo.Text = userLogin.UserId;
            lblPartE_SubmittedDate.Text = DateTime.Now.ToString("dd-MMM-yyyy");
            lblPartE_SubmittedDesgnation.Text = uds.Tables[0].Rows[0]["empdesignation"].ToString();

            appHelper.BindCodeToListControl(ddlPartE_WSHO, wshods, "empname", "empid", string.Empty);
            ddlPartE_WSHO.SelectedValue = iBE.wsho_id;

            appHelper.BindCodeToListControl(ddlPartE_HOD, hodds, "empname", "empid", string.Empty);
            ddlPartE_HOD.SelectedValue = iBE.hod_id;

            appHelper.BindCheckBoxList(chkPartEEmailTo, copytods, "empname", "empid");
            foreach (ListItem li in chkPartEEmailTo.Items)
            {
                li.Selected = true;
            }
        }

        #endregion partE

        #region Part F

        private void InitPartF(string incidentid)
        {
            DataSet ids = new DataSet();
            WorkflowIncidentBC ibc = new WorkflowIncidentBC();

            WorkflowIncidentBE iBE = new WorkflowIncidentBE
            {
                incident_id = incidentid
            };
            ids = ibc.get_incident_by_id(iBE);
            if (iBE.status == "05")
            {
                pnl_PartF.Visible = true;
            }
            txtPartF_Comment.Text = string.Empty;
            DataSet uds = new DataSet();
            DataSet wshods = new DataSet();

            string sba_code, sbu_code, department_code, location_code;
            sba_code = iBE.sba_code;
            sbu_code = iBE.sbu_code;
            department_code = iBE.department;
            location_code = iBE.location;

            UserBC uBC = new UserBC();
            uds = uBC.GetEmployeeInfoByEmployeeNo(userLogin.UserId);
            wshods = uBC.get_wsho_by_sbu(sba_code, sbu_code, department_code, location_code);

            if (iBE.status == "05")
            {

                lblVPartF_PCComment.Text = iBE.recommend_action_desc;
                DataSet rwfds = ibc.get_wirs_incidents_workflows_by_id(iBE.incident_id, "04");

                lblVPartF_PDComment.Text = rwfds.Tables[1].Rows[0]["remarks"].ToString();
                rwfds = ibc.get_wirs_incidents_workflows_by_id(iBE.incident_id, "05");

                lblVPartF_PEComment.Text = rwfds.Tables[1].Rows[0]["remarks"].ToString();
            }

            lblPartF_SubmittedName.Text = uds.Tables[0].Rows[0]["empname"].ToString();
            lblPartF_SubmittedNo.Text = userLogin.UserId;
            lblPartF_SubmittedDate.Text = DateTime.Now.ToString("dd-MMM-yyyy");
            lblPartF_SubmittedDesgnation.Text = uds.Tables[0].Rows[0]["empdesignation"].ToString();

            ddlPartF_WSHO.Items.Clear();
            ddlPartF_WSHO.DataSource = wshods;
            ddlPartF_WSHO.DataTextField = "empname";
            ddlPartF_WSHO.DataValueField = "empid";
            ddlPartF_WSHO.DataBind();
            ddlPartF_WSHO.SelectedValue = iBE.wsho_id;

            appHelper.SetupLookUpRadiolist(rdorisk, "RiskAssessment");

            DataSet wfds = ibc.get_wirs_incidents_workflows_by_id(iBE.incident_id, "06");
            if (wfds.Tables[0].Rows.Count > 0)
            {
                txtPartF_Comment.Text = iBE.risk_assessment_review_comments;
                rdorisk.SelectedValue = iBE.risk_assessment_review;

                DataSet ipds = ibc.get_incidents_attachedfiles_by_id(iBE.incident_id, "part-f-attach-doc", string.Empty);
                attachmentdataBind(ipds.Tables[0], lstPartFAttach, "SESSION_LIST_F_ATTACHMENTS");
                DataSet irpds = ibc.get_incidents_attachedfiles_by_id(iBE.incident_id, "part-f-attach-doc", string.Empty);
                attachmentdataBind(irpds.Tables[0], lstPartFriskAttach, "SESSION_LIST_FRISK_ATTACHMENTS");
            }
        }

        private void BindPartF(WorkflowIncidentBE incidentBE)
        {
            try
            {
                WorkflowIncidentBC iBC = new WorkflowIncidentBC();
                DataSet wfds = iBC.get_wirs_incidents_workflows_by_id(incidentBE.incident_id, "06");

                int istatus = Convert.ToInt16(incidentBE.status);
                if (istatus > 5)
                {
                    pnl_PartF.Visible = false;
                    pnl_V_PartF.Visible = true;

                    lblVPartFReviewandComment.Text = string.Empty;

                    lblVPartFName.Text = string.Empty;
                    lblVPartFID.Text = string.Empty;
                    lblVPartFSubmittionDate.Text = string.Empty;
                    lblVPartFDesignation.Text = string.Empty;

                    lblVPartFRiskAssessmentReview.Text = incidentBE.risk_assessment_review_desc;
                    lblVPartFReviewandComment.Text = incidentBE.risk_assessment_review_comments;

                    workflowdataBind(wfds.Tables[0], gv_partf_workflow, lblVPartFName, lblVPartFID, lblVPartFSubmittionDate, lblVPartFDesignation);

                    DataSet ds = iBC.get_incidents_attachedfiles_by_id(incidentBE.incident_id, "part-f-attach-doc", string.Empty);
                    attachmentdataBind(ds.Tables[0], lv_partf_v_attach, "SESSION_LIST_F_ATTACHMENTS");
                    DataSet riskds = iBC.get_incidents_attachedfiles_by_id(incidentBE.incident_id, "part-f-risk-attach-doc", string.Empty);
                    attachmentdataBind(riskds.Tables[0], lv_partf_v_riskattach, "SESSION_LIST_FRISK_ATTACHMENTS");
                }
                else
                {
                    pnl_V_PartF.Visible = false;
                    pnl_PartF.Visible = true;
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpClosingWindow(Page, "Error", ex.Message);
            }
        }

        protected void imgBtnAttPartF_Click(object sender, ImageClickEventArgs e)
        {
            string errorCode = string.Empty;
            try
            {

                if (uploadAttPartF.HasFile.Equals(false))
                {

                    errorCode = "ERR-066";
                    baseHelper.popUpMessageSetfocus(imgBtnAttPartF, "Error", errorCode, "5", uploadAttPartF.ClientID);
                }
                else
                {
                    foreach (HttpPostedFile uploadedFile in uploadAttPartF.PostedFiles)
                    {

                        string fileExtension = Path.GetExtension(uploadedFile.FileName);

                        bool isValidFileExtension = appHelper.IsValidFileExtension(fileExtension.Replace('.', ' ').Trim());
                        if (isValidFileExtension == false)
                        {
                            errorCode = "ERR-067";
                            baseHelper.popUpMessageSetfocus(imgBtnAttPartF, "Error", errorCode, "5", uploadAttPartF.ClientID);
                        }
                        else
                        {

                            double DOmaxByteSize = appHelper.MegabytesToBytes(Convert.ToInt32(ConfigurationManager.AppSettings["CertiMaxFileSize_MB"].ToString()));

                            if (uploadAttPartF.PostedFile.ContentLength > DOmaxByteSize)
                            {
                                string message = string.Format("Your attachment has exceeded the limit of {0}MB. Please scan your document at 300dpi or lower.", ConfigurationManager.AppSettings["DOMaxFileSize_MB"].ToString());
                                string htmlTags = string.Format("javascript:popUpMessageSetfocus('{0}','{1}','{2}','{3}');", "Error", message, 5, uploadAttPartF.ClientID);
                                ScriptManager.RegisterStartupScript(imgBtnAttPartF, this.GetType(), "popUpMessageSetfocusScript", htmlTags, true);
                            }
                            else
                            {

                                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();

                                WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                                string incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks;

                                incident_id = iBE.incident_id;
                                attachment_type = "part-f-attach-doc";
                                reference_code = string.Empty;
                                file_extension = Path.GetExtension(uploadedFile.FileName);
                                file_id = Guid.NewGuid().ToString() + file_extension;
                                file_name = incident_id + "-F-" + Path.GetFileName(uploadedFile.FileName);
                                file_path = Server.MapPath(tempFolderPath);
                                file_desc = string.Empty;
                                remarks = string.Empty;

                                uploadedFile.SaveAs(Server.MapPath(tempFolderPath + file_name));

                                set_attach_docs("SESSION_LIST_F_ATTACHMENTS", incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks, lstPartFAttach);
                            }
                        }
                    }
                }

                hdncurrenttab.Value = "5"; 
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(imgBtnAttPartF, "Error", ex.Message);
            }
        }

        protected void lstPartFAttach_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstPartFAttach, "SESSION_LIST_F_ATTACHMENTS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartFAttach, "Error", ex.Message);
            }
        }

        protected void lstPartFAttach_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                hdncurrenttab.Value = "5";
                ListViewDataItem li = lstPartFAttach.Items[e.ItemIndex];
                LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");
                string filename = @lnkatt.Text;

                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);
                string pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {
                    File.Delete(filepath);
                }
                else if (File.Exists(pfilepath))
                {
                    File.Delete(pfilepath);
                }

                string errorCode = string.Empty;
                ErrorMessageBC errbc = new ErrorMessageBC();
                HiddenField hdnfileid = (HiddenField)li.FindControl("hdnfileid");
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                ibc.update_incidents_attachfiles(hdnfileid.Value, userLogin.UserId, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    string errStr = string.Empty;
                    errbc.GetErrorMessage(errorCode, out errStr);
                }

                appHelper.DeleteListViewItem(lstPartFAttach, e.ItemIndex, "SESSION_LIST_F_ATTACHMENTS");
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartFAttach, "Error", ex.Message);
            }
        }

        protected void imgBtnriskAttPartF_Click(object sender, ImageClickEventArgs e)
        {
            string errorCode = string.Empty;
            try
            {

                if (uploadriskAttPartF.HasFile.Equals(false))
                {

                    errorCode = "ERR-066";
                    baseHelper.popUpMessageSetfocus(imgBtnAttPartF, "Error", errorCode, "5", uploadriskAttPartF.ClientID);
                }
                else
                {
                    foreach (HttpPostedFile uploadedFile in uploadriskAttPartF.PostedFiles)
                    {

                        string fileExtension = Path.GetExtension(uploadedFile.FileName);

                        bool isValidFileExtension = appHelper.IsValidFileExtension(fileExtension.Replace('.', ' ').Trim());
                        if (isValidFileExtension == false)
                        {
                            errorCode = "ERR-067";
                            baseHelper.popUpMessageSetfocus(imgBtnAttPartF, "Error", errorCode, "5", uploadriskAttPartF.ClientID);
                        }
                        else
                        {

                            double DOmaxByteSize = appHelper.MegabytesToBytes(Convert.ToInt32(ConfigurationManager.AppSettings["CertiMaxFileSize_MB"].ToString()));

                            if (uploadAttPartF.PostedFile.ContentLength > DOmaxByteSize)
                            {
                                string message = string.Format("Your attachment has exceeded the limit of {0}MB. Please scan your document at 300dpi or lower.", ConfigurationManager.AppSettings["DOMaxFileSize_MB"].ToString());
                                string htmlTags = string.Format("javascript:popUpMessageSetfocus('{0}','{1}','{2}','{3}');", "Error", message, 5, uploadriskAttPartF.ClientID);
                                ScriptManager.RegisterStartupScript(imgBtnriskAttPartF, this.GetType(), "popUpMessageSetfocusScript", htmlTags, true);
                            }
                            else
                            {

                                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();

                                WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                                string incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks;

                                incident_id = iBE.incident_id;
                                attachment_type = "part-f-risk-attach-doc";
                                reference_code = string.Empty;
                                file_extension = Path.GetExtension(uploadedFile.FileName);
                                file_id = string.Empty;
                                file_name = incident_id + "-F-RISK-" + Path.GetFileName(uploadedFile.FileName);
                                file_path = Server.MapPath(tempFolderPath);
                                file_desc = string.Empty;
                                remarks = string.Empty;

                                uploadedFile.SaveAs(Server.MapPath(tempFolderPath + file_name));

                                set_attach_docs("SESSION_LIST_FRISK_ATTACHMENTS", incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks, lstPartFriskAttach);
                            }
                        }
                    }
                }

                hdncurrenttab.Value = "5"; 
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(imgBtnAttPartF, "Error", ex.Message);
            }
        }

        protected void lstPartFriskAttach_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstPartFriskAttach, "SESSION_LIST_FRISK_ATTACHMENTS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartFriskAttach, "Error", ex.Message);
            }
        }

        protected void lstPartFriskAttach_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                hdncurrenttab.Value = "5";
                ListViewDataItem li = lstPartFriskAttach.Items[e.ItemIndex];
                LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");
                string filename = @lnkatt.Text;

                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);
                string pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {
                    File.Delete(filepath);
                }
                else if (File.Exists(pfilepath))
                {
                    File.Delete(pfilepath);
                }

                string errorCode = string.Empty;
                ErrorMessageBC errbc = new ErrorMessageBC();
                HiddenField hdnfileid = (HiddenField)li.FindControl("hdnfileid");
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                ibc.update_incidents_attachfiles(hdnfileid.Value, userLogin.UserId, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    string errStr = string.Empty;
                    errbc.GetErrorMessage(errorCode, out errStr);
                }

                appHelper.DeleteListViewItem(lstPartFriskAttach, e.ItemIndex, "SESSION_LIST_FRISK_ATTACHMENTS");
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartFAttach, "Error", ex.Message);
            }
        }

        protected void btnPartF_Click(object sender, EventArgs e)
        {

            hdncurrenttab.Value = "5"; 
            string errtitle = string.Empty;
            string errStr = string.Empty;
            try
            {
                string errorCode = string.Empty;
                bool errorFlag = false;

                if (string.IsNullOrEmpty(txtPartF_Comment.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-137";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "5", txtPartF_Comment.ClientID);
                }

                if (string.IsNullOrEmpty(rdorisk.SelectedValue) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-116";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "5", rdorisk.ClientID);
                }

                if (string.IsNullOrEmpty(ddlPartF_WSHO.SelectedValue.ToString()) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-133";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "5", ddlPartF_WSHO.ClientID);
                }

                if (errorFlag.Equals(false))
                {
                    WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                    WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");

                    iBE.risk_assessment_review = rdorisk.SelectedValue;
                    iBE.risk_assessment_review_comments = txtPartF_Comment.Text;
                    iBE.status = "06";
                    iBE.modified_by = userLogin.UserId;

                    ibc.update_Incidents(iBE, out errorCode);
                    if (string.IsNullOrEmpty(errorCode))
                    {
                        string action_role = "WSHO";
                        setworkflow_data(iBE.incident_id, iBE.status, action_role, ddlPartF_WSHO.SelectedValue.ToString(), txtPartF_Comment.Text);

                        save_workflow_to(iBE.incident_id, out errorCode);
                        if (!string.IsNullOrEmpty(errorCode))
                        {
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "5", btnPartF.ClientID);
                        }
                        else
                        {
                            save_attachfiles("SESSION_LIST_F_ATTACHMENTS", lstPartFAttach, out errorCode);
                            if (!string.IsNullOrEmpty(errorCode))
                            {
                                baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "5", btnPartF.ClientID);
                            }
                            else
                            {
                                save_attachfiles("SESSION_LIST_FRISK_ATTACHMENTS", lstPartFriskAttach, out errorCode);
                                if (!string.IsNullOrEmpty(errorCode))
                                {
                                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "5", btnPartF.ClientID);
                                }

                                DataSet wfds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                                if (!string.IsNullOrEmpty(errorCode))
                                {
                                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "5", btnPartF.ClientID);
                                }
                                else
                                {
                                    SendEmailNotification(iBE, "05", "06", wfds.Tables[0], txtPartF_Comment.Text.Trim(), out errorCode);
                                    if (string.IsNullOrEmpty(errorCode))
                                    {
                                        errtitle = "Incident Report";
                                        errStr = "SUC-001";
                                    }
                                    else
                                    {
                                        errtitle = "Notification";
                                        errStr = errorCode;
                                    }
                                    Session.Remove("SESSION_LIST_WORKFLOWS");
                                    Session.Remove("SESSION_LIST_F_ATTACHMENTS");
                                    Session.Remove("SESSION_LIST_FRISK_ATTACHMENTS");
                                    baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");

                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errStr + ":" + ex.Message;
                baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
            }
        }

        protected void lv_partf_v_attach_ItemCreated(object sender, ListViewItemEventArgs e)
        {
            try
            {
                ImageButton btnDelete = (ImageButton)e.Item.FindControl("btnDelete");
                if (userLogin.UserRole == "9")
                {
                    btnDelete.Visible = true;
                }
                else
                {
                    btnDelete.Visible = false;
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lv_partf_v_attach, "Error", ex.Message);
            }
        }

        protected void lv_partf_v_attach_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            string errorCode = string.Empty;
            ErrorMessageBC errbc = new ErrorMessageBC();
            CommonFun appHelper = new CommonFun();
            try
            {
                hdncurrenttab.Value = "5";
                ListViewDataItem li = lv_partf_v_attach.Items[e.ItemIndex];
                LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");

                string filename = @lnkatt.Text;
                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);
                string pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {
                    File.Delete(filepath);
                }
                else if (File.Exists(pfilepath))
                {
                    File.Delete(pfilepath);
                }

                HiddenField hdnfileid = (HiddenField)li.FindControl("hdnfileid");
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                ibc.update_incidents_attachfiles(hdnfileid.Value, userLogin.UserId, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    string errStr = string.Empty;
                    errbc.GetErrorMessage(errorCode, out errStr);
                }
                else
                {
                    appHelper.DeleteListViewItem(lv_partf_v_attach, e.ItemIndex, "SESSION_LIST_F_ATTACHMENTS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lv_partf_v_attach, "Error", ex.Message);
            }
        }

        protected void lv_partf_v_riskattach_ItemCreated(object sender, ListViewItemEventArgs e)
        {
            try
            {
                ImageButton btnDelete = (ImageButton)e.Item.FindControl("btnDelete");

                if (userLogin.UserRole == "9")
                {
                    btnDelete.Visible = true;
                }
                else
                {
                    btnDelete.Visible = false;
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lv_partf_v_riskattach, "Error", ex.Message);
            }
        }

        protected void lv_partf_v_riskattach_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            string errorCode = string.Empty;
            CommonFun appHelper = new CommonFun();
            ErrorMessageBC errbc = new ErrorMessageBC();

            try
            {
                hdncurrenttab.Value = "5";
                ListViewDataItem li = lv_partf_v_riskattach.Items[e.ItemIndex];
                LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");

                string filename = @lnkatt.Text;
                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);
                string pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {
                    File.Delete(filepath);
                }
                else if (File.Exists(pfilepath))
                {
                    File.Delete(pfilepath);
                }

                HiddenField hdnfileid = (HiddenField)li.FindControl("hdnfileid");
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                ibc.update_incidents_attachfiles(hdnfileid.Value, userLogin.UserId, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    string errStr = string.Empty;
                    errbc.GetErrorMessage(errorCode, out errStr);
                }
                else
                {
                    appHelper.DeleteListViewItem(lv_partf_v_riskattach, e.ItemIndex, "SESSION_LIST_FRISK_ATTACHMENTS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lv_partf_v_riskattach, "Error", ex.Message);
            }
        }

        #endregion Part F

        #region Part G

        private void InitPartG(string incidentid)
        {
            DataSet ids = new DataSet();
            WorkflowIncidentBC ibc = new WorkflowIncidentBC();

            WorkflowIncidentBE iBE = new WorkflowIncidentBE
            {
                incident_id = incidentid
            };
            ids = ibc.get_incident_by_id(iBE);
            if (iBE.status == "06")
            {
                pnl_PartG.Visible = true;
            }
            txtPartG_Comment.Text = string.Empty;
            DataSet uds = new DataSet();
            DataSet cwshods = new DataSet();
            DataSet hodds = new DataSet();

            string sba_code, sbu_code, department_code, location_code;
            sba_code = iBE.sba_code;
            sbu_code = iBE.sbu_code;
            department_code = iBE.department;
            location_code = iBE.location;

            UserBC uBC = new UserBC();
            uds = uBC.GetEmployeeInfoByEmployeeNo(userLogin.UserId);
            cwshods = uBC.get_c_wsho_by_sbu(sba_code, sbu_code, department_code, location_code);
            hodds = uBC.get_hod_by_sbu(sba_code, sbu_code, department_code, location_code);

            lblPartG_SubmittedName.Text = uds.Tables[0].Rows[0]["empname"].ToString();
            lblPartG_SubmittedNo.Text = userLogin.UserId;
            lblPartG_SubmittedDate.Text = DateTime.Now.ToString("dd-MMM-yyyy");
            lblPartG_SubmittedDesgnation.Text = uds.Tables[0].Rows[0]["empdesignation"].ToString();

            ddlPartG_CWSHO.Items.Clear();
            ddlPartG_CWSHO.DataSource = cwshods;
            ddlPartG_CWSHO.DataTextField = "empname";
            ddlPartG_CWSHO.DataValueField = "empid";
            ddlPartG_CWSHO.DataBind();
            ddlPartG_CWSHO.SelectedValue = iBE.cwsho_id;

            ddlPartG_HOD.Items.Clear();
            ddlPartG_HOD.DataSource = hodds;
            ddlPartG_HOD.DataTextField = "empname";
            ddlPartG_HOD.DataValueField = "empid";
            ddlPartG_HOD.DataBind();
            ddlPartG_HOD.SelectedValue = iBE.hod_id;

            appHelper.SetupLookUpRadiolist(rdorisk, "RiskAssessment");

            DataSet wfds = ibc.get_wirs_incidents_workflows_by_id(iBE.incident_id, "07");
            if (wfds.Tables[0].Rows.Count > 0)
            {
                DataSet ipds = ibc.get_incidents_attachedfiles_by_id(iBE.incident_id, "part-g-attach-doc", string.Empty);
                attachmentdataBind(ipds.Tables[0], lstPartGAttach, "SESSION_LIST_G_ATTACHMENTS");
            }
        }

        private void BindPartG(WorkflowIncidentBE incidentBE)
        {
            WorkflowIncidentBC iBC = new WorkflowIncidentBC();
            DataSet wfds = iBC.get_wirs_incidents_workflows_by_id(incidentBE.incident_id, "07");

            int istatus = Convert.ToInt16(incidentBE.status);
            if (istatus > 6)
            {
                pnl_PartG.Visible = false;
                pnl_V_PartG.Visible = true;

                lblVPartGReviewandComment.Text = string.Empty;

                lblVPartGName.Text = string.Empty;
                lblVPartGID.Text = string.Empty;
                lblVPartGSubmittionDate.Text = string.Empty;
                lblVPartGDesignation.Text = string.Empty;

                if (wfds.Tables[0].Rows.Count > 0)
                {
                    pnl_V_PartG.Visible = true;
                    workflowdataBind(wfds.Tables[0], gv_partg_workflow, lblVPartGName, lblVPartGID, lblVPartGSubmittionDate, lblVPartGDesignation);
                    lblVPartGReviewandComment.Text = wfds.Tables[1].Rows[0]["remarks"].ToString();

                }

                DataSet ds = iBC.get_incidents_attachedfiles_by_id(incidentBE.incident_id, "part-g-attach-doc", string.Empty);
                attachmentdataBind(ds.Tables[0], lv_partg_v_attach, "SESSION_LIST_G_ATTACHMENTS");
            }
            else
            {
                pnl_PartG.Visible = true;
                pnl_V_PartG.Visible = false;
            }
        }

        protected void imgBtnAttPartG_Click(object sender, ImageClickEventArgs e)
        {
            string errorCode = string.Empty;
            try
            {

                if (uploadAttPartG.HasFile.Equals(false))
                {

                    errorCode = "ERR-066";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "6", imgBtnAttPartG.ClientID);
                }
                else
                {
                    foreach (HttpPostedFile uploadedFile in uploadAttPartG.PostedFiles)
                    {

                        string fileExtension = Path.GetExtension(uploadedFile.FileName);

                        bool isValidFileExtension = appHelper.IsValidFileExtension(fileExtension.Replace('.', ' ').Trim());
                        if (isValidFileExtension == false)
                        {
                            errorCode = "ERR-067";
                            baseHelper.popUpMessageSetfocus(imgBtnAttPartG, "Error", errorCode, "6", uploadAttPartG.ClientID);
                        }
                        else
                        {

                            double DOmaxByteSize = appHelper.MegabytesToBytes(Convert.ToInt32(ConfigurationManager.AppSettings["CertiMaxFileSize_MB"].ToString()));

                            if (uploadAttPartG.PostedFile.ContentLength > DOmaxByteSize)
                            {
                                string message = string.Format("Your attachment has exceeded the limit of {0}MB. Please scan your document at 300dpi or lower.", ConfigurationManager.AppSettings["DOMaxFileSize_MB"].ToString());
                                string htmlTags = string.Format("javascript:popUpMessageSetfocus('{0}','{1}','{2}','{3}');", "Error", message, 6, uploadAttPartG.ClientID);
                                ScriptManager.RegisterStartupScript(imgBtnAttPartG, this.GetType(), "popUpMessageSetfocusScript", htmlTags, true);
                            }
                            else
                            {

                                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();

                                WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");
                                string incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks;

                                incident_id = iBE.incident_id;
                                attachment_type = "part-g-attach-doc";
                                reference_code = string.Empty;
                                file_extension = Path.GetExtension(uploadedFile.FileName);
                                file_id = Guid.NewGuid().ToString() + file_extension;
                                file_name = incident_id + "-G-" + Path.GetFileName(uploadedFile.FileName);
                                file_path = Server.MapPath(tempFolderPath);
                                file_desc = string.Empty;
                                remarks = string.Empty;

                                uploadedFile.SaveAs(Server.MapPath(tempFolderPath + file_name));

                                set_attach_docs("SESSION_LIST_G_ATTACHMENTS", incident_id, attachment_type, reference_code, file_id, file_name, file_path, file_extension, file_desc, remarks, lstPartGAttach);
                            }
                        }
                    }
                }

                hdncurrenttab.Value = "6"; 
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(imgBtnAttPartG, "Error", ex.Message);
            }
        }

        protected void lstPartGAttach_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstPartGAttach, "SESSION_LIST_G_ATTACHMENTS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartGAttach, "Error", ex.Message);
            }
        }

        protected void lstPartGAttach_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                hdncurrenttab.Value = "6";
                ListViewDataItem li = lstPartGAttach.Items[e.ItemIndex];
                LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");
                string filename = @lnkatt.Text;

                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);
                string pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {
                    File.Delete(filepath);
                }
                else if (File.Exists(pfilepath))
                {
                    File.Delete(pfilepath);
                }

                string errorCode = string.Empty;
                ErrorMessageBC errbc = new ErrorMessageBC();
                HiddenField hdnfileid = (HiddenField)li.FindControl("hdnfileid");
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                ibc.update_incidents_attachfiles(hdnfileid.Value, userLogin.UserId, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    string errStr = string.Empty;
                    errbc.GetErrorMessage(errorCode, out errStr);
                }

                appHelper.DeleteListViewItem(lstPartGAttach, e.ItemIndex, "SESSION_LIST_G_ATTACHMENTS");
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartGAttach, "Error", ex.Message);
            }
        }

        protected void btnPartGReverttoPartF_Click(object sender, EventArgs e)
        {

            hdncurrenttab.Value = "6"; 
            string errtitle = string.Empty;
            string errStr = string.Empty;
            try
            {
                string errorCode = string.Empty;
                bool errorFlag = false;

                if (string.IsNullOrEmpty(txtPartG_Comment.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-134";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "6", txtPartG_Comment.ClientID);
                }

                if (string.IsNullOrEmpty(ddlPartG_HOD.SelectedValue.ToString()) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-133";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "6", ddlPartG_HOD.ClientID);
                }

                if (errorFlag.Equals(false))
                {
                    WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                    WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");

                    iBE.status = "05";
                    string action_role = "HOD";
                    setworkflow_data(iBE.incident_id, iBE.status, action_role, ddlPartG_HOD.SelectedValue.ToString(), txtPartG_Comment.Text);

                    save_workflow_to(iBE.incident_id, out errorCode);
                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "6", btnPartGReverttoPartF.ClientID);
                    }
                    else
                    {
                        save_attachfiles("SESSION_LIST_G_ATTACHMENTS", lstPartGAttach, out errorCode);
                        DataSet wfds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                        if (!string.IsNullOrEmpty(errorCode))
                        {
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "6", btnPartGReverttoPartF.ClientID);
                        }
                        else
                        {
                            SendEmailNotification(iBE, "06", "05", wfds.Tables[0], txtPartG_Comment.Text.Trim(), out errorCode);
                            if (string.IsNullOrEmpty(errorCode))
                            {
                                errtitle = "Incident Report";
                                errStr = "SUC-001";
                            }
                            else
                            {
                                errtitle = "Notification";
                                errStr = errorCode;
                            }
                            Session.Remove("SESSION_LIST_WORKFLOWS");
                            Session.Remove("SESSION_LIST_G_ATTACHMENTS");
                            baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errStr + ":" + ex.Message;
                baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
            }
        }

        protected void btnPartG_Click(object sender, EventArgs e)
        {

            hdncurrenttab.Value = "6"; 
            string errtitle = string.Empty;
            string errStr = string.Empty;
            try
            {
                string errorCode = string.Empty;
                bool errorFlag = false;

                if (string.IsNullOrEmpty(txtPartG_Comment.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-134";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "6", txtPartG_Comment.ClientID);
                }

                if (string.IsNullOrEmpty(ddlPartG_CWSHO.SelectedValue.ToString()) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-133";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "6", ddlPartG_CWSHO.ClientID);
                }

                if (errorFlag.Equals(false))
                {
                    WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                    WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");

                    iBE.status = "07";

                    string action_role = "CWSHO";
                    setworkflow_data(iBE.incident_id, iBE.status, action_role, ddlPartG_CWSHO.SelectedValue.ToString(), txtPartG_Comment.Text);

                    save_workflow_to(iBE.incident_id, out errorCode);
                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "6", btnPartG.ClientID);
                    }
                    else
                    {
                        save_attachfiles("SESSION_LIST_G_ATTACHMENTS", lstPartGAttach, out errorCode);
                        DataSet wfds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                        if (!string.IsNullOrEmpty(errorCode))
                        {
                            baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "6", btnPartG.ClientID);
                        }
                        else
                        {
                            SendEmailNotification(iBE, "06", "07", wfds.Tables[0], txtPartG_Comment.Text.Trim(), out errorCode);
                            if (string.IsNullOrEmpty(errorCode))
                            {
                                errtitle = "Incident Report";
                                errStr = "SUC-001";
                            }
                            else
                            {
                                errtitle = "Notification";
                                errStr = errorCode;
                            }
                            Session.Remove("SESSION_LIST_WORKFLOWS");
                            Session.Remove("SESSION_LIST_G_ATTACHMENTS");
                            baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errStr + ":" + ex.Message;
                baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
            }
        }

        protected void lv_partg_v_attach_ItemCreated(object sender, ListViewItemEventArgs e)
        {
            try
            {
                ImageButton btnDelete = (ImageButton)e.Item.FindControl("btnDelete");
                if (userLogin.UserRole == "9")
                {
                    btnDelete.Visible = true;
                }
                else
                {
                    btnDelete.Visible = false;
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lv_partg_v_attach, "Error", ex.Message);
            }
        }

        protected void lv_partg_v_attach_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            string errorCode = string.Empty;
            CommonFun appHelper = new CommonFun();
            ErrorMessageBC errbc = new ErrorMessageBC();

            try
            {
                hdncurrenttab.Value = "6";
                ListViewDataItem li = lv_partg_v_attach.Items[e.ItemIndex];
                LinkButton lnkatt = (LinkButton)li.FindControl("lnkAttach");

                string filename = @lnkatt.Text;
                string tempFolderPath = ConfigurationManager.AppSettings["Temp_Supporting_Documents"].ToString();
                string PFolderPath = ConfigurationManager.AppSettings["Supporting_Documents"].ToString();
                string filepath = Server.MapPath(tempFolderPath + filename);
                string pfilepath = Server.MapPath(PFolderPath + filename);

                if (File.Exists(filepath))
                {
                    File.Delete(filepath);
                }
                else if (File.Exists(pfilepath))
                {
                    File.Delete(pfilepath);
                }

                HiddenField hdnfileid = (HiddenField)li.FindControl("hdnfileid");
                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                ibc.update_incidents_attachfiles(hdnfileid.Value, userLogin.UserId, out errorCode);
                if (!string.IsNullOrEmpty(errorCode))
                {
                    string errStr = string.Empty;
                    errbc.GetErrorMessage(errorCode, out errStr);
                }
                else
                {
                    appHelper.DeleteListViewItem(lv_partg_v_attach, e.ItemIndex, "SESSION_LIST_G_ATTACHMENTS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lv_partg_v_attach, "Error", ex.Message);
            }
        }

        #endregion Part G

        #region PartH

        protected void btnAddPartH_CopyTo_Click(object sender, EventArgs e)
        {
            try
            {
                bool errorFlag = false;
                string errorCode = string.Empty;
                Dictionary<string, string> colItems = new Dictionary<string, string>()
                    {
                        {"empid", txtPartH_CopyToID.Text},
                        {"empname", txtPartH_CopyToName.Text},
                        {"empdesignation", txtPartH_CopyToDesignation.Text}
                     };

                if (string.IsNullOrEmpty(txtPartH_CopyToName.Text) && errorFlag.Equals(false))
                {
                    errorFlag = true;
                    errorCode = "ERR-014";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "7", txtPartH_CopyToName.ClientID);
                }

                if (string.IsNullOrEmpty(txtPartH_CopyToID.Text) && errorFlag.Equals(false))
                {
                    errorFlag = true;
                    errorCode = "ERR-017";
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "7", txtPartH_CopyToID.ClientID);
                }
                if (errorFlag.Equals(false))
                {
                    txtPartH_CopyToID.Text = string.Empty;
                    txtPartH_CopyToName.Text = string.Empty;
                    txtPartH_CopyToDesignation.Text = string.Empty;

                    appHelper.AddListViewItem(lstPartH_CopyTo, colItems, "SESSION_LIST_H_WORKFLOWS");
                }

                hdncurrenttab.Value = "7"; 
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartH_CopyTo, "Error", ex.Message);
            }
        }

        protected void lstPartH_CopyTo_Init(object sender, EventArgs e)
        {
            try
            {
                if (!IsPostBack)
                {
                    appHelper.GenerateBlankListview(lstPartH_CopyTo, "SESSION_LIST_H_WORKFLOWS");
                }
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartH_CopyTo, "Error", ex.Message);
            }
        }

        protected void lstPartH_CopyTo_ItemDeleting(object sender, ListViewDeleteEventArgs e)
        {
            try
            {
                hdncurrenttab.Value = "7";
                appHelper.DeleteListViewItem(lstPartH_CopyTo, e.ItemIndex, "SESSION_LIST_H_WORKFLOWS");
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(lstPartH_CopyTo, "Error", ex.Message);
            }
        }

        protected void btnPartHReverttoPartG_Click(object sender, EventArgs e)
        {

            hdncurrenttab.Value = "7"; 
            string errtitle = string.Empty;
            string errStr = string.Empty;
            try
            {
                string errorCode = string.Empty;
                bool errorFlag = false;

                if (string.IsNullOrEmpty(txtPartH_Comment.Text) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-137";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "7", txtPartH_Comment.ClientID);
                }

                if (string.IsNullOrEmpty(ddlPartH_WSHO.SelectedValue.ToString()) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-133";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "7", ddlPartH_WSHO.ClientID);
                }

                if (errorFlag.Equals(false))
                {
                    WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                    WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");

                    iBE.status = "06";
                    string action_role = "COPYTO";

                    foreach (ListItem li in chkPartEEmailTo.Items)
                    {
                        if (li.Selected)
                        {
                            string copyto_usrid = string.Empty;
                            copyto_usrid = li.Value;
                            setworkflow_data(iBE.incident_id, iBE.status, action_role, copyto_usrid, string.Empty);
                        }
                    }

                    foreach (ListViewDataItem lstViewItem in lstPartH_CopyTo.Items)
                    {
                        TextBox txtPartH_CopyToEmpNo = (TextBox)lstViewItem.FindControl("txtPartH_CopyToEmpNo");
                        if (txtPartH_CopyToEmpNo.Text.Trim() != string.Empty)
                        {
                            setworkflow_data(iBE.incident_id, iBE.status, action_role, txtPartH_CopyToEmpNo.Text.Trim(), string.Empty);
                        }
                    }

                    action_role = "WSHO";
                    setworkflow_data(iBE.incident_id, iBE.status, action_role, ddlPartH_WSHO.SelectedValue.ToString(), txtPartH_Comment.Text);

                    action_role = "A_WSHO";
                    setworkflow_data(iBE.incident_id, iBE.status, action_role, iBE.awsho_id, string.Empty);

                    save_workflow_to(iBE.incident_id, out errorCode);
                    DataSet wfds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "7", btnPartHReverttoPartG.ClientID);
                    }
                    else
                    {
                        SendEmailNotification(iBE, "07", "06", wfds.Tables[0], txtPartH_Comment.Text.Trim(), out errorCode);
                        if (string.IsNullOrEmpty(errorCode))
                        {
                            errtitle = "Incident Report";
                            errStr = "SUC-001";
                        }
                        else
                        {
                            errtitle = "Notification";
                            errStr = errorCode;
                        }
                        Session.Remove("SESSION_LIST_WORKFLOWS");
                        baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");

                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errStr + ":" + ex.Message;
                baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
            }
        }

        protected void btnPartH_Click(object sender, EventArgs e)
        {
            string errtitle = string.Empty;
            string errStr = string.Empty;
            try
            {
                string errorCode = string.Empty;
                bool errorFlag = false;

                WorkflowIncidentBC ibc = new WorkflowIncidentBC();
                WorkflowIncidentBE iBE = (WorkflowIncidentBE)AppSession.GetSession("SESSION_OBJ_INCIDENT");

                if (string.IsNullOrEmpty(txtPartH_Comment.Text.Trim()) && errorFlag.Equals(false))
                {
                    errorCode = "ERR-137";
                    errorFlag = true;
                    baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "7", txtPartH_Comment.ClientID);
                }

                if (errorFlag.Equals(false))
                {

                    iBE.status = "08";
                    string action_role = "COPYTO";

                    foreach (ListItem li in chkPartHEmailTo.Items)
                    {
                        if (li.Selected)
                        {
                            string copyto_usrid = string.Empty;
                            copyto_usrid = li.Value;
                            setworkflow_data(iBE.incident_id, iBE.status, action_role, copyto_usrid, string.Empty);
                        }
                    }

                    foreach (ListViewDataItem lstViewItem in lstPartH_CopyTo.Items)
                    {
                        TextBox txtPartH_CopyToEmpNo = (TextBox)lstViewItem.FindControl("txtPartH_CopyToEmpNo");
                        if (txtPartH_CopyToEmpNo.Text.Trim() != string.Empty)
                        {
                            setworkflow_data(iBE.incident_id, iBE.status, action_role, txtPartH_CopyToEmpNo.Text.Trim(), string.Empty);
                        }
                    }

                    action_role = "CLOSE";
                    setworkflow_data(iBE.incident_id, iBE.status, action_role, iBE.created_by, txtPartH_Comment.Text);

                    save_workflow_to(iBE.incident_id, out errorCode);
                    DataSet wfds = (DataSet)AppSession.GetSession("SESSION_LIST_WORKFLOWS");

                    if (!string.IsNullOrEmpty(errorCode))
                    {
                        baseHelper.popUpMessageSetfocus(Page, "Error", errorCode, "7", btnPartH.ClientID);
                    }
                    else
                    {
                        SendEmailNotification(iBE, "07", "08", wfds.Tables[0], txtPartH_Comment.Text.Trim(), out errorCode);
                        if (string.IsNullOrEmpty(errorCode))
                        {
                            errtitle = "Incident Report";
                            errStr = "SUC-001";
                        }
                        else
                        {
                            errtitle = "Notification";
                            errStr = errorCode;
                        }
                        Session.Remove("SESSION_LIST_WORKFLOWS");
                        baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");

                    }
                }
            }
            catch (Exception ex)
            {
                errtitle = "Notification";
                errStr = errStr + ":" + ex.Message;
                baseHelper.PopUpMessageRedirect(Page, errtitle, errStr, "Home.aspx");
            }
        }

        private void InitPartH(string incidentid)
        {
            DataSet ids = new DataSet();
            WorkflowIncidentBC ibc = new WorkflowIncidentBC();

            WorkflowIncidentBE iBE = new WorkflowIncidentBE
            {
                incident_id = incidentid
            };
            ids = ibc.get_incident_by_id(iBE);
            if (iBE.status == "07")
            {
                pnl_PartH.Visible = true;
                pnl_V_PartH.Visible = false;
            }

            txtPartH_Comment.Text = string.Empty;
            DataSet uds = new DataSet();
            DataSet wshods = new DataSet();
            DataSet copytods = new DataSet();

            string sba_code, sbu_code, department_code, location_code;
            sba_code = iBE.sba_code;
            sbu_code = iBE.sbu_code;
            department_code = iBE.department;
            location_code = iBE.location;

            UserBC uBC = new UserBC();
            uds = uBC.GetEmployeeInfoByEmployeeNo(userLogin.UserId);
            wshods = uBC.get_wsho_by_sbu(sba_code, sbu_code, department_code, location_code);
            copytods = uBC.get_active_cclist_by_sbu(sba_code, sbu_code, department_code, location_code);

            lblPartH_SubmittedName.Text = uds.Tables[0].Rows[0]["empname"].ToString();
            lblPartH_SubmittedNo.Text = userLogin.UserId;
            lblPartH_SubmittedDate.Text = DateTime.Now.ToString("dd-MMM-yyyy");
            lblPartH_SubmittedDesgnation.Text = uds.Tables[0].Rows[0]["empdesignation"].ToString();

            appHelper.BindCodeToListControl(ddlPartH_WSHO, wshods, "empname", "empid", string.Empty);
            ddlPartH_WSHO.SelectedValue = iBE.wsho_id;

            appHelper.BindCheckBoxList(chkPartHEmailTo, copytods, "empname", "empid");
            foreach (ListItem li in chkPartHEmailTo.Items)
            {
                li.Selected = true;
            }
        }

        private void BindPartH(WorkflowIncidentBE incidentBE)
        {
            WorkflowIncidentBC iBC = new WorkflowIncidentBC();
            DataSet wfds = iBC.get_wirs_incidents_workflows_by_id(incidentBE.incident_id, "08");

            int istatus = Convert.ToInt16(incidentBE.status);
            if (istatus > 7)
            {
                pnl_PartH.Visible = false;
                lblVPartHReviewandComment.Text = string.Empty;

                lblVPartHName.Text = string.Empty;
                lblVPartHID.Text = string.Empty;
                lblVPartHSubmittionDate.Text = string.Empty;
                lblVPartHDesignation.Text = string.Empty;

                if (wfds.Tables[0].Rows.Count > 0)
                {
                    pnl_V_PartH.Visible = true;
                    workflowdataBind(wfds.Tables[0], gv_parth_workflow, lblVPartHName, lblVPartHID, lblVPartHSubmittionDate, lblVPartHDesignation);
                    lblVPartHReviewandComment.Text = wfds.Tables[1].Rows[0]["remarks"].ToString();

                }
            }
            else
            {
                pnl_PartH.Visible = true;
                pnl_V_PartH.Visible = false;
            }
        }

        #endregion PartH

        protected void ddlIncidentType_SelectedIndexChanged(object sender, EventArgs e)
        {
            try
            {
                bool isOther = false;

                if (ddlIncidentType.SelectedValue == "9")
                {
                    isOther = true;

                    pnl_PartA_1.Visible = false;
                    pnl_PartA_3.Visible = false;
                    pnl_PartC_1.Visible = false;
                }
                else if (ddlIncidentType.SelectedValue == "1")
                {

                    pnl_PartA_1.Visible = true;
                    pnl_PartC_1.Visible = false;
                }
                else
                {

                    pnl_PartA_1.Visible = false;
                    pnl_PartC_1.Visible = false;
                }

                if (isOther == true)
                {
                    txtIncidentOth.Enabled = true;
                    lblManInciOth.Visible = true;
                }
                else
                {
                    txtIncidentOth.Text = "";
                    txtIncidentOth.Enabled = false;
                    lblManInciOth.Visible = false;
                }

                rdoHasEyeWitness_SelectedIndexChanged(sender, e);
                ViewState["incident_arr"] = incident_arr;
            }
            catch (Exception ex)
            {
                baseHelper.PopUpMessage(chkIncidentType, "Error", ex.Message);
            }
        }

        protected void rdoHasEyeWitness_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (rdoHasEyeWitness.SelectedValue == "1")
            {
                pnl_PartC_1.Visible = true;
            }
            else
            {
                pnl_PartC_1.Visible = false;
            }
        }

        #region Private Methods

        private void HiddenIncidentControls(string incidentType)
        {
            bool isCtrlHidden = true;

            if (!incidentType.Equals("1"))
            {
                isCtrlHidden = false;
            }

            pnl_PartC_3.Visible = isCtrlHidden;
            pnl_PartC_4.Visible = isCtrlHidden;
            pnl_PartC_5.Visible = isCtrlHidden;

            pnl_PartA_1_Text.Visible = isCtrlHidden;
            pnl_PartA_2_Text.Visible = isCtrlHidden;
        }

        #endregion Private Methods
    }
}